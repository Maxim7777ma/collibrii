{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ table.name }} - Список строк</title>
    <link rel="stylesheet" href="{% static 'css/tablelist.css' %}">
</head>
<body>
    <h1>Список строк таблиці: {{ table.name }}</h1>

    <!-- Фильтр -->
    <button class="filter-toggle-btn" id="toggle-filters">Показати фільтри</button>
    <div id="filter-container" class="filter-container">
        <h3>Фільтр</h3>
        <form id="filter-form" method="POST">
            {% csrf_token %}
    
            <!-- Оставшиеся текстовые и выпадающие фильтры -->
            {% for field in visible_fields %}
                {% if field.name not in "last_updated inquiry_date due_date record_date" %}
                    <div class="filter-group">
                        <label for="filter-{{ field.name }}">{{ field.label }}</label>
                        {% if field.name in allowed_fields %}
                            <select id="filter-{{ field.name }}" name="{{ field.name }}" class="filter-dropdown">
                                <option value="">Всі</option>
                                {% for value in choices|get_item:field.name %}
                                    <option value="{{ value }}">{{ value }}</option>
                                {% endfor %}
                            </select>
                        {% else %}
                            <input type="text" id="filter-{{ field.name }}" name="{{ field.name }}" placeholder="Введіть значення">
                        {% endif %}
                    </div>
                {% endif %}
                <!-- Поле "Дата початку" -->
            {% endfor %}
            <div class="filter-group">
                <label for="filter-start_datetime">Дата початку</label>
                <input type="datetime-local" id="filter-start_datetime" name="start_datetime">
            </div>
    
            <!-- Поле "Дата кінця" -->
            <div class="filter-group">
                <label for="filter-end_datetime">Дата кінця</label>
                <input type="datetime-local" id="filter-end_datetime" name="end_datetime">
            </div>
            <div class="filter-buttons">
                <button class="filter-start" type="submit">Застосувати фільтр</button>
                <button class="filter-stop" type="button" id="reset-filters">Скинути фільтри</button>
            </div>
        </form>
    </div>


    <!-- Кнопки навигации -->
    <div class="actions">
        <a href="{% url 'add_row' table.id %}" class="btn-add">Додати рядок</a>
        <a href="{% url 'custom_table_list' %}" class="btn-back">Назад до таблиць</a>
    </div>

    <!-- Таблица строк -->
    <table id="data-table" data-table-id="{{ table.id }}">
        <thead>
            <tr>
                <th>ID</th>
                {% for field in visible_fields %}
                    <th>{{ field.label }}</th> <!-- Используем переводы из FIELD_TRANSLATIONS -->
                {% endfor %}
                <th>Дії</th>
            </tr>
        </thead>
        <tbody id="table-body">
            {% for row in rows %}
            <tr data-row-id="{{ row.id }}">
                <td>{{ row.id }}</td>
                {% for field in visible_fields %}
                    <td class="
                        {% if field.name == 'phone_number' and row.additional_data|get_item:'phone_number' in duplicate_phones %}duplicate{% endif %}
                        {% if field.name == 'instagram_username' and row.additional_data|get_item:'instagram_username' in duplicate_usernames %}duplicate{% endif %}
                    ">
                        {% if field.name == 'contact' %}
                            <select class="editable-select contact-select" data-row-id="{{ row.id }}">
                                <option value="contact_1" {% if row.contact == 'contact_1' %}selected{% endif %}>Контакт 1</option>
                                <option value="contact_2" {% if row.contact == 'contact_2' %}selected{% endif %}>Контакт 2</option>
                                <option value="contact_3" {% if row.contact == 'contact_3' %}selected{% endif %}>Контакт 3</option>
                                <option value="contact_4" {% if row.contact == 'contact_4' %}selected{% endif %}>Контакт 4</option>
                            </select>
                        {% elif field.name == 'status' %}
                            <select class="editable-select status-select" data-row-id="{{ row.id }}">
                                <option value="lead" {% if row.status == 'lead' %}selected{% endif %}>Лід</option>
                                <option value="client" {% if row.status == 'client' %}selected{% endif %}>Клієнт</option>
                                <option value="customer" {% if row.status == 'customer' %}selected{% endif %}>Замовник</option>
                            </select>
                        {% elif field.name == 'priority' %}
                            <select class="editable-select priority-select" data-row-id="{{ row.id }}">
                                <option value="low" {% if row.priority == 'low' %}selected{% endif %}>Низький</option>
                                <option value="medium" {% if row.priority == 'medium' %}selected{% endif %}>Середній</option>
                                <option value="high" {% if row.priority == 'high' %}selected{% endif %}>Високий</option>
                            </select>
                        {% elif field.name == 'change_status_contact' %}
                            <select class="editable-select change-status-contact-select" data-row-id="{{ row.id }}">
                                <option value="contact_1" {% if row.change_status_contact == 'contact_1' %}selected{% endif %}>Контакт 1</option>
                                <option value="contact_2" {% if row.change_status_contact == 'contact_2' %}selected{% endif %}>Контакт 2</option>
                                <option value="contact_3" {% if row.change_status_contact == 'contact_3' %}selected{% endif %}>Контакт 3</option>
                                <option value="contact_4" {% if row.change_status_contact == 'contact_4' %}selected{% endif %}>Контакт 4</option>
                            </select>
                            
                        {% elif field.name == 'deal_amount' %}
                            {{ row.deal_amount }} {{ row.deal_amount_currency }}
                        {% elif field.name == 'paid_amount' %}
                            {{ row.paid_amount }} {{ row.paid_amount_currency }}
                        {% elif field.name == 'expected_profit' %}
                            {{ row.expected_profit }} {{ row.expected_profit_currency }}
                        {% elif field.name == 'instagram_username' %}
                            {% with username=row.additional_data|get_item:'instagram_username' link=row.additional_data|get_item:'instagram_link' %}
                                {% if username and link %}
                                    <a href="{{ link }}" target="_blank">{{ username }}</a>
                                {% else %}
                                    {{ username|default:"-" }}
                                {% endif %}
                            {% endwith %}

                        {% elif field.name == 'updated_by' %}
                            {{ row.updated_by_names|default:"-" }}  <!-- ✅ Просто выводим никнеймы -->
                            

                        {% elif field.name == 'phone_number' %}
                            {% with phone=row.additional_data|get_item:'phone_number' %}
                                {% if phone %}
                                    <a href="tel:{{ phone }}">{{ phone }}</a>
                                {% else %}
                                    {{ phone|default:"-" }}
                                {% endif %}
                            {% endwith %}

                        {% else %}
                            {{ row.additional_data|get_item:field.name|default:"-" }}
                        {% endif %}
                    </td>
                {% endfor %}
                <td>
                    <a href="{% url 'edit_row' table.id row.id %}" class="btn-edit">Редагувати</a>
                    <button class="btn-delete" data-row-id="{{ row.id }}">Видалити</button>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="{{ visible_fields|length|add:'1' }}">Дані відсутні</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- JavaScript -->
    <script>
        // Получение CSRF-токена
        function getCSRFToken() {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith('csrftoken=')) {
                    return cookie.substring('csrftoken='.length);
                }
            }
            return '';
        }

        // Обновление контакта
        document.querySelectorAll('.contact-select').forEach(select => {
            select.addEventListener('change', function () {
                const rowId = this.dataset.rowId;
                const contactValue = this.value;

                fetch(`/clients/tables/update-contact/${rowId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({ contact: contactValue })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Контакт обновлен!');
                        if (data.auto_status_change) {
                            document.querySelector(`.status-select[data-row-id="${rowId}"]`).value = 'client';
                        }
                    } else {
                        alert('Ошибка обновления контакта.');
                    }
                })
                .catch(error => console.error('Ошибка сети:', error));
            });
        });

        // Обновление статуса
        document.querySelectorAll('.status-select').forEach(select => {
            select.addEventListener('change', function () {
                const rowId = this.dataset.rowId;
                const statusValue = this.value;

                fetch(`/clients/tables/update-status/${rowId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({ status: statusValue })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Статус обновлен!');
                    } else {
                        alert('Ошибка обновления статуса.');
                    }
                })
                .catch(error => console.error('Ошибка сети:', error));
            });
        });

        // Удаление строки
        document.querySelectorAll('.btn-delete').forEach(button => {
            button.addEventListener('click', function () {
                const rowId = this.dataset.rowId;
                if (confirm(`Вы уверены, что хотите удалить строку с ID ${rowId}?`)) {
                    fetch(`/clients/tables/{{ table.id }}/delete-row/${rowId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCSRFToken()
                        }
                    })
                    .then(response => {
                        if (response.ok) {
                            document.querySelector(`tr[data-row-id="${rowId}"]`).remove();
                        } else {
                            alert('Ошибка удаления строки.');
                        }
                    })
                    .catch(error => console.error('Ошибка сети:', error));
                }
            });
        });
    </script>
    <script>
        // Получение CSRF-токена
        function getCSRFToken() {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith('csrftoken=')) {
                    return cookie.substring('csrftoken='.length);
                }
            }
            return '';
        }
    
        // Функция обновления полей (универсальная)
        function updateField(rowId, fieldName, value) {
            fetch(`/clients/tables/update-field/${rowId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({ field: fieldName, value: value })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`${data.message}`);
    
                    // ✅ Если контакт == статусу контакта, статус меняем на client
                    if (data.auto_status_change) {
                        document.querySelector(`.status-select[data-row-id="${rowId}"]`).value = 'client';
                    }
                } else {
                    alert('Ошибка обновления.');
                }
            })
            .catch(error => console.error('Ошибка сети:', error));
        }
    
        // Вешаем обработчик на все выпадающие списки
        document.querySelectorAll('.editable-select').forEach(select => {
            select.addEventListener('change', function () {
                const rowId = this.dataset.rowId;
                const fieldName = this.classList.contains('contact-select') ? 'contact'
                    : this.classList.contains('status-select') ? 'status'
                    : this.classList.contains('priority-select') ? 'priority'
                    : this.classList.contains('change-status-contact-select') ? 'change_status_contact'
                    : null;
    
                if (fieldName) {
                    updateField(rowId, fieldName, this.value);
                }
            });
        });
    </script>
     <!-- JavaScript -->
     <script>
        document.getElementById("toggle-filters").addEventListener("click", function () {
            let filterContainer = document.getElementById("filter-container");
            if (filterContainer.classList.contains("show-filters")) {
                filterContainer.classList.remove("show-filters");
                this.textContent = "Показати фільтри"; // Меняем текст кнопки
            } else {
                filterContainer.classList.add("show-filters");
                this.textContent = "Сховати фільтри"; // Меняем текст кнопки
            }
        });
        
        document.getElementById("filter-form").addEventListener("submit", function (e) {
            e.preventDefault();
            fetchFilteredData();
        });
        
        document.getElementById("reset-filters").addEventListener("click", function () {
            resetFilter();
        });
        
        function fetchFilteredData() {
            let tableElement = document.getElementById("data-table");
            if (!tableElement) {
                console.error("Ошибка: элемент #data-table не найден!");
                return;
            }
        
            let tablePk = tableElement.getAttribute("data-table-id");
            let formData = {};
        
            document.querySelectorAll("#filter-form input, #filter-form select").forEach(input => {
                if (input.value && input.name !== "csrfmiddlewaretoken") {  // ✅ Исключаем CSRF-токен
                    formData[input.name] = input.value;
                }
            });
        
            console.log("Отправляем JSON:", JSON.stringify(formData));
        
            fetch(`/clients/tables/filter-rows/${tablePk}/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken()  // ✅ CSRF-токен передаем только в заголовке!
                },
                body: JSON.stringify(formData),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    applyFilter(data.data);
                } else {
                    console.error("Ошибка:", data.error);
                }
            })
            .catch(error => console.error("Ошибка сети:", error));
        }
        
        
        function applyFilter(rows) {
            let allRows = document.querySelectorAll("tbody tr");
            let visibleIds = rows.map(row => String(row.pk));  // Приводим к строке
        
            allRows.forEach(tr => {
                let rowId = tr.getAttribute("data-row-id");
                if (rowId) {
                    if (visibleIds.includes(rowId)) {
                        tr.classList.remove("hidden-row"); // Показываем строку
                    } else {
                        tr.classList.add("hidden-row"); // Скрываем строку
                    }
                }
            });
        }
        
        function resetFilter() {
            let allRows = document.querySelectorAll("tbody tr");
            allRows.forEach(tr => tr.classList.remove("hidden-row")); // Показываем все строки обратно
            document.querySelectorAll("#filter-form input, #filter-form select").forEach(input => input.value = "");
            
            fetchFilteredData(); // 🚀 Запускаем обновление
        }
        
    </script>
    
    <style>
        .hidden-row {
            display: none !important;
        }
    </style>
</body>
</html>