<!-- filepath: /Users/pk/Desktop/crm_colibri/crm_colibrii/clients/templates/clients/custom_row_list.html -->
{% load static %}
<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ table.name }} - Строки</title>
    <link rel="stylesheet" href="{% static 'css/tablelist1.css' %}">
</head>
<body id="custom-page">
    <h1>Таблиця: {{ table.name }}</h1>
     <!-- Форма фильтрации -->
    <form method="POST" class="filter-form" action="{% url 'custom_row_filter' pk=table.id %}">
        {% csrf_token %}
        <div class="filter-group">
            <label for="name">Им'я:</label>
            <input type="text" id="name" name="name" value="{{ filters.name }}">
        </div>

        <div class="filter-group">
            <label for="priority">Пріоритет:</label>
            <select id="priority" name="priority">
                <option value="">Всі</option>
                <option value="high" {% if filters.priority == 'high' %}selected{% endif %}>Високий</option>
                <option value="medium" {% if filters.priority == 'medium' %}selected{% endif %}>Середній</option>
                <option value="low" {% if filters.priority == 'low' %}selected{% endif %}>Низький</option>
            </select>
        </div>
    
        <div class="filter-group">
            <label for="country">Країна:</label>
            <input type="text" id="country" name="country" value="{{ filters.country }}">
        </div>
    
        <div class="filter-group">
            <label for="city">Місто:</label>
            <input type="text" id="city" name="city" value="{{ filters.city }}">
        </div>
    
        <div class="filter-group">
            <label for="phone_number">Номер телефону:</label>
            <input type="text" id="phone_number" name="phone_number" value="{{ filters.phone_number }}">
        </div>
        <div class="filter-group">
            <label for="email">Email:</label>
            <input type="email" id="email" name="email" value="{{ filters.email }}">
        </div>
    
        <div class="filter-group">
            <label for="instagram_username">Нікнейм Instagram:</label>
            <input type="text" id="instagram_username" name="instagram_username" value="{{ filters.instagram_username }}">
        </div>

        <div class="filter-group">
            <label for="status">Тип клієнта:</label>
            <select id="status" name="status">
                <option value="">Все</option>
                <option value="lead" {% if filters.status == 'lead' %}selected{% endif %}>Лид</option>
                <option value="client" {% if filters.status == 'client' %}selected{% endif %}>Клиент</option>
                <option value="customer" {% if filters.status == 'customer' %}selected{% endif %}>Заказчик</option>
            </select>
        </div>

        <div class="filter-group">
            <label for="manager">Менеджер:</label>
            <input type="text" id="manager" name="manager" value="{{ filters.manager }}">
        </div>

        <div class="filter-group">
            <label for="contact">Статус:</label>
            <select id="contact" name="contact">
                <option value="">Все</option>
                <option value="contact_1" {% if filters.contact == 'contact_1' %}selected{% endif %}>Контакт 1</option>
                <option value="contact_2" {% if filters.contact == 'contact_2' %}selected{% endif %}>Контакт 2</option>
                <option value="contact_3" {% if filters.contact == 'contact_3' %}selected{% endif %}>Контакт 3</option>
                <option value="contact_4" {% if filters.contact == 'contact_4' %}selected{% endif %}>Контакт 4</option>
            </select>
        </div>

        <div class="filter-group">
            <label for="min_deal_amount">Мінімальна сума угода:</label>
            <input type="number" id="min_deal_amount" name="min_deal_amount" step="0.10" value="{{ filters.min_deal_amount }}">
        </div>

        <div class="filter-group">
            <label for="max_deal_amount">Максимальная сума угода:</label>
            <input type="number" id="max_deal_amount" name="max_deal_amount" step="0.10" value="{{ filters.max_deal_amount }}">
        </div>

        <div class="filter-group">
            <label for="start_date">Дата запису (від):</label>
            <input type="date" id="start_date" name="start_date" value="{{ filters.start_date }}">
        </div>

        <div class="filter-group">
            <label for="end_date">Дата запису (до):</label>
            <input type="date" id="end_date" name="end_date" value="{{ filters.end_date }}">
        </div>

        <button type="submit" class="btn-filter">Застусувати фільтр</button>
        <a class="btn-reset" href="{% url 'reset_row_filter' pk=table.id %}">Скинути</a>
    </form>
<form method="POST" class="table-form" id="data-form">
    {% csrf_token %}
    <h1>Таблиця: {{ table.name }}</h1>
    
    <!-- Кнопки навігації -->
    <a href="{% url 'add_row' table.id %}" class="btn-add">Додати рядок</a>
    <a href="{% url 'custom_table_list' %}" class="btn-cancel">Назад</a>
    <a href="{% url 'main_dashboard' %}" class="btn-main">Главная</a>

    <!-- Таблиця рядків -->
    <table>
        <thead>
            <tr>
                <th>#</th>
                <th>Ім'я</th>
                <th>instagram_username</th>
                <th>Instagram</th>
                <th>Телефон</th>
                <th>Email</th>
                <th>Менеджер</th>
                <th>Тип</th>
                <th>Статус</th>
                <th>Сума угоди</th>
                <th>Оплачена сума</th>
                <th>Очікуваний прибуток</th>
                <th>Дата створення</th>
                <th>Дата запису</th>
                <th>Дата виконання</th>
                <th>Дата звернення</th>
                <th>Країна</th>
                <th>Місто</th>
                <th>Пріоритет</th>
                <th>Остання зміна</th>
                <th>Користувач</th>
                <th>Дії</th>
            </tr>
        </thead>
        <tbody>

    

            {% for row in rows %}
            <tr data-pk="{{ row.id }}" data-change-status-contact="{{ row.change_status_contact }}">
                <td>{{ forloop.counter }}</td>
                <td>{{ row.name }}</td>
                <td>
                    {% if row.instagram_username %}
                    <a href="{{ row.instagram_link|default:'#' }}" target="_blank" class="{% if row.instagram_username in duplicate_usernames %}duplicate{% endif %}">
                        {{ row.instagram_username }}
                    </a>
                    {% else %}
                        Немає даних
                    {% endif %}
                </td>
                <td>
                    <a href="{{ row.instagram_link }}" target="_blank">
                        {{ row.instagram_link }}
                    </a>
                </td>
                <td class="{% if row.phone_number in duplicate_phones %}duplicate{% endif %}">{{ row.phone_number }}</td>
                <td>{{ row.email }}</td>
                <td>{{ row.manager }}</td>
                <!-- Статус -->
                <td>
                    <select id="status_{{ row.id }}" onchange="updateStatus1(this)">
                        <option value="lead" {% if row.status == 'lead' %}selected{% endif %}>Лід</option>
                        <option value="client" {% if row.status == 'client' %}selected{% endif %}>Клієнт</option>
                        <option value="customer" {% if row.status == 'customer' %}selected{% endif %}>Замовник</option>
                    </select>
                </td>
    
                <!-- Контакт -->
                <td>
                    <select id="id_contact_{{ row.id }}" onchange="updateContact1(this)">
                        <option value="contact_1" {% if row.contact == 'contact_1' %}selected{% endif %}>Контакт 1</option>
                        <option value="contact_2" {% if row.contact == 'contact_2' %}selected{% endif %}>Контакт 2</option>
                        <option value="contact_3" {% if row.contact == 'contact_3' %}selected{% endif %}>Контакт 3</option>
                        <option value="contact_4" {% if row.contact == 'contact_4' %}selected{% endif %}>Контакт 4</option>
                    </select>
                </td>
    
                <!-- Суми та валюти -->
                <td>{{ row.deal_amount }} {{ row.deal_amount_currency }}</td>
                <td>{{ row.paid_amount }} {{ row.paid_amount_currency }}</td>
                <td>{{ row.expected_profit }} {{ row.expected_profit_currency }}</td>
    
                <!-- Даты -->
                <td>{{ row.record_date|date:"d F Y" }}</td>
                <td>{{ row.record_date|date:"d F Y" }}</td>
                <td>{{ row.due_date|date:"d F Y" }}</td>
                <td>{{ row.inquiry_date|date:"d F Y" }}</td>
                <td>{{row.country}}</td>
                <td>{{row.city}}</td>
                <td id="priority_cell_{{ row.id }}" class="
                    {% if row.priority == 'low' %}priority-low{% endif %}
                    {% if row.priority == 'medium' %}priority-medium{% endif %}
                    {% if row.priority == 'high' %}priority-high{% endif %}">
                    <select id="id_priority_{{ row.id }}" onchange="updatePriority(this)">
                        <option value="low" {% if row.priority == 'low' %}selected{% endif %}>Низький</option>
                        <option value="medium" {% if row.priority == 'medium' %}selected{% endif %}>Середній</option>
                        <option value="high" {% if row.priority == 'high' %}selected{% endif %}>Високий</option>
                    </select>
                </td>

                <td>{{ row.last_updated|date:"d M Y H:i" }}</td>
                <td>
                    {% if row.updated_by %}
                        {{ row.updated_by.username }}
                    {% else %}
                        Невідомо
                    {% endif %}
                </td>
            
                <td>
                    <a href="{% url 'edit_row' table.id row.id %}" class="btn-edit">Редагувати</a>
                    <button class="btn-delete" 
                        onclick="confirmDelete(this)" 
                        data-table-id="{{ table.id }}" 
                        data-row-id="{{ row.id }}" 
                        data-row-number="{{ forloop.counter }}">
                        Видалити
                    </button>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="15">Немає даних</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Модальне вікно -->
    <div id="deleteModal" class="modal" style="display: none;">
        <div class="modal-content">
            <p id="deleteText"></p>
            <form id="deleteForm" method="POST">
                {% csrf_token %}
                <button type="submit" class="btn-delete">Видалити</button>
                <button type="button" class="btn-cancel" onclick="closeModal()">Скасувати</button>
            </form>
        </div>
    </div>
</form>
    <!-- JavaScript для модального вікна та оновлення даних -->
    <script>
        function confirmDelete(button) {
            const tableId = button.getAttribute('data-table-id');
            const rowId = button.getAttribute('data-row-id');
            const rowNumber = button.getAttribute('data-row-number');
        
            document.getElementById('deleteText').innerText = `Ви впевнені, що хочете видалити рядок №${rowNumber}?`;
            document.getElementById('deleteForm').action = `/clients/tables/${tableId}/delete/${rowId}/`;
            document.getElementById('deleteModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('deleteModal').style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('deleteModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        };

    </script>    
    
    <!-- Скрипт для автоматичної зміни статусу -->
 
    <script>
    let debounceTimer;
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }


        function updatePriority(selectElement) {
            const row = selectElement.closest('tr'); // Получаем строку
            const td = selectElement.closest('td'); // Находим <td>, содержащую <select>
            const pk = row.dataset.pk; // Получаем pk строки
            const priorityValue = selectElement.value; // Получаем выбранное значение
        
            // Устанавливаем класс для td в зависимости от значения
            td.classList.remove('priority-low', 'priority-medium', 'priority-high');
            if (priorityValue === 'low') {
                td.classList.add('priority-low');
            } else if (priorityValue === 'medium') {
                td.classList.add('priority-medium');
            } else if (priorityValue === 'high') {
                td.classList.add('priority-high');
            }
        
            // Отправляем обновления на сервер
            const url = `/clients/tables/update-priority/${pk}/`;
            const data = { priority: priorityValue };
        
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'), // Убедись, что функция getCookie определена
                },
                body: JSON.stringify(data),
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        alert('Пріоритет успішно оновлено!');
                    } else {
                        alert('Помилка при оновленні пріоритету.');
                    }
                })
                .catch((error) => {
                    console.error('Помилка мережі:', error);
                    alert('Помилка мережі.');
                });
        }

        function updateContact1(selectElement) {
            const row = selectElement.closest('tr'); // Находим строку, содержащую select
            const pk = row.dataset.pk; // Получаем pk строки
            const contactValue = selectElement.value; // Получаем выбранное значение
        
            const url = `/clients/tables/update-contact1/${pk}/`; // Формируем URL
            const data = { contact: contactValue };
        
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'), // Убедитесь, что функция getCookie определена
                },
                body: JSON.stringify(data)
            }).then(response => response.json())
              .then(data => {
                  if (data.success) {
                      alert('Контакт оновлено!');
                      updateStatusAutomatically(pk, contactValue);
                      location.reload(); // Обновляем страницу
                  } else if (data.warning) {
                      alert(data.warning);
                  } else {
                      alert('Помилка при оновленні контакту!');
                  }
              }).catch(error => {
                  alert('Ошибка сети: ' + error.message);
              });
        }

        function updateStatus1(selectElement) {
            const row = selectElement.closest('tr'); // Находим строку, содержащую select
            const pk = row.dataset.pk; // Получаем pk строки
            const statusValue = selectElement.value; // Получаем выбранное значение
        
            const url = `/clients/tables/update-status1/${pk}/`; // Формируем URL
            const data = { status: statusValue };
        
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'), // Убедитесь, что функция getCookie определена
                },
                body: JSON.stringify(data)
            }).then(response => response.json())
              .then(data => {
                  if (data.success) {
                      alert('Статус оновлено!');
                      location.reload(); // Обновляем страницу
                  } else {
                      alert('Помилка при оновленні статусу!');
                  }
              }).catch(error => {
                  alert('Ошибка сети: ' + error.message);
              });
        }

        function updateStatusAutomatically(pk, contactValue) {
            const row = document.querySelector(`[data-pk="${pk}"]`);
            const selectedContact = row.dataset.changeStatusContact; // Контакт, при котором статус меняется на "Клиент"
            const statusElement = row.querySelector(`select[id^="status_"]`);
        
            // Проверяем, что contactValue и selectedContact совпадают
            if (contactValue === selectedContact && statusElement.value === 'lead') {
                statusElement.value = 'client'; // Изменяем статус на "Клиент"
        
                // Отправляем обновленный статус на сервер
                const url = `/clients/tables/update-status1/${pk}/`;
                const data = { status: statusElement.value };
        
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: JSON.stringify(data)
                }).then(response => response.json())
                  .then(data => {
                      if (data.success) {
                          alert('Статус оновлено автоматично!');
                          location.reload(); // Обновляем страницу
                      } else {
                          alert('Помилка при автоматичному оновленні статусу!');
                      }
                  }).catch(error => {
                      alert('Ошибка сети: ' + error.message);
                  });
            }
        }
        // Функция для отправки фильтров на сервер
        function applyFilters() {
            const form = document.querySelector('.filter-form');
            if (!form) return;
        
            const formData = new FormData(form);
            const params = new URLSearchParams(formData);
        
            fetch(form.action, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest', // Указываем, что это AJAX-запрос
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: params.toString(),
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP Error: ${response.status}`);
                    }
                    return response.json(); // Ожидаем JSON
                })
                .then(data => {
                    updateTable(data.rows); // Обновляем таблицу
                })
                .catch(error => console.error('Ошибка фильтрации:', error));
        }
        

    // Функция для обновления таблицы на странице
    function updateTable(rows) {
        const tableBody = document.querySelector('tbody');
        tableBody.innerHTML = ''; // Очищаем старые строки

        if (rows.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="9">Нет данных</td></tr>';
            return;
        }

        rows.forEach((row, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${index + 1}</td>
                <td>${row.name}</td>
                <td><a href="${row.instagram_link}" target="_blank">${row.instagram_link || '—'}</a></td>
                <td>${row.phone_number || '—'}</td>
                <td>${row.manager || '—'}</td>
                <td>${row.status || '—'}</td>
                <td>${row.contact || '—'}</td>
                <td>${row.deal_amount || '—'}</td>
                <td>${row.record_date || '—'}</td>
            `;
            tableBody.appendChild(tr);
        });
    }

    // Дебаунсинг для предотвращения лишних запросов
    
    function debounce(callback, delay = 500) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(callback, delay);
    }

    // Событие для изменения фильтров
    document.querySelectorAll('.filter-form input, .filter-form select').forEach(input => {
        input.addEventListener('input', () => debounce(applyFilters, 500));
    });

   
    document.addEventListener('DOMContentLoaded', function () {
        const filterForm = document.querySelector('.filter-form'); // Форма фильтрации
        const resetButton = document.querySelector('.btn-reset'); // Кнопка сброса
    
        if (filterForm && resetButton) {
            resetButton.addEventListener('click', function () {
                // Сбрасываем все поля формы
                filterForm.reset();
    
                // Устанавливаем значения пустыми
                const formData = new FormData(filterForm);
                for (const key of formData.keys()) {
                    formData.set(key, '');
                }
    
                // Отправляем запрос на сервер
                fetch(filterForm.action, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(formData).toString(),
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP Error: ${response.status}`);
                        }
                        return response.json(); // Ожидаем JSON
                    })
                    .then(data => updateTable(data.rows)) // Обновляем таблицу
                    .catch(error => console.error('Ошибка сброса фильтров:', error));
            });
        } else {
            console.error('Форма фильтрации или кнопка сброса не найдены.');
        }
    });

   
    </script>
</body>
</html>


