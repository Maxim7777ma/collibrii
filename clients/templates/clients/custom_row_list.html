{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ table.name }} - –°–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫</title>
    <link rel="stylesheet" href="{% static 'css/tablelist.css' %}">
</head>
<body>
    <h1>–°–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫ —Ç–∞–±–ª–∏—Ü—ñ: {{ table.name }}</h1>

    <!-- –§–∏–ª—å—Ç—Ä -->
    <button class="filter-toggle-btn" id="toggle-filters">–ü–æ–∫–∞–∑–∞—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏</button>
    <div id="filter-container" class="filter-container">
        <h3>–§—ñ–ª—å—Ç—Ä</h3>
        <form id="filter-form" method="POST">
            {% csrf_token %}
    
            <!-- –û—Å—Ç–∞–≤—à–∏–µ—Å—è —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –∏ –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã -->
            {% for field in visible_fields %}
                {% if field.name not in "last_updated inquiry_date due_date record_date" %}
                    <div class="filter-group">
                        <label for="filter-{{ field.name }}">{{ field.label }}</label>
                        {% if field.name in allowed_fields %}
                            <select id="filter-{{ field.name }}" name="{{ field.name }}" class="filter-dropdown">
                                <option value="">–í—Å—ñ</option>
                                {% for value in choices|get_item:field.name %}
                                <option value="{{ value }}">{{ translations|get_item:value|default:value }}</option>
                                {% endfor %}
                            </select>
                        {% else %}
                            <input type="text" id="filter-{{ field.name }}" name="{{ field.name }}" placeholder="–í–≤–µ–¥—ñ—Ç—å –∑–Ω–∞—á–µ–Ω–Ω—è">
                        {% endif %}
                    </div>
                {% endif %}
                <!-- –ü–æ–ª–µ "–î–∞—Ç–∞ –ø–æ—á–∞—Ç–∫—É" -->
            {% endfor %}
            <div class="filter-group">
                <label for="filter-start_datetime">–î–∞—Ç–∞ –ø–æ—á–∞—Ç–∫—É</label>
                <input type="datetime-local" id="filter-start_datetime" name="start_datetime">
            </div>
    
            <!-- –ü–æ–ª–µ "–î–∞—Ç–∞ –∫—ñ–Ω—Ü—è" -->
            <div class="filter-group">
                <label for="filter-end_datetime">–î–∞—Ç–∞ –∫—ñ–Ω—Ü—è</label>
                <input type="datetime-local" id="filter-end_datetime" name="end_datetime">
            </div>
            <div class="filter-buttons">
                <button id="filter-button" class="filter-start" type="submit">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä</button>
                <button class="filter-stop" type="button" id="reset-filters">–°–∫–∏–Ω—É—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏</button>
            </div>
        </form>
    </div>


    <!-- –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
    <div class="actions">
        <a href="{% url 'add_row' table.id %}" class="btn-add">–î–æ–¥–∞—Ç–∏ —Ä—è–¥–æ–∫</a>
        <a href="{% url 'custom_table_list' %}" class="btn-back">–ù–∞–∑–∞–¥ –¥–æ —Ç–∞–±–ª–∏—Ü—å</a>
    </div>
    <h2 class="excel-title">üìÇ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è Excel</h2>

    <!-- –§–æ—Ä–º–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ -->
    <form action="{% url 'upload_excel' table.id %}" method="POST" enctype="multipart/form-data" class="excel-upload-form">
        {% csrf_token %}
        <input type="file" name="file" accept=".xls,.xlsx" required class="file-input">
        <button type="submit" class="upload-btn">üì§ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
    </form>
    
    <!-- –í—ã–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏–π -->
    {% if messages %}
        <ul class="message-list">
            {% for message in messages %}
                <li class="message-item {{ message.tags }}">{{ message }}</li>
            {% endfor %}
        </ul>
    {% endif %}
    
    <hr class="divider">
    
    <!-- –ë–ª–æ–∫ —Å –¥—É–±–ª–∏–∫–∞—Ç–∞–º–∏ -->
    <h2 class="duplicate-title">üîç –ó–Ω–∞–π–¥–µ–Ω—ñ –¥—É–±–ª—ñ–∫–∞—Ç–∏</h2>
    <div id="duplicates-container" class="duplicates-block"></div>
    
    <!-- –ë–ª–æ–∫ —Å –Ω–æ–≤—ã–º–∏ –∑–∞–ø–∏—Å—è–º–∏ -->
    <h2 class="new-entries-title">üÜï –ù–æ–≤—ñ –∑–∞–ø–∏—Å–∏</h2>
    <div id="new-entries-container" class="new-entries-block"></div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ —Å—Ç—Ä–æ–∫ -->
    <table id="data-table" data-table-id="{{ table.id }}">
        <thead>
            <tr>
                <th>ID</th>
                {% for field in visible_fields %}
                    <th>{{ field.label }}</th> <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã –∏–∑ FIELD_TRANSLATIONS -->
                {% endfor %}
                <th>–î—ñ—ó</th>
            </tr>
        </thead>
        <tbody id="table-body">
            {% for row in rows %}
            <tr data-row-id="{{ row.id }}">
                <td>{{ row.id }}</td>
                {% for field in visible_fields %}
                    <td class="
                        {% if field.name == 'phone_number' and row.additional_data|get_item:'phone_number' in duplicate_phones %}duplicate{% endif %}
                        {% if field.name == 'instagram_username' and row.additional_data|get_item:'instagram_username' in duplicate_usernames %}duplicate{% endif %}
                    ">
                        {% if field.name == 'contact' %}
                            <select class="editable-select contact-select" data-row-id="{{ row.id }}">
                                <option value="contact_1" {% if row.contact == 'contact_1' %}selected{% endif %}>–ö–æ–Ω—Ç–∞–∫—Ç 1</option>
                                <option value="contact_2" {% if row.contact == 'contact_2' %}selected{% endif %}>–ö–æ–Ω—Ç–∞–∫—Ç 2</option>
                                <option value="contact_3" {% if row.contact == 'contact_3' %}selected{% endif %}>–ö–æ–Ω—Ç–∞–∫—Ç 3</option>
                                <option value="contact_4" {% if row.contact == 'contact_4' %}selected{% endif %}>–ö–æ–Ω—Ç–∞–∫—Ç 4</option>
                            </select>
                        {% elif field.name == 'status' %}
                            <select class="editable-select status-select" data-row-id="{{ row.id }}">
                                <option value="lead" {% if row.status == 'lead' %}selected{% endif %}>–õ—ñ–¥</option>
                                <option value="client" {% if row.status == 'client' %}selected{% endif %}>–ö–ª—ñ—î–Ω—Ç</option>
                                <option value="customer" {% if row.status == 'customer' %}selected{% endif %}>–ó–∞–º–æ–≤–Ω–∏–∫</option>
                            </select>
                        {% elif field.name == 'priority' %}
                            <select class="editable-select priority-select" data-row-id="{{ row.id }}">
                                <option value="low" {% if row.priority == 'low' %}selected{% endif %}>–ù–∏–∑—å–∫–∏–π</option>
                                <option value="medium" {% if row.priority == 'medium' %}selected{% endif %}>–°–µ—Ä–µ–¥–Ω—ñ–π</option>
                                <option value="high" {% if row.priority == 'high' %}selected{% endif %}>–í–∏—Å–æ–∫–∏–π</option>
                            </select>
                        {% elif field.name == 'change_status_contact' %}
                            <select class="editable-select change-status-contact-select" data-row-id="{{ row.id }}">
                                <option value="contact_1" {% if row.change_status_contact == 'contact_1' %}selected{% endif %}>–ö–æ–Ω—Ç–∞–∫—Ç 1</option>
                                <option value="contact_2" {% if row.change_status_contact == 'contact_2' %}selected{% endif %}>–ö–æ–Ω—Ç–∞–∫—Ç 2</option>
                                <option value="contact_3" {% if row.change_status_contact == 'contact_3' %}selected{% endif %}>–ö–æ–Ω—Ç–∞–∫—Ç 3</option>
                                <option value="contact_4" {% if row.change_status_contact == 'contact_4' %}selected{% endif %}>–ö–æ–Ω—Ç–∞–∫—Ç 4</option>
                            </select>
                            
                        {% elif field.name == 'deal_amount' %}
                            {{ row.deal_amount }} {{ row.deal_amount_currency }}
                        {% elif field.name == 'paid_amount' %}
                            {{ row.paid_amount }} {{ row.paid_amount_currency }}
                        {% elif field.name == 'expected_profit' %}
                            {{ row.expected_profit }} {{ row.expected_profit_currency }}
                        {% elif field.name == 'instagram_username' %}
                            {% with username=row.additional_data|get_item:'instagram_username' link=row.additional_data|get_item:'instagram_link' %}
                                {% if username and link %}
                                    <a href="{{ link }}" target="_blank">{{ username }}</a>
                                {% else %}
                                    {{ username|default:"-" }}
                                {% endif %}
                            {% endwith %}

                        {% elif field.name == 'updated_by' %}
                            {{ row.updated_by_names|default:"-" }}  <!-- ‚úÖ –ü—Ä–æ—Å—Ç–æ –≤—ã–≤–æ–¥–∏–º –Ω–∏–∫–Ω–µ–π–º—ã -->
                            

                        {% elif field.name == 'phone_number' %}
                            {% with phone=row.additional_data|get_item:'phone_number' %}
                                {% if phone %}
                                    <a href="tel:{{ phone }}">{{ phone }}</a>
                                {% else %}
                                    {{ phone|default:"-" }}
                                {% endif %}
                            {% endwith %}

                        {% else %}
                            {{ row.additional_data|get_item:field.name|default:"-" }}
                        {% endif %}
                    </td>
                {% endfor %}
                <td>
                    <a href="{% url 'edit_row' table.id row.id %}" class="btn-edit">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</a>
                    <button class="btn-delete" data-row-id="{{ row.id }}">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="{{ visible_fields|length|add:'1' }}">–î–∞–Ω—ñ –≤—ñ–¥—Å—É—Ç–Ω—ñ</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
<!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
<div class="pagination">
    {% if rows.has_previous %}
        <a href="?page=1{% for k, v in filters.items %}&{{ k }}={{ v }}{% endfor %}" class="page-btn first">‚èÆ –ü–µ—Ä–≤–∞—è</a>
        <a href="?page={{ rows.previous_page_number }}{% for k, v in filters.items %}&{{ k }}={{ v }}{% endfor %}" class="page-btn prev">‚¨Ö –ü—Ä–µ–¥—ã–¥—É—â–∞—è</a>
    {% endif %}

    <span class="page-info">–°—Ç—Ä–∞–Ω–∏—Ü–∞ <strong>{{ rows.number }}</strong> –∏–∑ <strong>{{ total_pages }}</strong></span>

    {% if rows.has_next %}
        <a href="?page={{ rows.next_page_number }}{% for k, v in filters.items %}&{{ k }}={{ v }}{% endfor %}" class="page-btn next">‚û° –°–ª–µ–¥—É—é—â–∞—è</a>
        <a href="?page={{ total_pages }}{% for k, v in filters.items %}&{{ k }}={{ v }}{% endfor %}" class="page-btn last">‚è≠ –ü–æ—Å–ª–µ–¥–Ω—è—è</a>
    {% endif %}
</div>
    <!-- JavaScript -->
    <script>
        // –ü–æ–ª—É—á–µ–Ω–∏–µ CSRF-—Ç–æ–∫–µ–Ω–∞
        function getCSRFToken() {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith('csrftoken=')) {
                    return cookie.substring('csrftoken='.length);
                }
            }
            return '';
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞
        document.querySelectorAll('.contact-select').forEach(select => {
            select.addEventListener('change', function () {
                const rowId = this.dataset.rowId;
                const contactValue = this.value;

                fetch(`/clients/tables/update-contact/${rowId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({ contact: contactValue })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('–ö–æ–Ω—Ç–∞–∫—Ç –æ–±–Ω–æ–≤–ª–µ–Ω!');
                        if (data.auto_status_change) {
                            document.querySelector(`.status-select[data-row-id="${rowId}"]`).value = 'client';
                        }
                    } else {
                        alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–∞.');
                    }
                })
                .catch(error => console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error));
            });
        });

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        document.querySelectorAll('.status-select').forEach(select => {
            select.addEventListener('change', function () {
                const rowId = this.dataset.rowId;
                const statusValue = this.value;

                fetch(`/clients/tables/update-status/${rowId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({ status: statusValue })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω!');
                    } else {
                        alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞.');
                    }
                })
                .catch(error => console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error));
            });
        });

        // –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏
        document.querySelectorAll('.btn-delete').forEach(button => {
            button.addEventListener('click', function () {
                const rowId = this.dataset.rowId;
                if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–æ–∫—É —Å ID ${rowId}?`)) {
                    fetch(`/clients/tables/{{ table.id }}/delete-row/${rowId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCSRFToken()
                        }
                    })
                    .then(response => {
                        if (response.ok) {
                            document.querySelector(`tr[data-row-id="${rowId}"]`).remove();
                        } else {
                            alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏.');
                        }
                    })
                    .catch(error => console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error));
                }
            });
        });
    </script>
    <script>

        

        // –ü–æ–ª—É—á–µ–Ω–∏–µ CSRF-—Ç–æ–∫–µ–Ω–∞
        function getCSRFToken() {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith('csrftoken=')) {
                    return cookie.substring('csrftoken='.length);
                }
            }
            return '';
        }
    
        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª–µ–π (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è)
        function updateField(rowId, fieldName, value) {
            fetch(`/clients/tables/update-field/${rowId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({ field: fieldName, value: value })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`${data.message}`);
    
                    // ‚úÖ –ï—Å–ª–∏ –∫–æ–Ω—Ç–∞–∫—Ç == —Å—Ç–∞—Ç—É—Å—É –∫–æ–Ω—Ç–∞–∫—Ç–∞, —Å—Ç–∞—Ç—É—Å –º–µ–Ω—è–µ–º –Ω–∞ client
                    if (data.auto_status_change) {
                        document.querySelector(`.status-select[data-row-id="${rowId}"]`).value = 'client';
                    }
                } else {
                    alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.');
                }
            })
            .catch(error => console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error));
        }
    
        // –í–µ—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –≤—Å–µ –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏
        document.querySelectorAll('.editable-select').forEach(select => {
            select.addEventListener('change', function () {
                const rowId = this.dataset.rowId;
                const fieldName = this.classList.contains('contact-select') ? 'contact'
                    : this.classList.contains('status-select') ? 'status'
                    : this.classList.contains('priority-select') ? 'priority'
                    : this.classList.contains('change-status-contact-select') ? 'change_status_contact'
                    : null;
    
                if (fieldName) {
                    updateField(rowId, fieldName, this.value);
                }
            });
        });
    </script>

    
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            console.log("üìå DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤...");
            let urlParams = new URLSearchParams(window.location.search);
            let hasFilters = false;


            // ‚úÖ –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –∏–∑ URL
            document.querySelectorAll("#filter-form input, #filter-form select").forEach(input => {
                let paramValue = urlParams.get(input.name);
                if (paramValue) {
                    input.value = paramValue;
                    hasFilters = true;
                }
            });
            // üîπ –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
            const filterButton = document.querySelector("#filter-button");
            const rowsContainer = document.querySelector("#rows-container");
            const paginatorContainer = document.querySelector("#paginator-container");
            const toggleFiltersButton = document.getElementById("toggle-filters");
            const filterForm = document.getElementById("filter-form");
            const resetFiltersButton = document.getElementById("reset-filters");
            const tableElement = document.getElementById("data-table");
            const translations = {
                "—Å—Ç–∞—Ç—É—Å": {
                    "–õ—ñ–¥": "lead",
                    "–ö–ª—ñ—î–Ω—Ç": "client",
                    "–ó–∞–º–æ–≤–Ω–∏–∫": "customer"
                },
                "–∫–æ–Ω—Ç–∞–∫—Ç": {
                    "–ö–æ–Ω—Ç–∞–∫—Ç 1": "contact_1",
                    "–ö–æ–Ω—Ç–∞–∫—Ç 2": "contact_2",
                    "–ö–æ–Ω—Ç–∞–∫—Ç 3": "contact_3",
                    "–ö–æ–Ω—Ç–∞–∫—Ç 4": "contact_4"
                },
                "–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç": {
                    "–ù–∏–∑—å–∫–∏–π": "low",
                    "–°–µ—Ä–µ–¥–Ω—ñ–π": "medium",
                    "–í–∏—Å–æ–∫–∏–π": "high"
                }
            };
    
            // ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø–µ—Ä–µ–¥ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
            if (filterButton) {
                filterButton.addEventListener('click', function () {
                    console.log("üîç –§–∏–ª—å—Ç—Ä –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!");
                    sendFilterRequest(); // –¢–µ–ø–µ—Ä—å –º—ã –Ω–µ –ø–µ—Ä–µ–¥–∞—ë–º –∂—ë—Å—Ç–∫–∏–π –æ–±—ä–µ–∫—Ç
                });
            } else {
                console.warn("‚ö† –ö–Ω–æ–ø–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (#filter-button) –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!");
            }
    
            if (toggleFiltersButton) {
                toggleFiltersButton.addEventListener("click", function () {
                    let filterContainer = document.getElementById("filter-container");
                    if (filterContainer) {
                        filterContainer.classList.toggle("show-filters");
                        this.textContent = filterContainer.classList.contains("show-filters") ? "–°—Ö–æ–≤–∞—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏" : "–ü–æ–∫–∞–∑–∞—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏";
                    }
                });
            } else {
                console.warn("‚ö† –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (#toggle-filters) –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!");
            }
    
            if (filterForm) {
                filterForm.addEventListener("submit", function (e) {
                    e.preventDefault();
                    sendFilterRequest();
                });
            }
    
            if (resetFiltersButton) {
                resetFiltersButton.addEventListener("click", function () {
                    resetFilter();
                });
            }
            // ‚úÖ –ï—Å–ª–∏ –≤ URL –µ—Å—Ç—å —Ñ–∏–ª—å—Ç—Ä ‚Äî –∑–∞–ø—É—Å–∫–∞–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é —Å—Ä–∞–∑—É
            if (hasFilters) {
                sendFilterRequest();
            }
    
            // üîπ –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
            function sendFilterRequest() {
                if (!tableElement) {
                    console.error("‚ùå –¢–∞–±–ª–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!");
                    return;
                }
                let tablePk = tableElement.getAttribute("data-table-id");
            
                let filters = {};
                document.querySelectorAll("#filter-form input, #filter-form select").forEach(input => {
                    if (input.name !== "csrfmiddlewaretoken" && input.value.trim()) {
                        filters[input.name] = input.value.trim();
                    }
                });

                // ‚úÖ –ü–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –ø–µ—Ä–µ–≤–æ–¥–∏–º –∑–Ω–∞—á–µ–Ω–∏—è
                Object.keys(filters).forEach(key => {
                    if (translations[key] && translations[key][filters[key]]) {
                        filters[key] = translations[key][filters[key]]; // –ú–µ–Ω—è–µ–º –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
                    }
                });
            
                // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ª–æ–≥ –≤ –∫–æ–Ω—Å–æ–ª—å
                console.log("üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä:", filters);
                // ‚úÖ –û–±–Ω–æ–≤–ª—è–µ–º URL –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∑–∞–ø—Ä–æ—Å–∞
                let queryParams = new URLSearchParams(filters).toString();
                let newUrl = window.location.pathname + "?" + queryParams;
                window.history.pushState({}, "", newUrl);
            
                fetch(`/clients/tables/filter-rows/${tablePk}/`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCSRFToken()
                    },
                    body: JSON.stringify(filters),
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`‚ùå –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        console.log("üìå –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥—É–±–ª–∏–∫–∞—Ç—ã:", data.duplicate_usernames, data.duplicate_phones);
                        applyFilter(data.data, data.duplicate_usernames || [], data.duplicate_phones || []);
                    } else {
                        console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:", data.error);
                    }
                })
                .catch(error => {
                    console.error("‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏:", error);
                });
            }
            
            // üîπ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞
            function applyFilter(rows, duplicateUsernames = [], duplicatePhones = []) {
                console.log("üìå –§–∏–ª—å—Ç—Ä –ø—Ä–∏–º–µ–Ω–µ–Ω, –Ω–∞–π–¥–µ–Ω–æ —Å—Ç—Ä–æ–∫:", rows.length);
                console.log("üîç –î—É–±–ª–∏–∫–∞—Ç—ã –Ω–∏–∫–Ω–µ–π–º–æ–≤:", duplicateUsernames);
                console.log("üîç –î—É–±–ª–∏–∫–∞—Ç—ã —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤:", duplicatePhones);

                // ‚úÖ –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–≤–æ–¥–∏–º –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –æ–±—Ä–∞—Ç–Ω–æ –≤ —É–∫—Ä
                Object.keys(translations).forEach(key => {
                    Object.entries(translations[key]).forEach(([ru, en]) => {
                        rows.forEach(row => {
                            if (row.fields[key] === en) {
                                row.fields[key] = ru; // –ú–µ–Ω—è–µ–º –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ —Ä—É—Å—Å–∫–∏–π
                            }
                        });
                    });
                });
            
                let tableBody = document.querySelector("#table-body");
                tableBody.innerHTML = "";  // ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π
            
                rows.forEach(row => {
                    let tr = document.createElement("tr");
                    tr.setAttribute("data-row-id", row.pk);
            
                    let tdId = document.createElement("td");
                    tdId.textContent = row.pk;
                    tr.appendChild(tdId);
            
                    Object.keys(row.fields).forEach(field => {
                        let td = document.createElement("td");
                        let value = row.fields[field] || "-";
            
                        // ‚úÖ –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (Instagram, —Ç–µ–ª–µ—Ñ–æ–Ω)
                        if (field === "instagram_username" && duplicateUsernames.includes(value)) {
                            td.classList.add("duplicate");
                            console.log(`üö® –î—É–±–ª–∏–∫–∞—Ç Instagram: ${value}`);
                        }
                        if (field === "phone_number" && duplicatePhones.includes(value)) {
                            td.classList.add("duplicate");
                            console.log(`üö® –î—É–±–ª–∏–∫–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞: ${value}`);
                        }
            
                        // ‚úÖ –õ–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–µ–ª–µ–∫—Ç–æ–≤
                        if (["status", "contact", "priority"].includes(field)) {
                            let select = document.createElement("select");
                            select.classList.add("editable-select");
                            select.dataset.rowId = row.pk;
            
                            let options = {
                                "status": { "lead": "–õ—ñ–¥", "client": "–ö–ª—ñ—î–Ω—Ç", "customer": "–ó–∞–º–æ–≤–Ω–∏–∫" },
                                "contact": { "contact_1": "–ö–æ–Ω—Ç–∞–∫—Ç 1", "contact_2": "–ö–æ–Ω—Ç–∞–∫—Ç 2", "contact_3": "–ö–æ–Ω—Ç–∞–∫—Ç 3", "contact_4": "–ö–æ–Ω—Ç–∞–∫—Ç 4" },
                                "priority": { "low": "–ù–∏–∑—å–∫–∏–π", "medium": "–°–µ—Ä–µ–¥–Ω—ñ–π", "high": "–í–∏—Å–æ–∫–∏–π" }
                            };
            
                            Object.entries(options[field]).forEach(([value, label]) => {
                                let opt = document.createElement("option");
                                opt.value = value;
                                opt.textContent = label;
                                if (row.fields[field] === value) opt.selected = true;
                                select.appendChild(opt);
                            });
            
                            // ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è
                            select.addEventListener("change", function () {
                                updateField(row.pk, field, this.value);
                            });
            
                            td.appendChild(select);
                        }
                        // ‚úÖ –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å—Å—ã–ª–∫–∏ Instagram
                        else if (field === "instagram_username") {
                            let link = document.createElement("a");
                            link.href = row.fields["instagram_link"] || "#";
                            link.textContent = value;
                            link.target = "_blank";
                            td.appendChild(link);
                        }
                        // ‚úÖ –û–±—ã—á–Ω—ã–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è
                        else {
                            td.textContent = value;
                        }
            
                        tr.appendChild(td);
                    });
            
                    // ‚úÖ –ö–Ω–æ–ø–∫–∏ "–†–µ–¥–∞–≥—É–≤–∞—Ç–∏" –∏ "–í–∏–¥–∞–ª–∏—Ç–∏"
                    let tdActions = document.createElement("td");
                    tdActions.innerHTML = `
                        <a href="/clients/tables/${document.getElementById("data-table").getAttribute("data-table-id")}/edit/${row.pk}/" class="btn-edit">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</a>
                        <button class="btn-delete" data-row-id="${row.pk}">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                    `;
                    tr.appendChild(tdActions);
            
                    tableBody.appendChild(tr);
                });
            
                // ‚úÖ –†–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
                document.querySelectorAll('.btn-delete').forEach(button => {
                    button.addEventListener('click', function () {
                        const rowId = this.dataset.rowId;
                        if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–æ–∫—É —Å ID ${rowId}?`)) {
                            fetch(`/clients/tables/${document.getElementById("data-table").getAttribute("data-table-id")}/delete-row/${rowId}/`, {
                                method: 'POST',
                                headers: { "X-CSRFToken": getCSRFToken() }
                            })
                            .then(response => {
                                if (response.ok) {
                                    document.querySelector(`tr[data-row-id="${rowId}"]`).remove();
                                } else {
                                    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏.');
                                }
                            })
                            .catch(error => console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error));
                        }
                    });
                });
            
                console.log("‚úÖ –¢–∞–±–ª–∏—Ü–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!");
            }
            
            
    
            // üîπ –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
            function resetFilter() {
                console.log("üîÑ –°–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–æ–≤...");
                
                // ‚úÖ –û—á–∏—â–∞–µ–º –≤—Å–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã
                document.querySelectorAll("#filter-form input, #filter-form select").forEach(input => input.value = "");
            
                // ‚úÖ –£–±–∏—Ä–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –∏–∑ URL
                window.history.replaceState({}, "", window.location.pathname);
            
                // ‚úÖ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞
                location.reload();
            }
            
            
            
    
            // üîπ –ü–æ–ª—É—á–µ–Ω–∏–µ CSRF-—Ç–æ–∫–µ–Ω–∞
            function getCSRFToken() {
                let csrfToken = null;
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    cookie = cookie.trim();
                    if (cookie.startsWith('csrftoken=')) {
                        csrfToken = cookie.substring('csrftoken='.length);
                    }
                }
                if (!csrfToken) {
                    console.error("‚ö† CSRF-—Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω!");
                }
                return csrfToken;
            }
        });
    </script>
    
<script>
    document.getElementById("upload-form").addEventListener("submit", function(event) {
        event.preventDefault(); // ‚ùå –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    
        let formData = new FormData(this);
        let tableId = document.getElementById("data-table").dataset.tableId; // ‚úÖ –ü–æ–ª—É—á–∞–µ–º ID —Ç–∞–±–ª–∏—Ü—ã
        
        console.log("üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª:", formData.get("file"));
    
        fetch(`/clients/tables/${tableId}/upload-excel/`, { // ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π URL
            method: "POST",
            body: formData, // ‚úÖ –ü–µ—Ä–µ–¥–∞–µ–º —Ñ–∞–π–ª –≤ FormData
            headers: {
                "X-CSRFToken": getCSRFToken() // ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º CSRF-—Ç–æ–∫–µ–Ω
            }
        })
        .then(response => response.text())  // ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–∏—Ö–æ–¥–∏—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
        .then(text => {
            console.log("üì© –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (—Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ):", text);
            if (!text.trim()) throw new Error("‚ùå –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç!");
            return JSON.parse(text);  // ‚úÖ –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ JSON –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π
        })
        .then(data => {
            console.log("‚úÖ JSON-–¥–∞–Ω–Ω—ã–µ:", data);
            if (data.success) {
                displayDuplicates(data.duplicates);
                displayNewEntries(data.new_entries);
            } else {
                alert("‚ùå –ü–æ–º–∏–ª–∫–∞: " + data.error);
            }
        })
        .catch(error => {
            console.error("‚ùå –û—à–∏–±–∫–∞:", error);
            alert("‚ö† –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ: " + error.message);
        });
    });
    
    
    function resolveDuplicate(existing_id, new_data, action) {
        let payload = {
            existing_id: existing_id,
            new_data: new_data ? JSON.parse(decodeURIComponent(new_data)) : null, // ‚úÖ –î–µ–∫–æ–¥–∏—Ä—É–µ–º –∏ –ø–∞—Ä—Å–∏–º JSON
            action: action
        };
    
        let tableId = document.getElementById("data-table").dataset.tableId; // ‚úÖ –ü–æ–ª—É—á–∞–µ–º table.id
    
        fetch(`/clients/tables/${tableId}/resolve-duplicate/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCSRFToken()
            },
            body: JSON.stringify(payload)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error("‚ùå –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É: " + response.status);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert("‚úÖ –î—É–±–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω!");
                location.reload(); // üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
            } else {
                alert("‚ùå –ü–æ–º–∏–ª–∫–∞: " + data.error);
            }
        })
        .catch(error => console.error("‚ùå –û—à–∏–±–∫–∞:", error));
    }
    
    function getCSRFToken() {
        return document.querySelector("input[name='csrfmiddlewaretoken']").value;
    }
</script>
    
    <style>
        .hidden-row {
            display: none !important;
        }
    </style>
</body>
</html>