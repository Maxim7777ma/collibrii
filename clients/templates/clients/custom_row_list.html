{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ table.name }} - –°–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫</title>
    <link rel="stylesheet" href="{% static 'css/tablelist.css' %}">
</head>
<body>
    <h1>–°–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫ —Ç–∞–±–ª–∏—Ü—ñ: {{ table.name }}</h1>
    <h2>üîé –†–æ–∑—É–º–Ω–∏–π –ø–æ—à—É–∫ –ø–æ —Ç–∞–±–ª–∏—Ü—ñ</h2>
    <input class="global_filtr" type="text" id="search" placeholder="üîé –í–≤–µ–¥—ñ—Ç—å —Ç–µ–∫—Å—Ç, —Å—É–º—É, –¥–∞—Ç—É –∞–±–æ –≤–∞–ª—é—Ç—É..." style="width: 300px; padding: 5px;">

    
    <!-- –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
    <div class="actions">
        <!-- –§–∏–ª—å—Ç—Ä -->
        <button class="filter-toggle-btn" id="toggle-filters">–ü–æ–∫–∞–∑–∞—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏</button>
        <a href="{% url 'add_row' table.id %}" class="btn-add">–î–æ–¥–∞—Ç–∏ —Ä—è–¥–æ–∫</a>
        <a href="{% url 'custom_table_list' %}" class="btn-back">–ù–∞–∑–∞–¥ –¥–æ —Ç–∞–±–ª–∏—Ü—å</a>
    </div>
    <div id="filter-container" class="filter-container">
        <h3>–§—ñ–ª—å—Ç—Ä</h3>
        <form id="filter-form" method="POST">
            {% csrf_token %}
    
            <!-- –û—Å—Ç–∞–≤—à–∏–µ—Å—è —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –∏ –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã -->
            {% for field in visible_fields %}
                {% if field.name not in "last_updated inquiry_date due_date record_date" %}
                    <div class="filter-group">
                        <label for="filter-{{ field.name }}">{{ field.label }}</label>
                        {% if field.name in allowed_fields %}
                            <select id="filter-{{ field.name }}" name="{{ field.name }}" class="filter-dropdown">
                                <option value="">–í—Å—ñ</option>
                                {% for value in choices|get_item:field.name %}
                                <option value="{{ value }}">{{ translations|get_item:field.name|get_item:value|default:value }}</option>
                                {% endfor %}
                            </select>
                        {% else %}
                            <input type="text" id="filter-{{ field.name }}" name="{{ field.name }}" placeholder="–í–≤–µ–¥—ñ—Ç—å –∑–Ω–∞—á–µ–Ω–Ω—è">
                        {% endif %}
                    </div>
                {% endif %}
                <!-- –ü–æ–ª–µ "–î–∞—Ç–∞ –ø–æ—á–∞—Ç–∫—É" -->
            {% endfor %}
            <div class="filter-group">
                <label for="filter-start_datetime">–î–∞—Ç–∞ –ø–æ—á–∞—Ç–∫—É</label>
                <input type="datetime-local" id="filter-start_datetime" name="start_datetime">
            </div>
    
            <!-- –ü–æ–ª–µ "–î–∞—Ç–∞ –∫—ñ–Ω—Ü—è" -->
            <div class="filter-group">
                <label for="filter-end_datetime">–î–∞—Ç–∞ –∫—ñ–Ω—Ü—è</label>
                <input type="datetime-local" id="filter-end_datetime" name="end_datetime">
            </div>
            <div class="filter-buttons">
                <button id="filter-button" class="filter-start" type="submit">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä</button>
                <button class="filter-stop" type="button" id="reset-filters">–°–∫–∏–Ω—É—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏</button>
            </div>
        </form>
    </div>


    
    <h2 class="excel-title">üìÇ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è Excel</h2>

    <!-- –§–æ—Ä–º–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ -->
    <form id="upload-form" action="{% url 'upload_excel' table.id %}" method="POST" enctype="multipart/form-data" class="excel-upload-form">
        {% csrf_token %}
        <input type="file" name="file" accept=".xls,.xlsx" required class="file-input">
        <button type="submit" class="upload-btn">üì§ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</button>
    </form>
    
    <!-- –í—ã–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏–π -->
    {% if messages %}
        <ul class="message-list">
            {% for message in messages %}
                <li class="message-item {{ message.tags }}">{{ message }}</li>
            {% endfor %}
        </ul>
    {% endif %}
    
    <hr class="divider">
    
    <!-- –ë–ª–æ–∫ —Å –¥—É–±–ª–∏–∫–∞—Ç–∞–º–∏ -->
     <!-- üìä –ë–ª–æ–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <h2 class="upload-summary-title">üìä –ü—ñ–¥—Å—É–º–∫–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</h2>
    <div class="upload-summary">
            <p><strong>üìÇ –ó–∞–≥–∞–ª—å–Ω–µ —á–∏—Å–ª–æ –∑–∞–ø–∏—Å—ñ–≤ —É —Ñ–∞–π–ª—ñ:</strong> <span id="total-rows">0</span></p>
            <p><strong>‚úÖ –£—Å–ø—ñ—à–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ:</strong> <span id="uploaded-rows">0</span></p>
            <p><strong>üîÑ –û–Ω–æ–≤–ª–µ–Ω—ñ –∑–∞–ø–∏—Å–∏:</strong> <span id="updated-rows">0</span></p>
            <p><strong>üóë –í–∏–¥–∞–ª–µ–Ω—ñ –∑–∞–ø–∏—Å–∏:</strong> <span id="deleted-rows">0</span></p>
            <p><strong>‚è≥ –ß–∞—Å –æ–±—Ä–æ–±–∫–∏:</strong> <span id="processing-time">0 —Å–µ–∫.</span></p>
            <p><strong>üìÖ –î–∞—Ç–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è:</strong> <span id="upload-time">-</span></p>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h3>–í–∏–¥–∞–ª–µ–Ω–Ω—è –∑–∞–ø–∏—Å—É</h3>
            <p>–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –∑–∞–ø–∏—Å?</p>
            <div class="modal-buttons">
                <button id="confirmDelete" class="btn-confirm">–¢–∞–∫, –≤–∏–¥–∞–ª–∏—Ç–∏</button>
                <button id="cancelDelete" class="btn-cancel">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
            </div>
        </div>
    </div>
    

    
    <h2 class="duplicate-title"> –ó–Ω–∞–π–¥–µ–Ω—ñ –¥—É–±–ª—ñ–∫–∞—Ç–∏</h2>
    
    <div id="duplicates-container" class="duplicates-block"></div>
    
    <!-- –ë–ª–æ–∫ —Å –Ω–æ–≤—ã–º–∏ –∑–∞–ø–∏—Å—è–º–∏ -->
    <h2 class="new-entries-title">üÜï –ù–æ–≤—ñ –∑–∞–ø–∏—Å–∏</h2>
    <div id="new-entries-container" class="new-entries-block"></div>

    
    <h3 id="filter-results-count" style="display: none;"> –ó–Ω–∞–π–¥–µ–Ω–æ –∑–∞–ø–∏—Å—ñ–≤: <span id="filtered-count">0</span></h3>
    
    <!-- –¢–∞–±–ª–∏—Ü–∞ —Å—Ç—Ä–æ–∫ -->
    <table id="data-table" data-table-id="{{ table.id }}">
        <thead>
            <tr>
                <th>ID</th>
                {% for field in visible_fields %}
                    <th>{{ field.label }}</th> <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã –∏–∑ FIELD_TRANSLATIONS -->
                {% endfor %}
                <th>–î—ñ—ó</th>
            </tr>
        </thead>
        <tbody id="table-body">
            {% for row in rows %}
            <tr data-row-id="{{ row.id }}">
                <td>{{ row.id }}</td>
                {% for field in visible_fields %}
                    <td class="
                        {% if field.name == 'phone_number' and row.additional_data|get_item:'phone_number' in duplicate_phones %}duplicate{% endif %}
                        {% if field.name == 'instagram_username' and row.additional_data|get_item:'instagram_username' in duplicate_usernames %}duplicate{% endif %}
                    ">
                        {% if field.name == 'contact' %}
                            <select class="editable-select contact-select" data-row-id="{{ row.id }}">
                                <option value="contact_1" {% if row.contact == 'contact_1' %}selected{% endif %}>–ö–æ–Ω—Ç–∞–∫—Ç 1</option>
                                <option value="contact_2" {% if row.contact == 'contact_2' %}selected{% endif %}>–ö–æ–Ω—Ç–∞–∫—Ç 2</option>
                                <option value="contact_3" {% if row.contact == 'contact_3' %}selected{% endif %}>–ö–æ–Ω—Ç–∞–∫—Ç 3</option>
                                <option value="contact_4" {% if row.contact == 'contact_4' %}selected{% endif %}>–ö–æ–Ω—Ç–∞–∫—Ç 4</option>
                            </select>
                        {% elif field.name == 'status' %}
                            <select class="editable-select status-select" data-row-id="{{ row.id }}">
                                <option value="lead" {% if row.status == 'lead' %}selected{% endif %}>–õ—ñ–¥</option>
                                <option value="client" {% if row.status == 'client' %}selected{% endif %}>–ö–ª—ñ—î–Ω—Ç</option>
                                <option value="customer" {% if row.status == 'customer' %}selected{% endif %}>–ó–∞–º–æ–≤–Ω–∏–∫</option>
                            </select>
                        {% elif field.name == 'priority' %}
                            <select class="editable-select priority-select" data-row-id="{{ row.id }}">
                                <option value="low" {% if row.priority == 'low' %}selected{% endif %}>–ù–∏–∑—å–∫–∏–π</option>
                                <option value="medium" {% if row.priority == 'medium' %}selected{% endif %}>–°–µ—Ä–µ–¥–Ω—ñ–π</option>
                                <option value="high" {% if row.priority == 'high' %}selected{% endif %}>–í–∏—Å–æ–∫–∏–π</option>
                            </select>
                        {% elif field.name == 'change_status_contact' %}
                            <select class="editable-select change-status-contact-select" data-row-id="{{ row.id }}">
                                <option value="contact_1" {% if row.change_status_contact == 'contact_1' %}selected{% endif %}>–ö–æ–Ω—Ç–∞–∫—Ç 1</option>
                                <option value="contact_2" {% if row.change_status_contact == 'contact_2' %}selected{% endif %}>–ö–æ–Ω—Ç–∞–∫—Ç 2</option>
                                <option value="contact_3" {% if row.change_status_contact == 'contact_3' %}selected{% endif %}>–ö–æ–Ω—Ç–∞–∫—Ç 3</option>
                                <option value="contact_4" {% if row.change_status_contact == 'contact_4' %}selected{% endif %}>–ö–æ–Ω—Ç–∞–∫—Ç 4</option>
                            </select>
                            
                        {% elif field.name == 'deal_amount' %}
                            {{ row.deal_amount }} {{ row.deal_amount_currency }}
                        {% elif field.name == 'paid_amount' %}
                            {{ row.paid_amount }} {{ row.paid_amount_currency }}
                        {% elif field.name == 'expected_profit' %}
                            {{ row.expected_profit }} {{ row.expected_profit_currency }}
                        {% elif field.name == 'instagram_username' %}
                            {% with username=row.additional_data|get_item:'instagram_username' link=row.additional_data|get_item:'instagram_link' %}
                                {% if username and link %}
                                    <a id="a_class"href="{{ link }}" target="_blank">{{ username }}</a>
                                {% else %}
                                    {{ username|default:"-" }}
                                {% endif %}
                            {% endwith %}

                        {% elif field.name == 'updated_by' %}
                            {{ row.updated_by_names|default:"-" }}  <!-- ‚úÖ –ü—Ä–æ—Å—Ç–æ –≤—ã–≤–æ–¥–∏–º –Ω–∏–∫–Ω–µ–π–º—ã -->
                            

                        {% elif field.name == 'phone_number' %}
                            {% with phone=row.additional_data|get_item:'phone_number' %}
                                {% if phone %}
                                    <a href="tel:{{ phone }}">{{ phone }}</a>
                                {% else %}
                                    {{ phone|default:"-" }}
                                {% endif %}
                            {% endwith %}

                        {% else %}
                            {{ row.additional_data|get_item:field.name|default:"-" }}
                        {% endif %}
                    </td>
                {% endfor %}
                <td>
                    <a href="{% url 'edit_row' table.id row.id %}" class="btn-edit">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</a>
                    <button class="btn-delete" data-row-id="{{ row.id }}">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="{{ visible_fields|length|add:'1' }}">–î–∞–Ω—ñ –≤—ñ–¥—Å—É—Ç–Ω—ñ</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <button id="load-more-btn" style="display: none;">–ü—ñ–¥–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —â–µ</button> <!-- ‚úÖ –ö–Ω–æ–ø–∫–∞ "–ü–æ–¥–≥—Ä—É–∑–∏—Ç—å –µ—â–µ" --> 

<!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
<div class="pagination">
    {% if rows.has_previous %}
        <a href="?page=1{% for k, v in filters.items %}&{{ k }}={{ v }}{% endfor %}" class="page-btn first">‚èÆ –ü–µ—Ä–≤–∞—è</a>
        <a href="?page={{ rows.previous_page_number }}{% for k, v in filters.items %}&{{ k }}={{ v }}{% endfor %}" class="page-btn prev">‚¨Ö –ü—Ä–µ–¥—ã–¥—É—â–∞—è</a>
    {% endif %}

    <span class="page-info">–°—Ç—Ä–∞–Ω–∏—Ü–∞ <strong>{{ rows.number }}</strong> –∏–∑ <strong>{{ total_pages }}</strong></span>

    {% if rows.has_next %}
        <a href="?page={{ rows.next_page_number }}{% for k, v in filters.items %}&{{ k }}={{ v }}{% endfor %}" class="page-btn next">‚û° –°–ª–µ–¥—É—é—â–∞—è</a>
        <a href="?page={{ total_pages }}{% for k, v in filters.items %}&{{ k }}={{ v }}{% endfor %}" class="page-btn last">‚è≠ –ü–æ—Å–ª–µ–¥–Ω—è—è</a>
    {% endif %}
</div>
    <!-- JavaScript -->
    <script>
        // –ü–æ–ª—É—á–µ–Ω–∏–µ CSRF-—Ç–æ–∫–µ–Ω–∞
        function getCSRFToken() {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith('csrftoken=')) {
                    return cookie.substring('csrftoken='.length);
                }
            }
            return '';
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞
        document.querySelectorAll('.contact-select').forEach(select => {
            select.addEventListener('change', function () {
                const rowId = this.dataset.rowId;
                const contactValue = this.value;

                fetch(`/clients/tables/update-contact/${rowId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({ contact: contactValue })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('–ö–æ–Ω—Ç–∞–∫—Ç –æ–±–Ω–æ–≤–ª–µ–Ω!');
                        if (data.auto_status_change) {
                            document.querySelector(`.status-select[data-row-id="${rowId}"]`).value = 'client';
                        }
                    } else {
                        alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–∞.');
                    }
                })
                .catch(error => console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error));
            });
        });

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        document.querySelectorAll('.status-select').forEach(select => {
            select.addEventListener('change', function () {
                const rowId = this.dataset.rowId;
                const statusValue = this.value;

                fetch(`/clients/tables/update-status/${rowId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({ status: statusValue })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω!');
                    } else {
                        alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞.');
                    }
                })
                .catch(error => console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error));
            });
        });


    </script>

     <!-- —É–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–æ–∫—É  -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            console.log("üìå DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–µ–π...");
        
            // –ü–æ–ª—É—á–∞–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç—ã –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            const deleteModal = document.getElementById("deleteModal");
            const deleteConfirmBtn = document.getElementById("confirmDelete");
            const deleteCancelBtn = document.getElementById("cancelDelete");
            let deleteRowId = null;
        
            // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            function showDeleteModal(rowId) {
                deleteRowId = rowId;
                deleteModal.classList.add("show");
            }
        
            // –§—É–Ω–∫—Ü–∏—è —Å–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            function hideDeleteModal() {
                deleteRowId = null;
                deleteModal.classList.remove("show");
            }
        
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
            deleteConfirmBtn.addEventListener("click", function () {
                if (deleteRowId) {
                    deleteRow(deleteRowId);
                }
                hideDeleteModal();
            });
        
            deleteCancelBtn.addEventListener("click", function () {
                hideDeleteModal();
            });
        
            // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏
            function deleteRow(rowId) {
                let tablePk = document.getElementById("data-table").getAttribute("data-table-id");
        
                fetch(`/clients/tables/${tablePk}/delete-row/${rowId}/`, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": getCSRFToken(),
                    },
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`‚ùå –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            console.log(`‚úÖ –ó–∞–ø–∏—Å—å ${rowId} —É–¥–∞–ª–µ–Ω–∞`);
                            document.querySelector(`tr[data-row-id="${rowId}"]`).remove();
                        } else {
                            console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏:", data.error);
                        }
                    })
                    .catch(error => console.error("‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏:", error));
            }
        
            // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞ –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
            document.querySelectorAll(".btn-delete").forEach(button => {
                button.addEventListener("click", function () {
                    let rowId = this.dataset.rowId;
                    showDeleteModal(rowId); // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞—Å—Ç–æ–º–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                });
            });
        
            // –ü–æ–ª—É—á–µ–Ω–∏–µ CSRF-—Ç–æ–∫–µ–Ω–∞
            function getCSRFToken() {
                let csrfToken = null;
                const cookies = document.cookie.split(";");
                for (let cookie of cookies) {
                    cookie = cookie.trim();
                    if (cookie.startsWith("csrftoken=")) {
                        csrfToken = cookie.substring("csrftoken=".length);
                    }
                }
                return csrfToken;
            }
        });
        
    </script>    

    <script>

        

        // –ü–æ–ª—É—á–µ–Ω–∏–µ CSRF-—Ç–æ–∫–µ–Ω–∞
        function getCSRFToken() {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith('csrftoken=')) {
                    return cookie.substring('csrftoken='.length);
                }
            }
            return '';
        }
    
        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª–µ–π (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è)
        function updateField(rowId, fieldName, value) {
            fetch(`/clients/tables/update-field/${rowId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({ field: fieldName, value: value })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`${data.message}`);
    
                    // ‚úÖ –ï—Å–ª–∏ –∫–æ–Ω—Ç–∞–∫—Ç == —Å—Ç–∞—Ç—É—Å—É –∫–æ–Ω—Ç–∞–∫—Ç–∞, —Å—Ç–∞—Ç—É—Å –º–µ–Ω—è–µ–º –Ω–∞ client
                    if (data.auto_status_change) {
                        document.querySelector(`.status-select[data-row-id="${rowId}"]`).value = 'client';
                    }
                } else {
                    alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.');
                }
            })
            .catch(error => console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error));
        }
    
        // –í–µ—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –≤—Å–µ –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏
        document.querySelectorAll('.editable-select').forEach(select => {
            select.addEventListener('change', function () {
                const rowId = this.dataset.rowId;
                const fieldName = this.classList.contains('contact-select') ? 'contact'
                    : this.classList.contains('status-select') ? 'status'
                    : this.classList.contains('priority-select') ? 'priority'
                    : this.classList.contains('change-status-contact-select') ? 'change_status_contact'
                    : null;
    
                if (fieldName) {
                    updateField(rowId, fieldName, this.value);
                }
            });
        });
    </script>

     <!-- –§–∏–ª—å—Ç—Ä -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            console.log("üìå DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤...");
            let urlParams = new URLSearchParams(window.location.search);

            // ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ –±—ã–ª–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ —Ä–∞–Ω–µ–µ
            let savedLoadedRows = localStorage.getItem("loadedRows");

            // ‚úÖ –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö
            if (savedLoadedRows) {
                window.loadedRows = parseInt(savedLoadedRows, 10);
            } else {
                window.loadedRows = 30;  // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∑–∞–≥—Ä—É–∂–∞–µ–º 30 —Å—Ç—Ä–æ–∫
            }

            console.log("üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫:", window.loadedRows);

            let hasFilters = false;
            

            // ‚úÖ –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –∏–∑ URL
            document.querySelectorAll("#filter-form input, #filter-form select").forEach(input => {
                let paramValue = urlParams.get(input.name);
                if (paramValue) {
                    input.value = paramValue;
                    hasFilters = true;
                }
            });
            // üîπ –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
            const filterButton = document.querySelector("#filter-button");
            const rowsContainer = document.querySelector("#rows-container");
            const paginatorContainer = document.querySelector("#paginator-container");
            const toggleFiltersButton = document.getElementById("toggle-filters");
            const filterForm = document.getElementById("filter-form");
            const resetFiltersButton = document.getElementById("reset-filters");
            const tableElement = document.getElementById("data-table");
            const translations = {
                "—Å—Ç–∞—Ç—É—Å": {
                    "–õ—ñ–¥": "lead",
                    "–ö–ª—ñ—î–Ω—Ç": "client",
                    "–ó–∞–º–æ–≤–Ω–∏–∫": "customer"
                },
                "–∫–æ–Ω—Ç–∞–∫—Ç": {
                    "–ö–æ–Ω—Ç–∞–∫—Ç 1": "contact_1",
                    "–ö–æ–Ω—Ç–∞–∫—Ç 2": "contact_2",
                    "–ö–æ–Ω—Ç–∞–∫—Ç 3": "contact_3",
                    "–ö–æ–Ω—Ç–∞–∫—Ç 4": "contact_4"
                },
                "–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç": {
                    "–ù–∏–∑—å–∫–∏–π": "low",
                    "–°–µ—Ä–µ–¥–Ω—ñ–π": "medium",
                    "–í–∏—Å–æ–∫–∏–π": "high"
                }
            };
    
            // ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø–µ—Ä–µ–¥ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
            if (filterButton) {
                filterButton.addEventListener('click', function () {
                    console.log("üîç –§–∏–ª—å—Ç—Ä –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!");
                    sendFilterRequest(); // –¢–µ–ø–µ—Ä—å –º—ã –Ω–µ –ø–µ—Ä–µ–¥–∞—ë–º –∂—ë—Å—Ç–∫–∏–π –æ–±—ä–µ–∫—Ç
                });
            } else {
                console.warn("‚ö† –ö–Ω–æ–ø–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (#filter-button) –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!");
            }
    
            if (toggleFiltersButton) {
                toggleFiltersButton.addEventListener("click", function () {
                    let filterContainer = document.getElementById("filter-container");
                    if (filterContainer) {
                        filterContainer.classList.toggle("show-filters");
                        this.textContent = filterContainer.classList.contains("show-filters") ? "–°—Ö–æ–≤–∞—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏" : "–ü–æ–∫–∞–∑–∞—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏";
                    }
                });
            } else {
                console.warn("‚ö† –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (#toggle-filters) –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!");
            }
    
            if (filterForm) {
                filterForm.addEventListener("submit", function (e) {
                    e.preventDefault();
                    sendFilterRequest();
                });
            }
    
            if (resetFiltersButton) {
                resetFiltersButton.addEventListener("click", function () {
                    resetFilter();
                });
            }
            // ‚úÖ –ï—Å–ª–∏ –≤ URL –µ—Å—Ç—å —Ñ–∏–ª—å—Ç—Ä ‚Äî –∑–∞–ø—É—Å–∫–∞–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é —Å—Ä–∞–∑—É
            if (hasFilters) {
                sendFilterRequest();
            }
            
    
            // üîπ –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
            function sendFilterRequest() {
                if (!tableElement) {
                    console.error("‚ùå –¢–∞–±–ª–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!");
                    return;
                }
                let tablePk = tableElement.getAttribute("data-table-id");
            
                let filters = {};
                document.querySelectorAll("#filter-form input, #filter-form select").forEach(input => {
                    if (input.name !== "csrfmiddlewaretoken" && input.value.trim()) {
                        
                        let value = input.value.trim();

                         // –ï—Å–ª–∏ –ø–æ–ª–µ –µ—Å—Ç—å –≤ —Å–ª–æ–≤–∞—Ä–µ –ø–µ—Ä–µ–≤–æ–¥–∞, –∑–∞–º–µ–Ω—è–µ–º –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                        if (translations[input.name] && translations[input.name][value]) {
                        value = translations[input.name][value];
                        }

                        filters[input.name] = value;
                    }
                });

                
            
                // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ª–æ–≥ –≤ –∫–æ–Ω—Å–æ–ª—å
                console.log("üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä:", filters);
                // ‚úÖ –û–±–Ω–æ–≤–ª—è–µ–º URL –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∑–∞–ø—Ä–æ—Å–∞
                let queryParams = new URLSearchParams(filters).toString();
                let newUrl = window.location.pathname + "?" + queryParams;
                window.history.pushState({}, "", newUrl);
            
                fetch(`/clients/tables/filter-rows/${tablePk}/`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCSRFToken()
                    },
                    body: JSON.stringify(filters),
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`‚ùå –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        console.log("üìå –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥—É–±–ª–∏–∫–∞—Ç—ã:", data.duplicate_usernames, data.duplicate_phones);
                        applyFilter(data.data, data.duplicate_usernames || [], data.duplicate_phones || []);
                    } else {
                        console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:", data.error);
                    }
                })
                .catch(error => {
                    console.error("‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏:", error);
                });
            }
            
            // üîπ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞
            function applyFilter(rows, duplicateUsernames = [], duplicatePhones = []) {
                console.log("üìå –§–∏–ª—å—Ç—Ä –ø—Ä–∏–º–µ–Ω–µ–Ω, –Ω–∞–π–¥–µ–Ω–æ —Å—Ç—Ä–æ–∫:", rows.length);
            
                let countBlock = document.getElementById("filter-results-count");
                let countSpan = document.getElementById("filtered-count");
                let tableBody = document.querySelector("#table-body");
                let loadMoreBtn = document.getElementById("load-more-btn");
            
                // ‚úÖ –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫
                countSpan.textContent = rows.length;
                countBlock.style.display = rows.length > 0 ? "block" : "none";
            


                // ‚úÖ –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∏ –Ω–∞–π–¥–µ–Ω—ã, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
                if (rows.length > 0) {
                    countSpan.textContent = rows.length;
                    countBlock.classList.add("show");  // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–æ—è–≤–ª–µ–Ω–∏—è
                } else {
                    countBlock.classList.remove("show"); // –°–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫, –µ—Å–ª–∏ –∑–∞–ø–∏—Å–µ–π –Ω–µ—Ç
                }

                // ‚úÖ –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫ –±–æ–ª—å—à–µ 30, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü—ñ–¥–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —â–µ"
                if (rows.length > 30) {
                    loadMoreBtn.classList.add("show");
                } else {
                    loadMoreBtn.classList.remove("show");
                }
                // ‚úÖ –û—á–∏—â–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –ø–µ—Ä–µ–¥ –Ω–æ–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–æ–π
                tableBody.innerHTML = "";
            
                // ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
                window.allFilteredRows = rows;
                window.loadedRows = 0; // –°—á–µ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫

                // ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
                window.duplicateUsernames = duplicateUsernames;
                window.duplicatePhones = duplicatePhones;

                 // ‚úÖ –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫, —Å–∫–æ–ª—å–∫–æ –±—ã–ª–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –¥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                let rowsToLoadCount = Math.min(window.loadedRows, rows.length);
                rows.slice(0, rowsToLoadCount).forEach(row => {
                    addTableRow(row, duplicateUsernames, duplicatePhones);
                });
            
                // ‚úÖ –ó–∞–ø—É—Å–∫–∞–µ–º `rows.forEach()`, –Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–µ—Ä–≤—ã—Ö 30 —Å—Ç—Ä–æ–∫
                rows.slice(0, 30).forEach(row => {
                    addTableRow(row, duplicateUsernames, duplicatePhones);
                });
            
                // ‚úÖ –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫
                window.loadedRows = 30;
            
                // ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É, –µ—Å–ª–∏ —Å—Ç—Ä–æ–∫ –±–æ–ª—å—à–µ 30
                loadMoreBtn.style.display = rows.length > 30 ? "block" : "none";
            }
            

            document.getElementById("load-more-btn").addEventListener("click", function () {
                loadMoreRows(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –µ—â–µ 30 —Å—Ç—Ä–æ–∫
            });


            function addTableRow(row, duplicateUsernames, duplicatePhones) {
                let tableBody = document.querySelector("#table-body");
            
                let tr = document.createElement("tr");
                tr.setAttribute("data-row-id", row.pk);
            
                let tdId = document.createElement("td");
                tdId.textContent = row.pk;
                tr.appendChild(tdId);
            
                Object.keys(row.fields).forEach(field => {
                    let td = document.createElement("td");
                    let value = row.fields[field] || "-";
            
                    // ‚úÖ –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (Instagram, —Ç–µ–ª–µ—Ñ–æ–Ω)
                    if (field === "instagram_username" && duplicateUsernames.includes(value)) {
                        td.classList.add("duplicate");
                        let link = document.createElement("a");
                        link.href = row.fields["instagram_link"] || "#";
                        console.log(`üö® –î—É–±–ª–∏–∫–∞—Ç Instagram: ${value}`);
                    }
                    if (field === "phone_number" && duplicatePhones.includes(value)) {
                        td.classList.add("duplicate");
                        let link = document.createElement("a");
                        link.href = row.fields["phone_number"] || "#";
                        console.log(`üö® –î—É–±–ª–∏–∫–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞: ${value}`);
                    }
                     // ‚úÖ –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å—Å—ã–ª–∫–∏ Instagram
                    if (field === "instagram_username") {
                        let username = value;
                        let link = row.fields["instagram_link"] || "#";

                        let a = document.createElement("a");
                        a.href = link;
                        a.textContent = username || "-";
                        a.target = "_blank";
                        a.id = "a_class"; // ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º id –¥–ª—è —Å—Ç–∏–ª—è

                        td.appendChild(a);
                    } 

                    // ‚úÖ –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω (—á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –∑–≤–æ–Ω–∏—Ç—å)
                    if (field === "phone_number") {
                        let phone = value;

                        let a = document.createElement("a");
                        a.href = `tel:${phone}`; // ‚úÖ –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∫–ª–∏–∫–Ω—É—Ç—å –∏ –ø–æ–∑–≤–æ–Ω–∏—Ç—å
                        a.textContent = phone || "-";
                        a.id = "phone_link"; // ‚úÖ –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å id –¥–ª—è —Å—Ç–∏–ª—è

                        td.appendChild(a);
                    }
                   

            
                    // ‚úÖ –õ–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–µ–ª–µ–∫—Ç–æ–≤
                    if (["status", "contact", "priority"].includes(field)) {
                        let select = document.createElement("select");
                        select.classList.add("editable-select");
                        select.dataset.rowId = row.pk;
            
                        let options = {
                            "status": { "lead": "–õ—ñ–¥", "client": "–ö–ª—ñ—î–Ω—Ç", "customer": "–ó–∞–º–æ–≤–Ω–∏–∫" },
                            "contact": { "contact_1": "–ö–æ–Ω—Ç–∞–∫—Ç 1", "contact_2": "–ö–æ–Ω—Ç–∞–∫—Ç 2", "contact_3": "–ö–æ–Ω—Ç–∞–∫—Ç 3", "contact_4": "–ö–æ–Ω—Ç–∞–∫—Ç 4" },
                            "priority": { "low": "–ù–∏–∑—å–∫–∏–π", "medium": "–°–µ—Ä–µ–¥–Ω—ñ–π", "high": "–í–∏—Å–æ–∫–∏–π" }
                        };
            
                        Object.entries(options[field]).forEach(([value, label]) => {
                            let opt = document.createElement("option");
                            opt.value = value;
                            opt.textContent = label;
                            if (row.fields[field] === value) opt.selected = true;
                            select.appendChild(opt);
                        });
            
                        // ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è
                        select.addEventListener("change", function () {
                            updateField(row.pk, field, this.value);
                        });
            
                        td.appendChild(select);
                    }
                    

                    
                    // ‚úÖ –û–±—ã—á–Ω—ã–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è
                    // ‚úÖ –ï—Å–ª–∏ –Ω–µ Instagram, —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ —Å–µ–ª–µ–∫—Ç, –ø—Ä–æ—Å—Ç–æ –≤—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
                    if (!["instagram_username", "phone_number", "status", "contact", "priority"].includes(field)) {
                        td.textContent = value;
                    }

        
            
                    tr.appendChild(td);
                });
            
                // ‚úÖ –ö–Ω–æ–ø–∫–∏ "–†–µ–¥–∞–≥—É–≤–∞—Ç–∏" –∏ "–í–∏–¥–∞–ª–∏—Ç–∏"
                let tdActions = document.createElement("td");
                tdActions.innerHTML = `
                    <a href="/clients/tables/${document.getElementById("data-table").getAttribute("data-table-id")}/edit/${row.pk}/" class="btn-edit">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</a>
                    <button class="btn-delete" data-row-id="${row.pk}">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                `;
                tr.appendChild(tdActions);
            
                tableBody.appendChild(tr);
            }
            
            
            function loadMoreRows() {
                let tableBody = document.querySelector("#table-body");
                let loadMoreBtn = document.getElementById("load-more-btn");
            
                // ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –µ—â–µ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
                if (window.loadedRows >= window.allFilteredRows.length) {
                    loadMoreBtn.style.display = "none"; // ‚úÖ –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É, –µ—Å–ª–∏ –≤—Å—ë –∑–∞–≥—Ä—É–∂–µ–Ω–æ
                    return;
                }
            
                // ‚úÖ –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–µ 30 —Å—Ç—Ä–æ–∫
                let rowsToLoad = window.allFilteredRows.slice(window.loadedRows, window.loadedRows + 30);
            
                rowsToLoad.forEach(row => {
                    addTableRow(row, window.duplicateUsernames, window.duplicatePhones);  // ‚úÖ –ü–µ—Ä–µ–¥–∞—ë–º –í–°–ï –¥—É–±–ª–∏–∫–∞—Ç—ã
                });
            
                // ‚úÖ –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫
                window.loadedRows += rowsToLoad.length;
            
                // ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ `localStorage`
                localStorage.setItem("loadedRows", window.loadedRows);
            
                // ‚úÖ –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫ –±–æ–ª—å—à–µ –Ω–µ—Ç, —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                if (window.loadedRows >= window.allFilteredRows.length) {
                    loadMoreBtn.style.display = "none";
                }
            }
            
            


            // üîπ –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
            function resetFilter() {
                console.log("üîÑ –°–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–æ–≤...");

                // ‚úÖ –û—á–∏—â–∞–µ–º localStorage (—á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∂–∞–ª–æ—Å—å —Å –Ω—É–ª—è)
                localStorage.removeItem("loadedRows");
                
                // ‚úÖ –û—á–∏—â–∞–µ–º –≤—Å–µ –ø–æ–ª—è —Ñ–æ—Ä–º—ã
                document.querySelectorAll("#filter-form input, #filter-form select").forEach(input => input.value = "");
            
                // ‚úÖ –£–±–∏—Ä–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –∏–∑ URL
                window.history.replaceState({}, "", window.location.pathname);

                // ‚úÖ –°–∫—Ä—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫
                document.getElementById("filter-results-count").style.display = "none";
            
                // ‚úÖ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞
                location.reload();
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ —É–¥–∞–ª–µ–Ω–∏—è
            document.addEventListener("click", function (event) {
                if (event.target.classList.contains("btn-delete")) {
                    let rowId = event.target.dataset.rowId;
                    showDeleteModal(rowId); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                }
            });

            
            // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            function showDeleteModal(rowId) {
                let modal = document.getElementById("deleteModal");
                let confirmButton = document.getElementById("confirmDelete");
                let cancelButton = document.getElementById("cancelDelete");

                modal.style.display = "block"; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É

                // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                confirmButton.removeEventListener("click", confirmDeleteHandler);
                cancelButton.removeEventListener("click", hideDeleteModal);

                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
                function confirmDeleteHandler() {
                    deleteRow(rowId); // –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É
                    hideDeleteModal(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                }

                function hideDeleteModal() {
                    modal.style.display = "none"; // –°–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ
                }

                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
                confirmButton.addEventListener("click", confirmDeleteHandler);
                cancelButton.addEventListener("click", hideDeleteModal);
            }

            function deleteRow(rowId) {
                let tablePk = document.getElementById("data-table").getAttribute("data-table-id");
            
                fetch(`/clients/tables/${tablePk}/delete-row/${rowId}/`, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": getCSRFToken(),
                    },
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`‚ùå –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        console.log(`‚úÖ –ó–∞–ø–∏—Å—å ${rowId} —É–¥–∞–ª–µ–Ω–∞`);
            
                        // –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –∏–∑ DOM
                        let rowElement = document.querySelector(`tr[data-row-id="${rowId}"]`);
                        if (rowElement) {
                            rowElement.remove();
                        } else {
                            console.warn(`‚ö† –°—Ç—Ä–æ–∫–∞ —Å ID ${rowId} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ DOM!`);
                        }
                    } else {
                        console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏:", data.error);
                    }
                })
                .catch(error => console.error("‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏:", error));
            }
            
            
            
    
            // üîπ –ü–æ–ª—É—á–µ–Ω–∏–µ CSRF-—Ç–æ–∫–µ–Ω–∞
            function getCSRFToken() {
                let csrfToken = null;
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    cookie = cookie.trim();
                    if (cookie.startsWith('csrftoken=')) {
                        csrfToken = cookie.substring('csrftoken='.length);
                    }
                }
                if (!csrfToken) {
                    console.error("‚ö† CSRF-—Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω!");
                }
                return csrfToken;
            }
        });
    </script>
    
<script>
    document.getElementById("upload-form").addEventListener("submit", function(event) {
        event.preventDefault(); // ‚ùå –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã
    
        let formData = new FormData(this);
        let tableId = document.getElementById("data-table").dataset.tableId;
    
        console.log("üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª:", formData.get("file"));
    
        let startTime = Date.now();
    
        fetch(`/clients/tables/${tableId}/upload-excel/`, {
            method: "POST",
            body: formData,
            headers: {
                "X-CSRFToken": getCSRFToken()
            }
        })
        .then(response => response.json()) // ‚úÖ –¢–µ–ø–µ—Ä—å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º JSON-–æ—Ç–≤–µ—Ç
        .then(data => {
            console.log("‚úÖ JSON-–¥–∞–Ω–Ω—ã–µ:", data);
    
            if (data.success) {
                // ‚úÖ –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
               
                document.getElementById("total-rows").textContent = data.total_rows;
                
                document.getElementById("uploaded-rows").textContent = data.uploaded_rows;
                document.getElementById("updated-rows").textContent = Math.max(0, data.updated_rows);
                document.getElementById("deleted-rows").textContent = Math.max(0, data.deleted_rows);
                document.getElementById("processing-time").textContent = `${((Date.now() - startTime) / 1000).toFixed(2)} —Å–µ–∫.`;
                document.getElementById("upload-time").textContent = new Date().toLocaleString("uk-UA");

    
                alert("‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!");
            } else {
                alert("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + data.error);
            }
        })
        .catch(error => {
            console.error("‚ùå –û—à–∏–±–∫–∞:", error);
            alert("‚ö† –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + error.message);
        });
    });
        
    
    
    function resolveDuplicate(existing_id, new_data, action) {
        let payload = {
            existing_id: existing_id,
            new_data: new_data ? JSON.parse(decodeURIComponent(new_data)) : null, // ‚úÖ –î–µ–∫–æ–¥–∏—Ä—É–µ–º –∏ –ø–∞—Ä—Å–∏–º JSON
            action: action
        };
    
        let tableId = document.getElementById("data-table").dataset.tableId; // ‚úÖ –ü–æ–ª—É—á–∞–µ–º table.id
    
        fetch(`/clients/tables/${tableId}/resolve-duplicate/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCSRFToken()
            },
            body: JSON.stringify(payload)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error("‚ùå –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É: " + response.status);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert("‚úÖ –î—É–±–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω!");
                location.reload(); // üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
            } else {
                alert("‚ùå –ü–æ–º–∏–ª–∫–∞: " + data.error);
            }
        })
        .catch(error => console.error("‚ùå –û—à–∏–±–∫–∞:", error));
    }
    
    function getCSRFToken() {
        return document.querySelector("input[name='csrfmiddlewaretoken']").value;
    }
</script>




 <!--–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫ –ø–æ –≥–ª–æ–±–∞–ª—å–Ω–æ–º—É –ø–æ–∏—Å–∫—É-->
 <script>
    document.addEventListener("DOMContentLoaded", function () {
        console.log("üìå DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞...");
    
        const searchInput = document.getElementById("search");
        const tableBody = document.getElementById("table-body");
        const tableElement = document.getElementById("data-table");
        const loadMoreBtn = document.getElementById("load-more-btn");
        


        
    
        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        const deleteModal = document.getElementById("deleteModal");
        const confirmDeleteBtn = document.getElementById("confirmDelete");
        const cancelDeleteBtn = document.getElementById("cancelDelete");
    
        let deleteRowId = null; // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è ID —Å—Ç—Ä–æ–∫–∏, –∫–æ—Ç–æ—Ä—É—é –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å
    
        if (!searchInput || !tableBody || !tableElement || !loadMoreBtn) {
            console.error("‚ùå –û–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã! –ü—Ä–æ–≤–µ—Ä—å ID –≤ HTML.");
            return;
        }
    
        let tablePk = tableElement.getAttribute("data-table-id");
        let wasTyped = false; // –§–ª–∞–≥, –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—â–∏–π, –≤–≤–æ–¥–∏–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —á—Ç–æ-—Ç–æ
        searchInput.addEventListener("input", function () {
            let query = this.value.trim();
            if (query.length > 0) {
                wasTyped = true; // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–µ–ª –¥–∞–Ω–Ω—ã–µ
            }
        
            if (wasTyped && query.length === 0) {
                location.reload(); // üîÑ –ï—Å–ª–∏ –ø–æ–ª–µ —Å—Ç–∞–ª–æ –ø—É—Å—Ç—ã–º –ø–æ—Å–ª–µ –≤–≤–æ–¥–∞ ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
                return;
            }
        
            if (query.length < 2) return;

                    // **–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì –∏–ª–∏ –î–î.–ú–ú.–ì–ì–ì–ì –ß–ß:–ú–ú**
            let dateRegex = /^(\d{2})\.(\d{2})\.(\d{4})(?:\s+(\d{2}):(\d{2}))?$/;
            let match = query.match(dateRegex);
            let requestData = { search: query };

            if (match) {
                let day = match[1];
                let month = match[2];
                let year = match[3];
                let hours = match[4] || "00"; // –ï—Å–ª–∏ –Ω–µ—Ç –≤—Ä–µ–º–µ–Ω–∏, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º 00:00
                let minutes = match[5] || "00";

                let formattedDate = `${year}-${month}-${day}T${hours}:${minutes}`;
                console.log("üìÖ –ù–∞–π–¥–µ–Ω–∞ –¥–∞—Ç–∞:", formattedDate);

                requestData = { date_search: formattedDate };
            }
        
    
            fetch(`/clients/tables/all-filter-rows/${tablePk}/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken(),
                },
                body: JSON.stringify({ search: query }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log("üìå –ù–∞–π–¥–µ–Ω–æ —Å—Ç—Ä–æ–∫:", data.data.length);
                    updateTable(data.data, data.duplicate_usernames || [], data.duplicate_phones || []);
                } else {
                    console.error("‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:", data.error);
                }
            })
            .catch(error => console.error("‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏:", error));
        });



        function deleteRow(rowId) {
            fetch(`/clients/tables/${tablePk}/delete-row/${rowId}/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCSRFToken()
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error("‚ùå –°–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä–Ω—É–≤ –ø–æ–º–∏–ª–∫—É: " + response.status);
                }
                return response.json(); // ‚úÖ –û–∂–∏–¥–∞–µ–º JSON, –Ω–µ HTML
            })
            .then(data => {
                if (data.success) {
                    console.log(`‚úÖ –†—è–¥–æ–∫ ${rowId} —É—Å–ø—ñ—à–Ω–æ –≤–∏–¥–∞–ª–µ–Ω–æ.`);
                    document.querySelector(`tr[data-row-id="${rowId}"]`).remove(); // –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –∏–∑ DOM
    
                    // –ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –ù–ï —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä, –∞ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü–µ
                    if (searchInput.value.trim().length >= 2) {
                        searchInput.dispatchEvent(new Event('input'));
                    }
                } else {
                    console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ:", data.error);
                }
            })
            .catch(error => console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ:", error));
        }
    
        function activateDeleteButtons() {
            document.querySelectorAll(".btn-delete").forEach(button => {
                button.addEventListener("click", function () {
                    deleteRowId = this.dataset.rowId;
                    deleteModal.classList.add("show"); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                });
            });
        }
    
        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è
        confirmDeleteBtn.addEventListener("click", function () {
            if (deleteRowId) {
                deleteRow(deleteRowId);
            }
            deleteModal.classList.remove("show");
        });

    
        // –û—Ç–º–µ–Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è
        cancelDeleteBtn.addEventListener("click", function () {
            deleteModal.classList.remove("show");
        });
    
        function updateTable(rows, duplicateUsernames, duplicatePhones) {
            tableBody.innerHTML = "";
    
            window.allFilteredRows = rows;
            window.loadedRows = 0;
            window.duplicateUsernames = duplicateUsernames;
            window.duplicatePhones = duplicatePhones;
    
            let rowsToLoad = rows.slice(0, 30);
            rowsToLoad.forEach(row => addTableRow(row));
    
            window.loadedRows = rowsToLoad.length;
            loadMoreBtn.style.display = rows.length > 30 ? "block" : "none";

            activateDeleteButtons(); // ‚úÖ –ü–æ–¥–∫–ª—é—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É —É–¥–∞–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        }
        activateDeleteButtons(); // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    
        function addTableRow(row) {
            let tr = document.createElement("tr");
            tr.setAttribute("data-row-id", row.pk);
    
            let tdId = document.createElement("td");
            tdId.textContent = row.pk;
            tr.appendChild(tdId);
    
            Object.keys(row.fields).forEach(field => {
                let td = document.createElement("td");
                let value = row.fields[field] || "-";
    
                // ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –º–∞—Å—Å–∏–≤—ã, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –æ—à–∏–±–∫–∏
                if (!window.duplicateUsernames) window.duplicateUsernames = [];
                if (!window.duplicatePhones) window.duplicatePhones = [];
    
                // ‚úÖ –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ Instagram
                if (field === "instagram_username") {
                    let a = document.createElement("a");
                    a.href = row.fields["instagram_link"] || "#";
                    a.textContent = value || "-";
                    a.target = "_blank";
                    a.id = "a_class"; // ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω id

                    if (window.duplicateUsernames.includes(value)) {
                        td.classList.add("duplicate");
                        console.log(`üö® –î—É–±–ª–∏–∫–∞—Ç Instagram: ${value}`);
                    }

                    td.appendChild(a);
                }
                // ‚úÖ –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –¢–µ–ª–µ—Ñ–æ–Ω–æ–≤
                else if (field === "phone_number") {
                    let a = document.createElement("a");
                    a.href = `tel:${value}`;
                    a.textContent = value || "-";
                    a.classList.add("phone-link");

                    if (window.duplicatePhones.includes(value)) {
                        td.classList.add("duplicate");
                        console.log(`üö® –î—É–±–ª–∏–∫–∞—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞: ${value}`);
                    }

                    td.appendChild(a);
                }
                // ‚úÖ –í—ã–±–æ—Ä –∏–∑ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
                else if (["status", "contact", "priority"].includes(field)) {
                    let select = document.createElement("select");
                    select.classList.add("editable-select");
                    select.dataset.rowId = row.pk;
    
                    let options = {
                        "status": { "lead": "–õ—ñ–¥", "client": "–ö–ª—ñ—î–Ω—Ç", "customer": "–ó–∞–º–æ–≤–Ω–∏–∫" },
                        "contact": { "contact_1": "–ö–æ–Ω—Ç–∞–∫—Ç 1", "contact_2": "–ö–æ–Ω—Ç–∞–∫—Ç 2", "contact_3": "–ö–æ–Ω—Ç–∞–∫—Ç 3", "contact_4": "–ö–æ–Ω—Ç–∞–∫—Ç 4" },
                        "priority": { "low": "–ù–∏–∑—å–∫–∏–π", "medium": "–°–µ—Ä–µ–¥–Ω—ñ–π", "high": "–í–∏—Å–æ–∫–∏–π" }
                    };
    
                    Object.entries(options[field]).forEach(([value, label]) => {
                        let opt = document.createElement("option");
                        opt.value = value;
                        opt.textContent = label;
                        if (row.fields[field] === value) opt.selected = true;
                        select.appendChild(opt);
                    });
    
                    select.addEventListener("change", function () {
                        updateField(row.pk, field, this.value);
                    });
    
                    td.appendChild(select);
                }
                // ‚úÖ –û–±—ã—á–Ω—ã–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è
                else {
                    td.textContent = value;
                }
    
                tr.appendChild(td);
            });
    
            // ‚úÖ –ö–Ω–æ–ø–∫–∏ "–†–µ–¥–∞–≥—É–≤–∞—Ç–∏" –∏ "–í–∏–¥–∞–ª–∏—Ç–∏"
            let tdActions = document.createElement("td");
            tdActions.innerHTML = `
                <a href="/clients/tables/${tablePk}/edit/${row.pk}/" class="btn-edit">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</a>
                <button class="btn-delete" data-row-id="${row.pk}">–í–∏–¥–∞–ª–∏—Ç–∏</button>
            `;
            tr.appendChild(tdActions);
    
            tableBody.appendChild(tr);
        }
    
        // üîπ –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å—Ç—Ä–æ–∫
        loadMoreBtn.addEventListener("click", function () {
            let rowsToLoad = window.allFilteredRows.slice(window.loadedRows, window.loadedRows + 30);
            rowsToLoad.forEach(row => addTableRow(row));
    
            window.loadedRows += rowsToLoad.length;
            if (window.loadedRows >= window.allFilteredRows.length) {
                loadMoreBtn.style.display = "none";
            }
        });
    
        // üîπ –ü–æ–ª—É—á–µ–Ω–∏–µ CSRF-—Ç–æ–∫–µ–Ω–∞
        function getCSRFToken() {
            let csrfToken = null;
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith('csrftoken=')) {
                    csrfToken = cookie.substring('csrftoken='.length);
                }
            }
            return csrfToken;
        }
    });
    
</script>

    
    

    
    <style>
        .hidden-row {
            display: none !important;
        }
    </style>
</body>
</html>