{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ table.name }} - –°–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫</title>
    <link rel="stylesheet" href="{% static 'css/tablelist.css' %}">
</head>
<body>
    <h1>–°–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫ —Ç–∞–±–ª–∏—Ü—ñ: {{ table.name }}</h1>

    <!-- –§–∏–ª—å—Ç—Ä -->
    <button class="filter-toggle-btn" id="toggle-filters">–ü–æ–∫–∞–∑–∞—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏</button>
    <div id="filter-container" class="filter-container">
        <h3>–§—ñ–ª—å—Ç—Ä</h3>
        <form id="filter-form" method="POST">
            {% csrf_token %}
    
            <!-- –û—Å—Ç–∞–≤—à–∏–µ—Å—è —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –∏ –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã -->
            {% for field in visible_fields %}
                {% if field.name not in "last_updated inquiry_date due_date record_date" %}
                    <div class="filter-group">
                        <label for="filter-{{ field.name }}">{{ field.label }}</label>
                        {% if field.name in allowed_fields %}
                            <select id="filter-{{ field.name }}" name="{{ field.name }}" class="filter-dropdown">
                                <option value="">–í—Å—ñ</option>
                                {% for value in choices|get_item:field.name %}
                                    <option value="{{ value }}">{{ value }}</option>
                                {% endfor %}
                            </select>
                        {% else %}
                            <input type="text" id="filter-{{ field.name }}" name="{{ field.name }}" placeholder="–í–≤–µ–¥—ñ—Ç—å –∑–Ω–∞—á–µ–Ω–Ω—è">
                        {% endif %}
                    </div>
                {% endif %}
                <!-- –ü–æ–ª–µ "–î–∞—Ç–∞ –ø–æ—á–∞—Ç–∫—É" -->
            {% endfor %}
            <div class="filter-group">
                <label for="filter-start_datetime">–î–∞—Ç–∞ –ø–æ—á–∞—Ç–∫—É</label>
                <input type="datetime-local" id="filter-start_datetime" name="start_datetime">
            </div>
    
            <!-- –ü–æ–ª–µ "–î–∞—Ç–∞ –∫—ñ–Ω—Ü—è" -->
            <div class="filter-group">
                <label for="filter-end_datetime">–î–∞—Ç–∞ –∫—ñ–Ω—Ü—è</label>
                <input type="datetime-local" id="filter-end_datetime" name="end_datetime">
            </div>
            <div class="filter-buttons">
                <button class="filter-start" type="submit">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä</button>
                <button class="filter-stop" type="button" id="reset-filters">–°–∫–∏–Ω—É—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏</button>
            </div>
        </form>
    </div>


    <!-- –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
    <div class="actions">
        <a href="{% url 'add_row' table.id %}" class="btn-add">–î–æ–¥–∞—Ç–∏ —Ä—è–¥–æ–∫</a>
        <a href="{% url 'custom_table_list' %}" class="btn-back">–ù–∞–∑–∞–¥ –¥–æ —Ç–∞–±–ª–∏—Ü—å</a>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ —Å—Ç—Ä–æ–∫ -->
    <table id="data-table" data-table-id="{{ table.id }}">
        <thead>
            <tr>
                <th>ID</th>
                {% for field in visible_fields %}
                    <th>{{ field.label }}</th> <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã –∏–∑ FIELD_TRANSLATIONS -->
                {% endfor %}
                <th>–î—ñ—ó</th>
            </tr>
        </thead>
        <tbody id="table-body">
            {% for row in rows %}
            <tr data-row-id="{{ row.id }}">
                <td>{{ row.id }}</td>
                {% for field in visible_fields %}
                    <td class="
                        {% if field.name == 'phone_number' and row.additional_data|get_item:'phone_number' in duplicate_phones %}duplicate{% endif %}
                        {% if field.name == 'instagram_username' and row.additional_data|get_item:'instagram_username' in duplicate_usernames %}duplicate{% endif %}
                    ">
                        {% if field.name == 'contact' %}
                            <select class="editable-select contact-select" data-row-id="{{ row.id }}">
                                <option value="contact_1" {% if row.contact == 'contact_1' %}selected{% endif %}>–ö–æ–Ω—Ç–∞–∫—Ç 1</option>
                                <option value="contact_2" {% if row.contact == 'contact_2' %}selected{% endif %}>–ö–æ–Ω—Ç–∞–∫—Ç 2</option>
                                <option value="contact_3" {% if row.contact == 'contact_3' %}selected{% endif %}>–ö–æ–Ω—Ç–∞–∫—Ç 3</option>
                                <option value="contact_4" {% if row.contact == 'contact_4' %}selected{% endif %}>–ö–æ–Ω—Ç–∞–∫—Ç 4</option>
                            </select>
                        {% elif field.name == 'status' %}
                            <select class="editable-select status-select" data-row-id="{{ row.id }}">
                                <option value="lead" {% if row.status == 'lead' %}selected{% endif %}>–õ—ñ–¥</option>
                                <option value="client" {% if row.status == 'client' %}selected{% endif %}>–ö–ª—ñ—î–Ω—Ç</option>
                                <option value="customer" {% if row.status == 'customer' %}selected{% endif %}>–ó–∞–º–æ–≤–Ω–∏–∫</option>
                            </select>
                        {% elif field.name == 'priority' %}
                            <select class="editable-select priority-select" data-row-id="{{ row.id }}">
                                <option value="low" {% if row.priority == 'low' %}selected{% endif %}>–ù–∏–∑—å–∫–∏–π</option>
                                <option value="medium" {% if row.priority == 'medium' %}selected{% endif %}>–°–µ—Ä–µ–¥–Ω—ñ–π</option>
                                <option value="high" {% if row.priority == 'high' %}selected{% endif %}>–í–∏—Å–æ–∫–∏–π</option>
                            </select>
                        {% elif field.name == 'change_status_contact' %}
                            <select class="editable-select change-status-contact-select" data-row-id="{{ row.id }}">
                                <option value="contact_1" {% if row.change_status_contact == 'contact_1' %}selected{% endif %}>–ö–æ–Ω—Ç–∞–∫—Ç 1</option>
                                <option value="contact_2" {% if row.change_status_contact == 'contact_2' %}selected{% endif %}>–ö–æ–Ω—Ç–∞–∫—Ç 2</option>
                                <option value="contact_3" {% if row.change_status_contact == 'contact_3' %}selected{% endif %}>–ö–æ–Ω—Ç–∞–∫—Ç 3</option>
                                <option value="contact_4" {% if row.change_status_contact == 'contact_4' %}selected{% endif %}>–ö–æ–Ω—Ç–∞–∫—Ç 4</option>
                            </select>
                            
                        {% elif field.name == 'deal_amount' %}
                            {{ row.deal_amount }} {{ row.deal_amount_currency }}
                        {% elif field.name == 'paid_amount' %}
                            {{ row.paid_amount }} {{ row.paid_amount_currency }}
                        {% elif field.name == 'expected_profit' %}
                            {{ row.expected_profit }} {{ row.expected_profit_currency }}
                        {% elif field.name == 'instagram_username' %}
                            {% with username=row.additional_data|get_item:'instagram_username' link=row.additional_data|get_item:'instagram_link' %}
                                {% if username and link %}
                                    <a href="{{ link }}" target="_blank">{{ username }}</a>
                                {% else %}
                                    {{ username|default:"-" }}
                                {% endif %}
                            {% endwith %}

                        {% elif field.name == 'updated_by' %}
                            {{ row.updated_by_names|default:"-" }}  <!-- ‚úÖ –ü—Ä–æ—Å—Ç–æ –≤—ã–≤–æ–¥–∏–º –Ω–∏–∫–Ω–µ–π–º—ã -->
                            

                        {% elif field.name == 'phone_number' %}
                            {% with phone=row.additional_data|get_item:'phone_number' %}
                                {% if phone %}
                                    <a href="tel:{{ phone }}">{{ phone }}</a>
                                {% else %}
                                    {{ phone|default:"-" }}
                                {% endif %}
                            {% endwith %}

                        {% else %}
                            {{ row.additional_data|get_item:field.name|default:"-" }}
                        {% endif %}
                    </td>
                {% endfor %}
                <td>
                    <a href="{% url 'edit_row' table.id row.id %}" class="btn-edit">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</a>
                    <button class="btn-delete" data-row-id="{{ row.id }}">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="{{ visible_fields|length|add:'1' }}">–î–∞–Ω—ñ –≤—ñ–¥—Å—É—Ç–Ω—ñ</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- JavaScript -->
    <script>
        // –ü–æ–ª—É—á–µ–Ω–∏–µ CSRF-—Ç–æ–∫–µ–Ω–∞
        function getCSRFToken() {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith('csrftoken=')) {
                    return cookie.substring('csrftoken='.length);
                }
            }
            return '';
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞
        document.querySelectorAll('.contact-select').forEach(select => {
            select.addEventListener('change', function () {
                const rowId = this.dataset.rowId;
                const contactValue = this.value;

                fetch(`/clients/tables/update-contact/${rowId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({ contact: contactValue })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('–ö–æ–Ω—Ç–∞–∫—Ç –æ–±–Ω–æ–≤–ª–µ–Ω!');
                        if (data.auto_status_change) {
                            document.querySelector(`.status-select[data-row-id="${rowId}"]`).value = 'client';
                        }
                    } else {
                        alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–∞.');
                    }
                })
                .catch(error => console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error));
            });
        });

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        document.querySelectorAll('.status-select').forEach(select => {
            select.addEventListener('change', function () {
                const rowId = this.dataset.rowId;
                const statusValue = this.value;

                fetch(`/clients/tables/update-status/${rowId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({ status: statusValue })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω!');
                    } else {
                        alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞.');
                    }
                })
                .catch(error => console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error));
            });
        });

        // –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏
        document.querySelectorAll('.btn-delete').forEach(button => {
            button.addEventListener('click', function () {
                const rowId = this.dataset.rowId;
                if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–æ–∫—É —Å ID ${rowId}?`)) {
                    fetch(`/clients/tables/{{ table.id }}/delete-row/${rowId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCSRFToken()
                        }
                    })
                    .then(response => {
                        if (response.ok) {
                            document.querySelector(`tr[data-row-id="${rowId}"]`).remove();
                        } else {
                            alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏.');
                        }
                    })
                    .catch(error => console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error));
                }
            });
        });
    </script>
    <script>
        // –ü–æ–ª—É—á–µ–Ω–∏–µ CSRF-—Ç–æ–∫–µ–Ω–∞
        function getCSRFToken() {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith('csrftoken=')) {
                    return cookie.substring('csrftoken='.length);
                }
            }
            return '';
        }
    
        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª–µ–π (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è)
        function updateField(rowId, fieldName, value) {
            fetch(`/clients/tables/update-field/${rowId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({ field: fieldName, value: value })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`${data.message}`);
    
                    // ‚úÖ –ï—Å–ª–∏ –∫–æ–Ω—Ç–∞–∫—Ç == —Å—Ç–∞—Ç—É—Å—É –∫–æ–Ω—Ç–∞–∫—Ç–∞, —Å—Ç–∞—Ç—É—Å –º–µ–Ω—è–µ–º –Ω–∞ client
                    if (data.auto_status_change) {
                        document.querySelector(`.status-select[data-row-id="${rowId}"]`).value = 'client';
                    }
                } else {
                    alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.');
                }
            })
            .catch(error => console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error));
        }
    
        // –í–µ—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –≤—Å–µ –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏
        document.querySelectorAll('.editable-select').forEach(select => {
            select.addEventListener('change', function () {
                const rowId = this.dataset.rowId;
                const fieldName = this.classList.contains('contact-select') ? 'contact'
                    : this.classList.contains('status-select') ? 'status'
                    : this.classList.contains('priority-select') ? 'priority'
                    : this.classList.contains('change-status-contact-select') ? 'change_status_contact'
                    : null;
    
                if (fieldName) {
                    updateField(rowId, fieldName, this.value);
                }
            });
        });
    </script>
     <!-- JavaScript -->
     <script>
        document.getElementById("toggle-filters").addEventListener("click", function () {
            let filterContainer = document.getElementById("filter-container");
            if (filterContainer.classList.contains("show-filters")) {
                filterContainer.classList.remove("show-filters");
                this.textContent = "–ü–æ–∫–∞–∑–∞—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏"; // –ú–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
            } else {
                filterContainer.classList.add("show-filters");
                this.textContent = "–°—Ö–æ–≤–∞—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏"; // –ú–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
            }
        });
        
        document.getElementById("filter-form").addEventListener("submit", function (e) {
            e.preventDefault();
            fetchFilteredData();
        });
        
        document.getElementById("reset-filters").addEventListener("click", function () {
            resetFilter();
        });
        
        function fetchFilteredData() {
            let tableElement = document.getElementById("data-table");
            if (!tableElement) {
                console.error("–û—à–∏–±–∫–∞: —ç–ª–µ–º–µ–Ω—Ç #data-table –Ω–µ –Ω–∞–π–¥–µ–Ω!");
                return;
            }
        
            let tablePk = tableElement.getAttribute("data-table-id");
            let formData = {};
        
            document.querySelectorAll("#filter-form input, #filter-form select").forEach(input => {
                if (input.value && input.name !== "csrfmiddlewaretoken") {  // ‚úÖ –ò—Å–∫–ª—é—á–∞–µ–º CSRF-—Ç–æ–∫–µ–Ω
                    formData[input.name] = input.value;
                }
            });
        
            console.log("–û—Ç–ø—Ä–∞–≤–ª—è–µ–º JSON:", JSON.stringify(formData));
        
            fetch(`/clients/tables/filter-rows/${tablePk}/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken()  // ‚úÖ CSRF-—Ç–æ–∫–µ–Ω –ø–µ—Ä–µ–¥–∞–µ–º —Ç–æ–ª—å–∫–æ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ!
                },
                body: JSON.stringify(formData),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    applyFilter(data.data);
                } else {
                    console.error("–û—à–∏–±–∫–∞:", data.error);
                }
            })
            .catch(error => console.error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:", error));
        }
        
        
        function applyFilter(rows) {
            let allRows = document.querySelectorAll("tbody tr");
            let visibleIds = rows.map(row => String(row.pk));  // –ü—Ä–∏–≤–æ–¥–∏–º –∫ —Å—Ç—Ä–æ–∫–µ
        
            allRows.forEach(tr => {
                let rowId = tr.getAttribute("data-row-id");
                if (rowId) {
                    if (visibleIds.includes(rowId)) {
                        tr.classList.remove("hidden-row"); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É
                    } else {
                        tr.classList.add("hidden-row"); // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É
                    }
                }
            });
        }
        
        function resetFilter() {
            let allRows = document.querySelectorAll("tbody tr");
            allRows.forEach(tr => tr.classList.remove("hidden-row")); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –æ–±—Ä–∞—Ç–Ω–æ
            document.querySelectorAll("#filter-form input, #filter-form select").forEach(input => input.value = "");
            
            fetchFilteredData(); // üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        }
        
    </script>
    
    <style>
        .hidden-row {
            display: none !important;
        }
    </style>
</body>
</html>