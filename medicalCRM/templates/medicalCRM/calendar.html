{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞–ª–µ–Ω–¥–∞—Ä—å –∑–∞–ø–∏—Å–µ–π</title>
    <meta name="csrf-token" content="{{ csrf_token }}">
    <!-- <link rel="stylesheet" href="https://uicdn.toast.com/calendar/latest/toastui-calendar.min.css" /> -->

    <link rel="stylesheet" href="{% static 'css/toastui-calendar.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/custom-calendar.css' %}">


    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f8f9fa;
            margin: 20px;
        }
        h1 { font-size: 24px; }
        #calendar { width: 90%; height: 700px; margin: auto; border: 1px solid #ccc; border-radius: 10px; background: white; }
        .controls { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
        button { padding: 10px 15px; font-size: 16px; cursor: pointer; border: none; background: #bb0000; color: white; border-radius: 5px; }
        button:hover { background:rgba(187, 0, 0, 0.46); }
        .modal { display: none; position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 5px; box-shadow: 0px 0px 10px rgba(0,0,0,0.5); width: 400px; }
        .modal.active { display: block; }
        select, input { width: 100%; margin-top: 5px; padding: 8px; }
    </style>
</head>
<body>
    <h1>–ö–∞–ª–µ–Ω–¥–∞—Ä—å –∑–∞–ø–∏—Å–µ–π</h1>

    <div class="controls">
        <button data-nav="prev">‚¨Ö –ù–∞–∑–∞–¥</button>
        <button data-nav="next">–í–ø–µ—Ä–µ–¥ ‚û°</button>
        <button data-view="day">–î–µ–Ω—å</button>
        <button data-view="week">–ù–µ–¥–µ–ª—è</button>
        <button data-view="month">–ú–µ—Å—è—Ü</button>
        <button data-action="reload">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>

    <div class="Block_max_content">
        <div class="navigation-buttons">
            <button onclick="window.location.href='/page1'">–ö–ª–∏–Ω–∏–∫–∞</button>
            <button onclick="window.location.href='/page2'">–°—Ç–∞—Ü–∏–æ–Ω–∞—Ä</button>
            <button onclick="window.location.href='/page3'">–ü–∞—Ä–∫–æ–≤–∫–∞</button>
            <button onclick="window.location.href='/page4'">–ó–∞–¥–∞—á–∏</button>
            <button onclick="window.location.href='/page5'">–°–æ–±—ã—Ç–∏—è</button>
        </div>
    <div id="calendar"></div>

    <div class="filtersBLOCK">
        <h1>–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –≤–∏–∑–∏—Ç–æ–≤</h1>

        <div class="filters-container" id="filtersContainer">
            <!-- –§–∏–ª—å—Ç—Ä—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ -->
        </div>
        
        <button id="applyFiltersBtn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
    </div>
    <div id="filteredVisitsContainer">
        <!-- –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–∏–∑–∏—Ç—ã –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
    </div>
    
    </div>
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤–∏–∑–∏—Ç–µ -->
<div id="visitDetailsModal" class="modal">
    <h2>üìå –ó–∞–ø–∏—Å—å –Ω–∞ –≤–∏–∑–∏—Ç</h2>
    <div id="visitDetails">
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∏–∑–∏—Ç–µ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è —Å—é–¥–∞ -->
    </div>
    <div id="visitFILTRActions—ñ" class="unique-visit-actions">
        <button class="visit-action-btn edit-visit-btn" onclick="openEditModal(visitId)">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        <button class="visit-action-btn close-visit-btn" onclick="closeVisitDetailsModal()">‚ùå –ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

</div>
    






    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏ -->
    <div id="modal" class="modal">
        <h2>–°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å</h2>
        <div id="error-message" class="error"></div>
        <label>–ü–∞—Ü–∏–µ–Ω—Ç:
            <select id="patientSelect"></select>
        </label>
        <label>–í—Ä–∞—á:
            <select id="doctorSelect"></select>
        </label>
        <label>–ú–µ–¥—Å–µ—Å—Ç—Ä–∞:
            <select id="nurseSelect"></select>
        </label>
        <label>–î–∞—Ç–∞ –≤–∏–∑–∏—Ç–∞:
            <input type="date" id="visitDate">
        </label>
        <label>–í—Ä–µ–º—è –≤–∏–∑–∏—Ç–∞:
            <input type="time" id="visitTime">
        </label>

        <label>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–∏–∑–∏—Ç–∞:
            <select id="durationSelect">
                <option value="5">5 –º–∏–Ω—É—Ç</option>
                <option value="10">10 –º–∏–Ω—É—Ç</option>
                <option value="15">15 –º–∏–Ω—É—Ç</option>
                <option value="20">20 –º–∏–Ω—É—Ç</option>
                <option value="30">30 –º–∏–Ω—É—Ç</option>
                <option value="45">45 –º–∏–Ω—É—Ç</option>
                <option value="50">50 –º–∏–Ω—É—Ç</option>
                <option value="55">55 –º–∏–Ω—É—Ç</option>
                <option value="60">1 —á–∞—Å</option>
                <option value="custom">–ë–æ–ª–µ–µ...</option>
            </select>
        </label>

        <label>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –≤–∏–∑–∏—Ç–∞:
            <input type="date" id="visitEndDate" name="visit_end_date">
        </label>

        <label>–û–∫–æ–Ω—á–∞–Ω–∏–µ –≤–∏–∑–∏—Ç–∞:
            <input type="time" id="visitEndTime" disabled>
        </label>

        <div>
            <label>–ü–æ–∏—Å–∫ —É—Å–ª—É–≥–∏:</label>
            <input type="text" id="serviceSearch" placeholder="üîé –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ, –∫–æ–¥..." oninput="filterServices()">
        </div>
        
        <div class="service-selection-container">
            <div class="service-list">
                <h3>–î–æ—Å—Ç—É–ø–Ω—ã–µ —É—Å–ª—É–≥–∏</h3>
                <ul id="availableServices"></ul>
            </div>
        
            <div class="selected-service-list">
                <h3>–í—ã–±—Ä–∞–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏</h3>
                <ul id="selectedServices"></ul>
            </div>
        </div>
        <input type="hidden" id="selectedServiceIds" name="selected_services">

        <label>–°–∫–∏–¥–∫–∞ (% –Ω–∞ –≤—Å–µ —É—Å–ª—É–≥–∏ –∏–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ):
            <input type="number" id="discountPercent" min="0" max="100" step="0.1" value="0">
        </label>

        
        
        <label>–§–∏–ª–∏–∞–ª:
            <select id="branchSelect" onchange="updateRooms('branchSelect', 'roomSelect')"></select>
        </label>
        
        <label>–ö–∞–±–∏–Ω–µ—Ç:
            <select id="roomSelect"></select>
        </label>

        <label>–û–ø–∏—Å–∞–Ω–∏–µ:
            <textarea id="description" rows="3"></textarea>
        </label>
        <label>–°—Ç–∞—Ç—É—Å:
            <select id="statusSelect">
                <option value="pending">–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</option>
                <option value="paid">–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞</option>
                <option value="completed">–ü—Ä–æ–≤–µ–¥–µ–Ω–æ</option>
                <option value="paid_finish">–û–ø–ª–∞—á–µ–Ω–æ</option>
            </select>
        </label>
        <label>–û–Ω–ª–∞–π–Ω –ø—Ä–∏–µ–º:
            <input type="checkbox" id="isOnline">
        </label>


        <label>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:
            <input type="number" id="finalPrice" step="0.01" readonly>
        </label>
        
        <button id="createVisitBtn">–°–æ–∑–¥–∞—Ç—å</button>
        <button onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
        
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∏–∑–∏—Ç–∞ -->
<div id="editModal" class="modal">
    <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∏–∑–∏—Ç–∞</h2>
    <div id="edit-error-message" class="error"></div>

    <label>–ü–∞—Ü–∏–µ–Ω—Ç:
        <select id="editPatientSelect"></select>
    </label>
    <label>–í—Ä–∞—á:
        <select id="editDoctorSelect"></select>
    </label>
    <label>–ú–µ–¥—Å–µ—Å—Ç—Ä–∞:
        <select id="editNurseSelect"></select>
    </label>
    <label>–î–∞—Ç–∞ –≤–∏–∑–∏—Ç–∞:
        <input type="date" id="editVisitDate">
    </label>
    <label>–í—Ä–µ–º—è –≤–∏–∑–∏—Ç–∞:
        <input type="time" id="editVisitTime">
    </label>

    <label>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –≤–∏–∑–∏—Ç–∞:
        <input type="date" id="editVisitEndDate" name="visit_end_date">
    </label>

    <label>–û–∫–æ–Ω—á–∞–Ω–∏–µ –≤–∏–∑–∏—Ç–∞:
        <input type="time" id="editVisitEndTime">
    </label>

    <div>
        <label>–ü–æ–∏—Å–∫ —É—Å–ª—É–≥–∏:</label>
        <input type="text" id="editServiceSearch" placeholder="üîé –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ, –∫–æ–¥..." oninput="filterEditServices()">
    </div>
    
    <div class="service-selection-container">
        <div class="service-list">
            <h3>–î–æ—Å—Ç—É–ø–Ω—ã–µ —É—Å–ª—É–≥–∏</h3>
            <ul id="editAvailableServices"></ul>
        </div>
    
        <div class="selected-service-list">
            <h3>–í—ã–±—Ä–∞–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏</h3>
            <ul id="editSelectedServices"></ul>
        </div>
    </div>
    <input type="hidden" id="editSelectedServiceIds" name="edit_selected_services">


    <label>–°–∫–∏–¥–∫–∞ (% –Ω–∞ –≤—Å–µ —É—Å–ª—É–≥–∏ –∏–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ):
        <input type="number" id="editDiscountPercent" min="0" max="100" step="0.1" value="0">
    </label>

    


    <label>–û–ø–∏—Å–∞–Ω–∏–µ:
        <textarea id="editDescription" rows="3"></textarea>
    </label>
    <label>–°—Ç–∞—Ç—É—Å:
        <select id="editStatusSelect">
            <option value="pending">–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</option>
            <option value="paid">–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞</option>
            <option value="completed">–ü—Ä–æ–≤–µ–¥–µ–Ω–æ</option>
            <option value="paid_finish">–û–ø–ª–∞—á–µ–Ω–æ</option>
        </select>
    </label>
    <label>–§–∏–ª–∏–∞–ª:
        <select id="editBranchSelect"></select>
    </label>
    <label>–ö–∞–±–∏–Ω–µ—Ç:
        <select id="editRoomSelect"></select>
    </label>

    <label>
        <input type="checkbox" id="editIsOnline"> –û–Ω–ª–∞–π–Ω –ø—Ä–∏—ë–º
    </label>
    <label>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:
        <input type="number" id="editTotalPrice" step="0.01">
    </label>
    

    <button id="saveEditBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button id="cancelEditBtn">–û—Ç–º–µ–Ω–∞</button>
</div>








    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º TUI Calendar -->
    <script src="https://uicdn.toast.com/calendar/latest/toastui-calendar.min.js"></script>
    <script>
        function closeModal() {
            document.getElementById("modal").classList.remove("active");
            document.getElementById("error-message").innerText = ""; // –û—á–∏—Å—Ç–∫–∞ –æ—à–∏–±–æ–∫
        }

        function updateVisitEndTime() {
            let startTimeInput = document.getElementById("visitTime").value;
            let durationSelect = document.getElementById("durationSelect").value;
            let endTimeInput = document.getElementById("visitEndTime");
        
            if (!startTimeInput) return; // –ï—Å–ª–∏ –≤—Ä–µ–º—è –Ω–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
        
            let [hours, minutes] = startTimeInput.split(":").map(Number);
            let durationMinutes = parseInt(durationSelect);
        
            if (isNaN(durationMinutes)) return; // –ï—Å–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –≤—ã—Ö–æ–¥–∏–º
        
            let endMinutes = minutes + durationMinutes;
            
            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –≤–∏–∑–∏—Ç–∞
            hours += Math.floor(endMinutes / 60);
            endMinutes %= 60;
        
            endTimeInput.value = `${String(hours).padStart(2, "0")}:${String(endMinutes).padStart(2, "0")}`;
        }

        function ensureSeconds(timeString) {
            if (!timeString) return null;
            if (timeString.length === 5) return timeString + ":00"; // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–∫—É–Ω–¥—ã, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
            return timeString; // –£–∂–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ HH:MM:SS
        }






        document.addEventListener("DOMContentLoaded", function () {
            setupServiceSelection("availableServices", "selectedServices", "selectedServiceIds");
            setupServiceSelection("editAvailableServices", "editSelectedServices", "editSelectedServiceIds");
        });

        document.getElementById("editDiscountPercent").addEventListener("input", recalculateEditTotalPrice);
        

        function updateSelectedServices() {
            let selectedList = document.getElementById("selectedServices");
            let selectedIds = [];
        
            selectedList.querySelectorAll("li").forEach(li => {
                selectedIds.push(li.dataset.id);
            });
        
            document.getElementById("selectedServiceIds").value = selectedIds.join(",");
            console.log("üìå –í—ã–±—Ä–∞–Ω–Ω—ã–µ ID —É—Å–ª—É–≥:", selectedIds);
        }

        function recalculateTotalPrice() {
            const discountPercent = parseFloat(document.getElementById("discountPercent").value) || 0;
        
            let total = 0;
        
            document.querySelectorAll("#selectedServices li").forEach(li => {
                const serviceId = parseInt(li.dataset.id);
                const priceMatch = li.textContent.match(/\(([\d.]+)\s?–≥—Ä–Ω\)/);
                const checkbox = li.querySelector(".discountCheckbox");
        
                if (priceMatch) {
                    let price = parseFloat(priceMatch[1]);
        
                    if (discountPercent > 0 && checkbox && checkbox.checked) {
                        price = price - (price * discountPercent / 100);
                    }
        
                    total += price;
                }
            });
        
            total = Math.round(total * 100) / 100;
            document.getElementById("finalPrice").value = total;
        }
        

        function recalculateEditTotalPrice() {
            const discountPercent = parseFloat(document.getElementById("editDiscountPercent").value) || 0;
        
            let total = 0;
        
            document.querySelectorAll("#editSelectedServices li").forEach(li => {
                const priceMatch = li.textContent.match(/\(([\d.]+)\s?–≥—Ä–Ω\)/);
                const checkbox = li.querySelector(".discountCheckbox");
        
                if (priceMatch) {
                    let price = parseFloat(priceMatch[1]);
        
                    if (discountPercent > 0 && checkbox && checkbox.checked) {
                        price = price - (price * discountPercent / 100);
                    }
        
                    total += price;
                }
            });
        
            total = Math.round(total * 100) / 100;
            document.getElementById("editTotalPrice").value = total;
        }
        
        
        // üîπ –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —É—Å–ª—É–≥–∏ –º–µ–∂–¥—É —Å–ø–∏—Å–∫–∞–º–∏
        function setupServiceSelection(availableId, selectedId, hiddenInputId) {
            const availableList = document.getElementById(availableId);
            const selectedList = document.getElementById(selectedId);
            const selectedServiceIdsInput = document.getElementById(hiddenInputId);
        

        
            function moveService(event, fromList, toList) {
                if (event.target.tagName === "LI") {
                    let item = event.target;
            
                    if (fromList.contains(item)) {
                        fromList.removeChild(item);
                        toList.appendChild(item);
            
                        // ‚úÖ –í—ã–∑–æ–≤ –Ω—É–∂–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∏–Ω–ø—É—Ç–∞
                        if (hiddenInputId === "selectedServiceIds") {
                            updateSelectedServices();
                        } else if (hiddenInputId === "editSelectedServiceIds") {
                            updateEditSelectedServices();
                        }
                    } else {
                        console.warn("‚ö†Ô∏è –≠–ª–µ–º–µ–Ω—Ç —É–∂–µ —É–¥–∞–ª–µ–Ω –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø–∏—Å–∫–µ", item);
                    }
                }
            }
        
            availableList.addEventListener("click", function (event) {
                moveService(event, availableList, selectedList);
            });
        
            selectedList.addEventListener("click", function (event) {
                moveService(event, selectedList, availableList);
            });
        }
        
        // üîπ –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É—Å–ª—É–≥ –≤ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è
        function loadServices() {
            console.log("üî• –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —É—Å–ª—É–≥...");
        
            fetch("/api/services/")
                .then(response => response.json())
                .then(data => {
                    console.log("üì• –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏:", data);
        
                    let availableList = document.getElementById("availableServices");
                    availableList.innerHTML = ""; // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
        
                    data.forEach(service => {
                        let li = document.createElement("li");
                        li.textContent = `[${service.subgroup_number}] ${service.subgroup_name} ‚Üí ${service.service_code} - ${service.service_name} (${service.service_price} –≥—Ä–Ω)`;
                        li.dataset.id = service.id;
                        li.onclick = function () {
                            selectService(this);
                        };
                        availableList.appendChild(li);
                    });


        
                    console.log("‚úÖ –£—Å–ª—É–≥–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!");
                })
                .catch(error => console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Å–ª—É–≥:", error));
        }
        
        // üîπ –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —É—Å–ª—É–≥ –≤ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function loadEditServices(visitId) {
            if (!document.getElementById("editSelectedServices") || !document.getElementById("editAvailableServices")) {
                console.warn("‚è≥ –ú–æ–¥–∞–ª–∫–∞ –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤–∞, –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —É—Å–ª—É–≥...");
                setTimeout(() => loadEditServices(visitId), 200);
                return;
            }
        
            console.log(`üî• –ó–∞–≥—Ä—É–∂–∞–µ–º —É—Å–ª—É–≥–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∏–∑–∏—Ç–∞ ID: ${visitId}`);
        
            fetch("/api/services/")
                .then(response => response.json())
                .then(allServices => {
                    console.log("üì• –í—Å–µ —É—Å–ª—É–≥–∏:", allServices);
        
                    fetch(`/api/visits/${visitId}/`)
                        .then(response => {
                            if (!response.ok) throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–∑–∏—Ç–∞: ${response.status}`);
                            return response.json();
                        })
                        .then(visitData => {
                            console.log("üìå –î–∞–Ω–Ω—ã–µ –≤–∏–∑–∏—Ç–∞:", visitData);
        
                            const availableList = document.getElementById("editAvailableServices");
                            const selectedList = document.getElementById("editSelectedServices");
        
                            availableList.innerHTML = "";
                            selectedList.innerHTML = "";
        
                            const selectedServiceIds = visitData.services.map(s => s.id);
                            const discountedServiceIds = visitData.discounted_services || [];

                            // ‚úÖ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–∏–¥–∫—É –≤ –ø–æ–ª–µ, –µ—Å–ª–∏ –µ—Å—Ç—å
                            const discountInput = document.getElementById("editDiscountPercent");
                            if (discountInput) {
                                discountInput.value = visitData.discount_percent || 0;
                            } else {
                                console.warn("‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω editDiscountPercent!");
                            }

        
                            allServices.forEach(service => {
                                const li = document.createElement("li");
                                const displayText = `[${service.subgroup_number}] ${service.subgroup_name} ‚Üí ${service.service_code} - ${service.service_name} (${service.service_price} –≥—Ä–Ω)`;
                                const isChecked = discountedServiceIds.includes(service.id) ? "checked" : "";

                                li.dataset.id = service.id;
                                li.innerHTML = `<input type="checkbox" class="discountCheckbox" data-id="${service.id}" ${isChecked}> ${displayText}`;
                                li.querySelector(".discountCheckbox").addEventListener("change", recalculateEditTotalPrice);
                                li.onclick = function (e) {
                                    if (e.target.tagName !== "INPUT") selectEditService(li);
                                };
        
                                if (selectedServiceIds.includes(service.id)) {
                                    selectedList.appendChild(li);
                                } else {
                                    availableList.appendChild(li);
                                }
                            });
        
                            updateEditSelectedServices();
                            recalculateEditTotalPrice();
        
                            console.log("‚úÖ –£—Å–ª—É–≥–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è!");
                        })
                        .catch(error => console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤–∏–∑–∏—Ç–∞:", error));
                })
                .catch(error => console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö —É—Å–ª—É–≥:", error));
        }
        
        
        
        
        // üîπ –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —É—Å–ª—É–≥ –≤ –æ–∫–Ω–µ —Å–æ–∑–¥–∞–Ω–∏—è
        function filterServices() {
            let searchText = document.getElementById("serviceSearch").value.toLowerCase();
            let availableList = document.getElementById("availableServices");
        
            if (!availableList) {
                console.error("‚ùå –û—à–∏–±–∫–∞: —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É—Å–ª—É–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω!");
                return;
            }
        
            let services = availableList.getElementsByTagName("li");
        
            Array.from(services).forEach(item => {
                let text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchText) ? "" : "none";
            });
        
            console.log(`üîé –ü–æ–∏—Å–∫ —É—Å–ª—É–≥: ${searchText}`);
        }
        
        // üîπ –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —É—Å–ª—É–≥ –≤ –æ–∫–Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function filterEditServices() {
            let searchText = document.getElementById("editServiceSearch").value.toLowerCase();
            let availableList = document.getElementById("editAvailableServices");
        
            if (!availableList) {
                console.error("‚ùå –û—à–∏–±–∫–∞: —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É—Å–ª—É–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω!");
                return;
            }
        
            let services = availableList.getElementsByTagName("li");
        
            Array.from(services).forEach(item => {
                let text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchText) ? "" : "none";
            });
        
            console.log(`üîé –ü–æ–∏—Å–∫ —É—Å–ª—É–≥ (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ): ${searchText}`);
        }

        function selectService(element) {
            const selectedList = document.getElementById("selectedServices");
            const availableList = document.getElementById("availableServices");
        
            const serviceId = element.dataset.id;
            const serviceText = element.textContent;
        
            // –ï—Å–ª–∏ –∫–ª–∏–∫–∞–µ–º –ø–æ —ç–ª–µ–º–µ–Ω—Ç—É –≤ —Å–ø–∏—Å–∫–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö
            if (element.parentNode === availableList) {
                const li = document.createElement("li");
                li.dataset.id = serviceId;
                li.innerHTML = `<input type="checkbox" class="discountCheckbox" data-id="${serviceId}"> ${serviceText}`;
                li.onclick = function (e) {
                    if (e.target.tagName !== "INPUT") selectService(li); // ‚ùó –ù–µ –≤—ã–∑—ã–≤–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω–æ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —á–µ–∫–±–æ–∫—Å
                };
                li.querySelector(".discountCheckbox").addEventListener("change", recalculateTotalPrice);
        
                selectedList.appendChild(li);
                availableList.removeChild(element);
            } 
            // –ï—Å–ª–∏ –∫–ª–∏–∫–∞–µ–º –ø–æ —ç–ª–µ–º–µ–Ω—Ç—É –≤ —Å–ø–∏—Å–∫–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö
            else if (element.parentNode === selectedList) {
                selectedList.removeChild(element);
        
                const li = document.createElement("li");
                li.textContent = serviceText;
                li.dataset.id = serviceId;
                li.onclick = function () { selectService(li); };
        
                availableList.appendChild(li);
            }
        
            updateSelectedServices();
            recalculateTotalPrice();
        }
        

        function selectEditService(element) {
            const selectedList = document.getElementById("editSelectedServices");
            const availableList = document.getElementById("editAvailableServices");
        
            const serviceId = element.dataset.id;
            const serviceText = element.textContent;
        
            if (element.parentNode === availableList) {
                const li = document.createElement("li");
                li.dataset.id = serviceId;
                li.innerHTML = `<input type="checkbox" class="discountCheckbox" data-id="${serviceId}"> ${serviceText}`;
                li.querySelector(".discountCheckbox").addEventListener("change", recalculateEditTotalPrice);
                li.onclick = function (e) {
                    if (e.target.tagName !== "INPUT") selectEditService(li);
                };
        
                selectedList.appendChild(li);
                availableList.removeChild(element);
            } else if (element.parentNode === selectedList) {
                const li = document.createElement("li");
                li.textContent = serviceText;
                li.dataset.id = serviceId;
                li.onclick = function () { selectEditService(li); };
        
                availableList.appendChild(li);
                selectedList.removeChild(element);
            }
        
            updateEditSelectedServices();
            recalculateEditTotalPrice();
        }
        
        

        function updateEditSelectedServices() {
            let selectedList = document.getElementById("editSelectedServices");
            let selectedIds = [];
        
            selectedList.querySelectorAll("li").forEach(li => {
                selectedIds.push(li.dataset.id);
            });
        
            document.getElementById("editSelectedServiceIds").value = selectedIds.join(",");
            console.log("üìå –í—ã–±—Ä–∞–Ω–Ω—ã–µ ID —É—Å–ª—É–≥ (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ):", selectedIds);
        }
        






        document.addEventListener("DOMContentLoaded", function () {
            console.log("üì¢ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è...");

            // ‚úÖ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–±–∏–Ω–µ—Ç–æ–≤ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∏–ª–∏–∞–ª–∞ –≤ —Ñ–æ—Ä–º–µ —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–∑–∏—Ç–∞
            document.getElementById("branchSelect").addEventListener("change", function () {            
                updateRooms("branchSelect", "roomSelect");
            });

            // ‚úÖ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–±–∏–Ω–µ—Ç–æ–≤ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∏–ª–∏–∞–ª–∞ –≤ —Ñ–æ—Ä–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∏–∑–∏—Ç–∞
            document.getElementById("editBranchSelect").addEventListener("change", function () {            
                updateRooms("editBranchSelect", "editRoomSelect");
            });

            const saveEditBtn = document.getElementById("saveEditBtn");
            const cancelEditBtn = document.querySelector("#editModal button:last-of-type"); // –ò—â–µ–º –∫–Ω–æ–ø–∫—É "–û—Ç–º–µ–Ω–∞"
            const createVisitBtn = document.getElementById("createVisitBtn");

        
            if (saveEditBtn) {
                saveEditBtn.addEventListener("click", saveVisitChanges);
            } else {
                console.error("‚ùå –û—à–∏–±–∫–∞: –ö–Ω–æ–ø–∫–∞ '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!");
            }
        
            if (cancelEditBtn) {
                cancelEditBtn.addEventListener("click", closeEditModal);
            } else {
                console.error("‚ùå –û—à–∏–±–∫–∞: –ö–Ω–æ–ø–∫–∞ '–û—Ç–º–µ–Ω–∞' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞! –ü—Ä–æ–≤–µ—Ä—å ID –∫–Ω–æ–ø–∫–∏ –≤ HTML.");
            }
        
            if (createVisitBtn) {
                createVisitBtn.addEventListener("click", createVisit);
            } else {
                console.error("‚ùå –û—à–∏–±–∫–∞: –ö–Ω–æ–ø–∫–∞ '–°–æ–∑–¥–∞—Ç—å' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!");
            }

            const calendar = new tui.Calendar("#calendar", {
                defaultView: "day",
                
                useCreationPopup: false,
                useDetailPopup: true,
                useFormPopup: false,
                isReadOnly: false,
                draggable: true,
                resizable: true,
                taskView: false,
                scheduleView: ["time"],
                template: {

                    milestone(schedule) {
                        return null;
                    },
                    task(schedule) {
                        return null;
                    },
                    allday(schedule) {
                        return null;
                    },

                    time: function(schedule) {
                        return schedule.title;
                    },
        
                    // **üî• –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º 24-—á–∞—Å–æ–≤–æ–π —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ —à–∫–∞–ª–µ**
                    timegridDisplayPrimaryTime({ time }) {
                        let hours = time.getHours();
                        let minutes = time.getMinutes();
                        let formattedTime = `${String(hours).padStart(2, "0")}:${String(minutes).padStart(2, "0")}`;
                        return formatTimeDisplay(time); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ 24-—á–∞—Å–æ–≤–æ–π —Ñ–æ—Ä–º–∞—Ç
                    },
        
                    // **–î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤—Ä–µ–º–µ–Ω–∏ (–ø–æ –∂–µ–ª–∞–Ω–∏—é)**
                    timegridNowIndicatorLabel({ time }) {
                        let hours = time.getHours();
                        let minutes = time.getMinutes();
                        return `–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è: ${String(hours).padStart(2, "0")}:${String(minutes).padStart(2, "0")}`;
                    }

                },
                week: { 
                    startDayOfWeek: 1, 
                    hourStart: 0,
                    hourEnd: 24,
                    taskView: false,


                },
                day: {
                    hourStart: 0,
                    hourEnd: 24
                },
                month: { 
                    daynames: ["–ü–Ω", "–í—Ç", "–°—Ä", "–ß—Ç", "–ü—Ç", "–°–±", "–í—Å"] 
                }
            });
            
            calendar.setOptions({
                taskView: false,
                scheduleView: [],
                template: {
                    time(schedule) {
                        return schedule.title;
                    },
                    timegridDisplayPrimaryTime({ time }) {
                        return `${String(time.getHours()).padStart(2, "0")}:${String(time.getMinutes()).padStart(2, "0")}`;
                    },
                    timegridNowIndicatorLabel({ time }) {
                        return `–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è: ${String(time.getHours()).padStart(2, "0")}:${String(time.getMinutes()).padStart(2, "0")}`;
                    },
                    collapseBtnTitle() {
                        return `<span>‚Üë</span>`;
                    },
                    popupEdit() {
                        return 'Edit';
                    },
                    popupDelete() {
                        return 'Delete';
                    },
                    popupDetailTitle(schedule) {
                        return `<h3>${schedule.title}</h3>`;
                    },
                    popupDetailDate(schedule) {
                        // –≤—Å—ë –∫–∞–∫ —Ç—ã –¥–µ–ª–∞–ª
                        let branch = schedule.raw.branch || "–ù–µ —É–∫–∞–∑–∞–Ω";
                        let room = schedule.raw.room || "–ù–µ —É–∫–∞–∑–∞–Ω";
                        let serviceList = "–ù–µ —É–∫–∞–∑–∞–Ω—ã";
                        if (Array.isArray(schedule.raw.services)) {
                            serviceList = `<ul style="padding-left: 20px;">` +
                                schedule.raw.services.map(s =>
                                    `<li>[${s.subgroup_number}] ${s.subgroup_name} ‚Üí ${s.service_code} - ${s.service_name} (${s.service_price} –≥—Ä–Ω)</li>`
                                ).join("") + `</ul>`;
                        }
            
                        return `
                            <ul style="list-style: none; padding: 0;">
                                <li><strong>–î–∞—Ç–∞ –≤–∏–∑–∏—Ç–∞:</strong> ${formatDate(schedule.start)}</li>
                                <li><strong>–í—Ä–µ–º—è –≤–∏–∑–∏—Ç–∞:</strong> ${formatTime(schedule.start)} - ${formatTime(schedule.end)}</li>
                                <li><strong>–ü–∞—Ü–∏–µ–Ω—Ç:</strong> ${schedule.raw.patient_name || "–ù–µ —É–∫–∞–∑–∞–Ω"}</li>
                                <li><strong>–í—Ä–∞—á:</strong> ${schedule.raw.doctor_name || "–ù–µ —É–∫–∞–∑–∞–Ω"}</li>
                                <li><strong>–ú–µ–¥—Å–µ—Å—Ç—Ä–∞:</strong> ${schedule.raw.nurse_name || "–ù–µ —É–∫–∞–∑–∞–Ω–∞"}</li>
                                <li><strong>–£—Å–ª—É–≥–∏:</strong> ${serviceList}</li>
                                <li><strong>–§–∏–ª–∏–∞–ª:</strong> ${branch}</li>
                                <li><strong>–ö–∞–±–∏–Ω–µ—Ç:</strong> ${room}</li>
                                <li><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${schedule.raw.description || "–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è"}</li>
                                <li><strong>–°—Ç–∞—Ç—É—Å:</strong> ${getVisitStatusLabel(schedule.raw.status)}</li>
                                <li><strong>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</strong> ${schedule.raw.total_price || "0"} –≥—Ä–Ω</li>
                                <li><strong>–û–Ω–ª–∞–π–Ω –ø—Ä–∏—ë–º:</strong> ${schedule.raw.is_online ? "–î–∞" : "–ù–µ—Ç"}</li>
                            </ul>
                        `;
                    }
                }
            });
            
            
            

            document.getElementById("visitTime").addEventListener("change", updateVisitEndTime);
            document.getElementById("durationSelect").addEventListener("change", updateVisitEndTime);

            function formatDate(date) {
                const d = new Date(date);
                return d.toLocaleDateString("ru-RU", { year: "numeric", month: "long", day: "numeric" });
            }
            
            function formatTimeDisplay(date) {
                const d = new Date(date);
                return d.toLocaleTimeString("ru-RU", { hour: "2-digit", minute: "2-digit" });
            }
            
            
            function getVisitStatusLabel(status) {
                const statuses = {
                    "pending": "–í –æ–±—Ä–∞–±–æ—Ç–∫–µ",
                    "paid": "–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞",
                    "completed": "–ü—Ä–æ–≤–µ–¥–µ–Ω–æ",
                    "paid_finish": "–û–ø–ª–∞—á–µ–Ω–æ"
                };
                return statuses[status] || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å";
            }
                
        

            // ‚úÖ –§—É–Ω–∫—Ü–∏—è —Å–º–µ–Ω—ã –≤–∏–¥–∞ (–î–µ–Ω—å / –ù–µ–¥–µ–ª—è / –ú–µ—Å—è—Ü)
            function changeView(view) {
                calendar.changeView(view); // –ú–µ–Ω—è–µ—Ç –≤–∏–¥ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
            }

            // ‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ —Å–º–µ–Ω—ã –≤–∏–¥–∞
            document.querySelector("button[data-view='day']").addEventListener("click", function() {
                changeView("day");
            });
            document.querySelector("button[data-view='week']").addEventListener("click", function() {
                changeView("week");
            });
            document.querySelector("button[data-view='month']").addEventListener("click", function() {
                changeView("month");
            });

            function getCSRFToken() {
                return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            }

            function showError(message) {
                document.getElementById("error-message").innerText = message;
            }

            function loadSelectOptions(url, selectId, formatFunction) {
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        let select = document.getElementById(selectId);
                        if (!select) {
                            console.error(`‚ùå –û—à–∏–±–∫–∞: –≠–ª–µ–º–µ–Ω—Ç —Å ID '${selectId}' –Ω–µ –Ω–∞–π–¥–µ–Ω!`);
                            return;
                        }
                        select.innerHTML = data.map(formatFunction).join("");
                    })
                    .catch(error => console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", error));
            }

            function formatServiceOption(service) {
                return `<option value="${service.id}">
                    [${service.subgroup_number}] ${service.subgroup_name} ‚Üí ${service.service_code} - ${service.service_name} (${service.service_price} –≥—Ä–Ω)
                </option>`;
            }

            function formatUserOption(user) {
                return `<option value="${user.id}">${user.full_name || user.fool_name}</option>`;
            }

            function loadBranches() {
                fetch("/medicalCRM/api/branches/")
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª–∏–∞–ª–æ–≤: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("‚úÖ –§–∏–ª–∏–∞–ª—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã:", data);
                        let branchSelect = document.getElementById("branchSelect");
            
                        branchSelect.innerHTML = data.map(branch => 
                            `<option value="${branch.id}">${branch.branch_name}</option>`
                        ).join("");
            
                        if (data.length > 0) {
                            branchSelect.value = data[0].id; // ‚úÖ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–≤—ã–π —Ñ–∏–ª–∏–∞–ª
                            updateRooms("branchSelect", "roomSelect"); // üî• –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞–±–∏–Ω–µ—Ç—ã —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —Ñ–∏–ª–∏–∞–ª–∞
                        }
                    })
                    .catch(error => console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª–∏–∞–ª–æ–≤:", error));
            }
            
            
            document.getElementById("branchSelect").addEventListener("change", function () {
                updateRooms("editBranchSelect", "editRoomSelect");
            });
            
            function updateRooms(branchSelectId, roomSelectId) {
                let branchElement = document.getElementById(branchSelectId);
                let roomElement = document.getElementById(roomSelectId);
            
                if (!branchElement || !roomElement) {
                    console.error(`‚ùå –û—à–∏–±–∫–∞: –≠–ª–µ–º–µ–Ω—Ç—ã —Å ID '${branchSelectId}' –∏–ª–∏ '${roomSelectId}' –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!`);
                    return;
                }
            
                let branchId = branchElement.value;
            
                if (!branchId || isNaN(branchId)) {
                    console.warn("‚ö†Ô∏è –§–∏–ª–∏–∞–ª –Ω–µ –≤—ã–±—Ä–∞–Ω, –∫–∞–±–∏–Ω–µ—Ç—ã –Ω–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è.");
                    return;
                }           
            
                fetch(`/medicalCRM/api/rooms/?branch=${branchId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        roomElement.innerHTML = "";
            
                        if (data.length > 0) {
                            data.forEach(room => {
                                let option = document.createElement("option");
                                option.value = room.id;
                                option.textContent = room.room_number;
                                roomElement.appendChild(option);
                            });
            
                            roomElement.value = data[0].id; // ‚úÖ –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç
                        } else {
                            let option = document.createElement("option");
                            option.textContent = "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–∞–±–∏–Ω–µ—Ç–æ–≤";
                            option.value = "";
                            roomElement.appendChild(option);
                        }
            
                        console.log(`‚úÖ –ö–∞–±–∏–Ω–µ—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –¥–ª—è —Ñ–∏–ª–∏–∞–ª–∞ ${branchId}:`, data);
                    })
                    .catch(error => console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–±–∏–Ω–µ—Ç–æ–≤:", error));
            }
            
            
            function loadVisits() {
                fetch("/api/visits/")
                    .then(response => response.json())
                    .then(data => {
                        console.log("üì• –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –≤–∏–∑–∏—Ç—ã:", data); // –ü—Ä–æ–≤–µ—Ä—è–µ–º API
                        data.forEach(v => {
                            console.log(`üõ† –í–∏–∑–∏—Ç ID ${v.id}: —É—Å–ª—É–≥–∏ -`, v.services);
                            });
                        let schedules = data.map(v => {
                            let startDate = new Date(`${v.visit_date}T${v.visit_time}`);
                            let endDate = new Date(`${v.visit_end_date}T${v.visit_end_time}`);

                            // ‚úÖ —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞
                            if (endDate <= startDate) {
                                console.warn(`‚ö†Ô∏è –í–∏–∑–∏—Ç ID ${v.id}: –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è <= –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞—á–∞–ª–∞. –ò—Å–ø—Ä–∞–≤–ª—è–µ–º...`);
                                endDate.setDate(startDate.getDate() + 1);
                            }

                            // ‚úÖ –ø–æ—Ç–æ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç—Ä–æ–∫
                            let start = startDate.toISOString();
                            let end = endDate.toISOString();
                            

                            return {
                                id: v.id.toString(),
                                title: `${v.patient_name} - ${v.doctor_name || "?"}`,
                                category: "time",
                                isAllDay: false,
                                start,
                                end,
                                bgColor: "#36A2EB",
                                state: "Free",
                                raw: {
                                    patient_name: v.patient_name,
                                    doctor_name: v.doctor_name,
                                    nurse_name: v.nurse_name,
                                    services: v.services,
                                    branch: v.clinic_branch_name || "–ù–µ —É–∫–∞–∑–∞–Ω",
                                    room: v.clinic_room_number || "–ù–µ —É–∫–∞–∑–∞–Ω",
                                    description: v.description,
                                    total_price: v.total_price,
                                    is_online: v.is_online,
                                    status: v.payment_status,
                                    visit_end_date: v.visit_end_date,
                                    visit_end_time: v.visit_end_time,
                                }
                            };
                        });

                        console.log("üìÖ –°–æ–±—ã—Ç–∏—è –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è:", schedules); // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–±—ã—Ç–∏—è –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º

                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –º–µ—Ç–æ–¥–æ–≤ clear –∏ createEvents
                        if (typeof calendar.clear === "function") {
                            calendar.clear();
                        } else {
                            console.warn("‚ö†Ô∏è –ú–µ—Ç–æ–¥ calendar.clear() –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.");
                        }

                        if (typeof calendar.createEvents === "function") {
                            calendar.createEvents(schedules);
                        } else if (typeof calendar.createSchedules === "function") {
                            calendar.createSchedules(schedules); // –î–ª—è —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π TUI Calendar
                        } else {
                            console.error("‚ùå –ú–µ—Ç–æ–¥—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.");
                        }
                    })
                    .catch(error => console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ API:", error));
            }
            


            // ‚úÖ –ö–Ω–æ–ø–∫–∏ –¥–ª—è —Å–º–µ–Ω—ã –ø–µ—Ä–∏–æ–¥–∞ (–ù–∞–∑–∞–¥ / –í–ø–µ—Ä–µ–¥)
            document.querySelector("button[data-nav='prev']").addEventListener("click", function() {
                calendar.prev();
            });
            document.querySelector("button[data-nav='next']").addEventListener("click", function() {
                calendar.next();
            });

            // ‚úÖ –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π
            document.querySelector("button[data-action='reload']").addEventListener("click", function() {
                loadVisits();
            });

            function openModal() {
                document.getElementById("modal").classList.add("active");
                
                loadSelectOptions("/api/doctors/", "doctorSelect", formatUserOption);
                loadSelectOptions("/api/patients/", "patientSelect", formatUserOption);
                loadSelectOptions("/api/nurses/", "nurseSelect", formatUserOption);

                loadBranches();
                loadServices();  // üî• –ó–∞–≥—Ä—É–∂–∞–µ–º —É—Å–ª—É–≥–∏!
            }

            document.getElementById("durationSelect").addEventListener("change", function () {
                let durationSelect = this.value;
                let visitTimeInput = document.getElementById("visitTime").value;
                let visitEndTimeInput = document.getElementById("visitEndTime");
                let visitEndDateInput = document.getElementById("visitEndDate");
                
                if (durationSelect === "custom") {
                    // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ –æ–ø—Ü–∏—è "–ë–æ–ª–µ–µ...", –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–µ –¥–ª—è –≤–≤–æ–¥–∞ –≤—Ä–µ–º–µ–Ω–∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è
                    visitEndTimeInput.disabled = false;  // –î–µ–ª–∞–µ–º –ø–æ–ª–µ –¥–æ—Å—Ç—É–ø–Ω—ã–º
                    visitEndDateInput.disabled = false; // –î–µ–ª–∞–µ–º –ø–æ–ª–µ –¥–ª—è –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã–º
                } else {
                    // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –≤—ã—á–∏—Å–ª—è–µ–º –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è
                    visitEndTimeInput.disabled = true; // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª–µ
                    visitEndDateInput.disabled = true; // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª–µ
            
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ–±—ã –Ω–µ –ø—É—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –±—ã–ª–æ
                    if (visitTimeInput) {
                        let [startHours, startMinutes] = visitTimeInput.split(":").map(Number);
                        let durationMinutes = parseInt(durationSelect);
            
                        if (isNaN(durationMinutes)) return; // –ï—Å–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –≤—ã—Ö–æ–¥–∏–º
            
                        let endMinutes = startMinutes + durationMinutes;
                        let hours = startHours + Math.floor(endMinutes / 60);
                        endMinutes %= 60;
            
                        visitEndTimeInput.value = `${String(hours).padStart(2, "0")}:${String(endMinutes).padStart(2, "0")}`;
            
                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è –≤–∏–∑–∏—Ç–∞
                        let currentDate = new Date(document.getElementById("visitDate").value);
                        let endDate = new Date(currentDate.getTime());
                        endDate.setMinutes(endDate.getMinutes() + durationMinutes);  // –î–æ–±–∞–≤–ª—è–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–∏–∑–∏—Ç–∞
                        visitEndDateInput.value = endDate.toISOString().split("T")[0];  // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è
                    }
                }
            });

            
            
            // ‚úÖ –ü–æ–∑–≤–æ–ª—è–µ–º –≤—Ä—É—á–Ω—É—é –∑–∞–¥–∞–≤–∞—Ç—å –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
            document.getElementById("visitEndTime").addEventListener("change", function () {
                let visitTimeInput = document.getElementById("visitTime").value;
                let visitEndTimeInput = this.value;
            
                if (!visitTimeInput || !visitEndTimeInput) return;
            
                let [startHours, startMinutes] = visitTimeInput.split(":").map(Number);
                let [endHours, endMinutes] = visitEndTimeInput.split(":").map(Number);
            
                let totalMinutes = (endHours * 60 + endMinutes) - (startHours * 60 + startMinutes);
            
                if (totalMinutes <= 0) {
                    this.dataset.invalid = "true"; // –ü–æ–º–µ—á–∞–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ
                } else {
                    delete this.dataset.invalid; // –ï—Å–ª–∏ –≤—Å—ë –æ–∫, —É–¥–∞–ª—è–µ–º –∞—Ç—Ä–∏–±—É—Ç
                }
            
                document.getElementById("durationSelect").value = "custom"; // –ï—Å–ª–∏ –≤—Ä—É—á–Ω—É—é –≤–≤–æ–¥–∏–º, —Å—Ç–∞–≤–∏–º "–ë–æ–ª–µ–µ..."
            });
            
            // ‚úÖ –ü–æ–∑–≤–æ–ª—è–µ–º —Ä–∞—Å—Ç—è–≥–∏–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ –∏ –æ–±–Ω–æ–≤–ª—è—Ç—å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
            calendar.on("beforeUpdateEvent", function ({ event, changes }) {
                console.log("üõ† –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è:", event, changes);

                const visitId = event.id;
                if (!visitId) {
                    console.error("‚ùå –û—à–∏–±–∫–∞: ID –≤–∏–∑–∏—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω!");
                    return;
                }

                const updatedData = {};

                if (changes.start) {
                    const newStart = new Date(changes.start);
                    updatedData.visit_date = newStart.toISOString().split("T")[0];
                    updatedData.visit_time = formatTime(newStart);
                }

                if (changes.end) {
                    const newEnd = new Date(changes.end);
                    const startTime = changes.start ? new Date(changes.start) : new Date(event.start);

                    // –ï—Å–ª–∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å <= 0, —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º end –Ω–∞ 1 –º–∏–Ω—É—Ç—É
                    if (newEnd - startTime <= 0) {
                        console.warn("‚õî –ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å <= 0 ‚Äî —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º end –Ω–∞ 1 –º–∏–Ω—É—Ç—É");
                        newEnd.setMinutes(newEnd.getMinutes() + 1);
                    }

                    updatedData.visit_end_date = newEnd.toISOString().split("T")[0];
                    updatedData.visit_end_time = formatTime(newEnd);

                    const durationMinutes = Math.round((newEnd - startTime) / (1000 * 60));
                    updatedData.duration_minutes = durationMinutes > 0 ? durationMinutes : 1;
                }

                if (Object.keys(updatedData).length === 0) {
                    console.warn("‚ö†Ô∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π, –æ—Ç–∫—Ä—ã–≤–∞—é –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è...");
                    openEditModal(visitId);
                    return;
                }

                console.log("üì§ –ì–æ—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:", updatedData);
                updateVisitOnServer(visitId, updatedData);

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ
                calendar.updateEvent(event.id, {
                    start: changes.start || event.start,
                    end: changes.end || event.end,
                });
            });

            
            
            
            
            // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –≤ HH:mm
            function formatTime(dateInput) {
                const date = new Date(dateInput);
                if (isNaN(date)) return "00:00:00";
                return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}:${String(date.getSeconds()).padStart(2, '0')}`;
            }
            
            
            function createVisit() {
                let visitTimeInput = document.getElementById("visitTime");
                let visitEndTimeInput = document.getElementById("visitEndTime");
                let visitEndDateInput = document.getElementById("visitEndDate");
                let selectedDuration = document.getElementById("durationSelect").value;
                let selectedServiceIdsStr = document.getElementById("selectedServiceIds").value || "";
                let selectedServices = selectedServiceIdsStr
                    .split(",")
                    .filter(id => id)
                    .map(id => parseInt(id));


                let requiredFields = [
                    { id: "patientSelect", message: "–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞" },
                    { id: "doctorSelect", message: "–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–∞—á–∞" },
                    { id: "visitDate", message: "–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –≤–∏–∑–∏—Ç–∞" },
                    { id: "visitTime", message: "–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –≤–∏–∑–∏—Ç–∞" }
                ];
            
                document.querySelectorAll(".error-input").forEach(field => {
                    field.classList.remove("error-input");
                });
            
                let missingFields = [];
            
                requiredFields.forEach(field => {
                    let inputElement = document.getElementById(field.id);
                    if (!inputElement.value) {
                        inputElement.classList.add("error-input");
                        missingFields.push(field.message);
                    }
                });
            
                if (missingFields.length > 0) {
                    alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è:\n- " + missingFields.join("\n- "));
                    return;
                }
            
                let [startHours, startMinutes] = visitTimeInput.value.split(":").map(Number);
                let visit_end_time = visitEndTimeInput.value || "";
                let duration_minutes = null;
            
                if (selectedDuration !== "custom") {
                    let duration = parseInt(selectedDuration);
                    let endMinutes = startMinutes + duration;
            
                    if (endMinutes >= 60) {
                        startHours += Math.floor(endMinutes / 60);
                        endMinutes = endMinutes % 60;
                    }
            
                    visit_end_time = `${String(startHours).padStart(2, "0")}:${String(endMinutes).padStart(2, "0")}`;
                    duration_minutes = duration;
                }
            
                if (selectedDuration === "custom" && visitEndTimeInput.value) {
                    let [endHours, endMinutes] = visitEndTimeInput.value.split(":").map(Number);
                    let startTimeInMinutes = startHours * 60 + startMinutes;
                    let endTimeInMinutes = endHours * 60 + endMinutes;
            
                    if (endTimeInMinutes <= startTimeInMinutes) {
                        alert("–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–∑–∂–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞—á–∞–ª–∞!");
                        visitEndTimeInput.classList.add("error-input");
                        return;
                    }
            
                    duration_minutes = endTimeInMinutes - startTimeInMinutes;
                }
            

            
                let visitData = {
                    patient: document.getElementById("patientSelect").value,
                    doctor: document.getElementById("doctorSelect").value || null,
                    nurse: document.getElementById("nurseSelect").value || null,
                    visit_date: document.getElementById("visitDate").value,
                    visit_time: visitTimeInput.value,
                    visit_end_date: visitEndDateInput.value, 
                    visit_end_time: visit_end_time,
                    duration_minutes: duration_minutes ?? null,
                    services_ids: selectedServices.length > 0 ? selectedServices : [],  // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
                    total_price: parseFloat(document.getElementById("finalPrice").value) || 0.00,
                    payment_status: document.getElementById("statusSelect").value,
                    is_online: document.getElementById("isOnline").checked,
                    description: document.getElementById("description").value,
                    clinic_branch: document.getElementById("branchSelect").value,
                    clinic_room: document.getElementById("roomSelect").value,
                    discount_percent: parseFloat(document.getElementById("discountPercent").value) || 0,
                    discounted_services_ids: Array.from(document.querySelectorAll("#selectedServices .discountCheckbox"))
                    .filter(checkbox => checkbox.checked)
                    .map(checkbox => parseInt(checkbox.dataset.id)),
                    
                
                };
                // ‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏–∫—É "00:00:00 –Ω–∞ —Ç–æ–π –∂–µ –¥–∞—Ç–µ" ‚Äî —ç—Ç–æ –∑–Ω–∞—á–∏—Ç –≤–∏–∑–∏—Ç –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å
                if (visitData.visit_end_time === "00:00:00" && visitData.visit_end_date === visitData.visit_date) {
                    const endDateObj = new Date(visitData.visit_end_date);
                    endDateObj.setDate(endDateObj.getDate() + 1);
                    visitData.visit_end_date = endDateObj.toISOString().split("T")[0];
                }


                console.log("üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ:", JSON.stringify(visitData, null, 2));
                
            
                fetch("/api/visits/", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "X-CSRFToken": getCSRFToken() },
                    body: JSON.stringify(visitData)
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errData => {
                            console.error("‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:", errData);
                            alert("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–∑–∏—Ç–∞: " + JSON.stringify(errData));
                            throw new Error("Bad Request");
                        });
                    }
                    return response.json();
                })
                .then(() => {
                    closeModal();
                    loadVisits();
                })
                .catch(error => console.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–∑–∏—Ç–∞!", error));
            }

            // ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ —Å–æ–±—ã—Ç–∏–π


            // ‚úÖ –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ API
            function updateVisitOnServer(visitId, updatedData) {
                if (!visitId) {
                    console.error("‚ùå –û—à–∏–±–∫–∞: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç visitId!");
                    return;
                }

                console.log("üì° –í—ã–∑–≤–∞–Ω–∞ updateVisitOnServer");
                console.log("üÜî visitId:", visitId);
                console.log("üì¶ –î–∞–Ω–Ω—ã–µ –¥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:", updatedData);

                // ‚è± –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏ –≤–∫–ª—é—á–∞–µ—Ç —Å–µ–∫—É–Ω–¥—ã
                updatedData.visit_time = ensureSeconds(updatedData.visit_time);
                updatedData.visit_end_time = ensureSeconds(updatedData.visit_end_time);

                // ‚úÖ –î–æ–±–∞–≤–∏–º –∑–∞—â–∏—Ç—É, —á—Ç–æ–±—ã –¥–∞—Ç—ã —Ç–æ—á–Ω–æ –±—ã–ª–∏
                if (!updatedData.visit_date && updatedData.visit_time) {
                    console.warn("‚ö†Ô∏è –ù–µ—Ç –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –≤–∏–∑–∏—Ç–∞! –î–æ–±–∞–≤–ª—è–µ–º...");
                    updatedData.visit_date = new Date().toISOString().split("T")[0]; // –∏–ª–∏ —Ç–µ–∫—É—â–∞—è –¥–∞—Ç–∞ (–µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–ª–∏)
                }

                if (!updatedData.visit_end_date && updatedData.visit_end_time) {
                    console.warn("‚ö†Ô∏è –ù–µ—Ç –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è –≤–∏–∑–∏—Ç–∞! –î–æ–±–∞–≤–ª—è–µ–º...");
                    updatedData.visit_end_date = updatedData.visit_date; // –¥–æ–ø—É—Å—Ç–∏–º, –≤ —Ç–æ—Ç –∂–µ –¥–µ–Ω—å
                }

                console.log("üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä:", updatedData);

                fetch(`/api/visits/${visitId}/`, {
                    method: "PATCH",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCSRFToken()
                    },
                    body: JSON.stringify(updatedData)
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            console.error("‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:", err);
                            throw new Error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è!");
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("‚úÖ –í–∏–∑–∏—Ç —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!", data);
                    loadVisits();
                })
                .catch(error => console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –≤–∏–∑–∏—Ç–∞!", error));
            }
            
            
            
            

            // ‚úÖ –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –≤ HH:mm
            function formatTime(dateObj) {
                let hours = String(dateObj.getHours()).padStart(2, "0");
                let minutes = String(dateObj.getMinutes()).padStart(2, "0");
                return `${hours}:${minutes}`;
            }

            
            
            
            document.getElementById("createVisitBtn").addEventListener("click", createVisit);

            // ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Å—É–º–º—ã
            document.getElementById("discountPercent").addEventListener("input", recalculateTotalPrice);


            calendar.on("selectDateTime", function () {
                openModal();
            });

            loadVisits();


            calendar.on("selectSchedule", function(event) {
                if (!event || !event.schedule || !event.schedule.id) {
                    console.error("‚ùå –û—à–∏–±–∫–∞: ID –≤–∏–∑–∏—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω!");
                    return;
                }
            
                let visitId = event.schedule.id;
                console.log("üìå –û—Ç–∫—Ä—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∏–∑–∏—Ç–µ ID:", visitId);
            
                fetch(`/api/visits/${visitId}/`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–∑–∏—Ç–∞: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("‚úÖ –î–∞–Ω–Ω—ã–µ –≤–∏–∑–∏—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:", data);
                        let visitDetails = `
                            <p><strong>–ü–∞—Ü–∏–µ–Ω—Ç:</strong> ${data.patient_name}</p>
                            <p><strong>–í—Ä–∞—á:</strong> ${data.doctor_name || "–ù–µ —É–∫–∞–∑–∞–Ω"}</p>
                            <p><strong>–î–∞—Ç–∞:</strong> ${data.visit_date}</p>
                            <p><strong>–í—Ä–µ–º—è:</strong> ${data.visit_time} - ${data.visit_end_time}</p>
                            <p><strong>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> ${data.duration_minutes} –º–∏–Ω</p>
                            <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${getVisitStatusLabel(data.payment_status)}</p>
                            <ul id="visitServices"></ul>
                        `;

                        document.getElementById("visitDetails").innerHTML = visitDetails;

                        let serviceList = document.getElementById("visitServices");
                        serviceList.innerHTML = "";  // –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π

                        if (data.services && Array.isArray(data.services)) {
                            data.services.forEach(service => {
                                let li = document.createElement("li");
                                li.textContent = `[${service.subgroup_number}] ${service.subgroup_name} ‚Üí ${service.service_code} - ${service.service_name} (${service.service_price} –≥—Ä–Ω)`;
                                serviceList.appendChild(li);
                            });
                        } else {
                            serviceList.innerHTML = "<li>–ù–µ—Ç —É—Å–ª—É–≥</li>";
                        }
            
                        document.getElementById("visitDetails").innerHTML = visitDetails;
            
                        // –ù–∞–∑–Ω–∞—á–∞–µ–º ID –≤–∏–∑–∏—Ç–∞ –∫–Ω–æ–ø–∫–∞–º
                        document.getElementById("editVisitBtn").onclick = function () {
                            openEditModal(visitId);
                        };
            
                        document.getElementById("deleteVisitBtn").onclick = function () {
                            deleteVisit(visitId);
                        };
            
                        document.getElementById("visitInfoModal").classList.add("active");
                    })
                    .catch(error => console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤–∏–∑–∏—Ç–∞:", error));
            });
            
            function closeVisitInfoModal() {
                document.getElementById("visitInfoModal").classList.remove("active");
            }
            

            function deleteVisit(visitId) {
                if (!confirm("‚ùå –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –≤–∏–∑–∏—Ç?")) return;
            
                fetch(`/api/visits/${visitId}/`, {
                    method: "DELETE",
                    headers: { "X-CSRFToken": getCSRFToken() }
                })
                .then(response => {
                    if (response.status === 204) {
                        console.log(`‚úÖ –í–∏–∑–∏—Ç ${visitId} —É–¥–∞–ª–µ–Ω.`);
                        closeVisitInfoModal();
                        loadVisits(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≤–∏–∑–∏—Ç–æ–≤
                    } else {
                        throw new Error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤–∏–∑–∏—Ç–∞!");
                    }
                })
                .catch(error => console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏!", error));
            }
            
            

            

            calendar.on("selectSchedule", function(event) {
                console.log("üõ† –û—Ç–∫—Ä—ã—Ç–∏–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∏–∑–∏—Ç–∞...", event);
            
                if (!event || !event.schedule || !event.schedule.id) {
                    console.error("‚ùå –û—à–∏–±–∫–∞: ID –≤–∏–∑–∏—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω!");
                    return;
                }
            
                let visitId = event.schedule.id;
                console.log("üìå –ü–µ—Ä–µ–¥–∞–Ω–Ω—ã–π ID:", visitId);
            
                openEditModal(visitId);
            });
            

            calendar.on("beforeShowEventPopup", function(event) {
                console.log("üîç –í—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ —Å–æ–±—ã—Ç–∏—è –æ—Ç–∫—Ä—ã—Ç–æ", event);
            
                setTimeout(() => {
                    let editButton = document.querySelector(".toastui-calendar-popup-edit");
                    if (editButton) {
                        console.log("‚úÖ –ö–Ω–æ–ø–∫–∞ '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å' –Ω–∞–π–¥–µ–Ω–∞!");
            
                        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –µ—Å–ª–∏ –æ–Ω –±—ã–ª
                        editButton.onclick = null;
            
                        editButton.onclick = function() {
                            if (!event || !event.event || !event.event.id) {
                                console.error("‚ùå –û—à–∏–±–∫–∞: –Ω–µ—Ç ID —Å–æ–±—ã—Ç–∏—è!");
                                return;
                            }
            
                            let visitId = event.event.id;
                            console.log("‚úèÔ∏è –ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –≤–∏–∑–∏—Ç–∞ ID:", visitId);
                            openEditModal(visitId);
                        };
                    } else {
                        console.error("‚ùå –ö–Ω–æ–ø–∫–∞ '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å' –ù–ï –Ω–∞–π–¥–µ–Ω–∞!");
                    }
                }, 300); // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏
            });

            function setSelectValue(selectElement, value) {
                for (let option of selectElement.options) {
                    if (option.value == value) {
                        option.selected = true;
                        break;
                    }
                }
            }
            
            
            function openEditModal(visitId) {
                console.log(`üì¢ –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –≤–∏–∑–∏—Ç–∞ ID: ${visitId}`);
                loadEditServices(visitId);
                

                fetch(`/api/visits/${visitId}/`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–∑–∏—Ç–∞: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("‚úÖ –î–∞–Ω–Ω—ã–µ –≤–∏–∑–∏—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:", data);
            
                        let patientSelect = document.getElementById("editPatientSelect");
                        let doctorSelect = document.getElementById("editDoctorSelect");
                        let nurseSelect = document.getElementById("editNurseSelect");
                        let branchSelect = document.getElementById("editBranchSelect");
                        let roomSelect = document.getElementById("editRoomSelect");
                        

                        

            
                        if (!patientSelect || !doctorSelect || !nurseSelect || !branchSelect || !roomSelect ) {
                            console.error("‚ùå –û—à–∏–±–∫–∞: –æ–¥–∏–Ω –∏–∑ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Ñ–æ—Ä–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω!");
                            return;
                        }
            
                        // ‚úÖ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –ø–æ–ª—è
                        document.getElementById("editPatientSelect").value = data.patient;
                        document.getElementById("editDoctorSelect").value = data.doctor;
                        document.getElementById("editNurseSelect").value = data.nurse;
                        document.getElementById("editVisitDate").value = data.visit_date || "";
                        document.getElementById("editVisitTime").value = data.visit_time || "";
                        document.getElementById("editVisitEndTime").value = data.visit_end_time || "";
                        document.getElementById("editDescription").value = data.description || "";
                        document.getElementById("editStatusSelect").value = data.payment_status || "";
                        document.getElementById("editTotalPrice").value = data.total_price || 0;
                        document.getElementById("editIsOnline").checked = data.is_online || false;
                        document.getElementById("editDiscountPercent").value = (data.discount_percent !== null && data.discount_percent !== undefined)
                        ? data.discount_percent
                        : 0;
                        document.getElementById("editVisitEndDate").value = data.visit_end_date; // –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è
                        document.getElementById("editVisitEndTime").value = data.visit_end_time; // –í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è
                        

                        // ‚úÖ üìå **–û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —É—Å–ª—É–≥**
                        let selectedList = document.getElementById("editSelectedServices");
                        selectedList.innerHTML = "";  // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º

                        if (data.services && Array.isArray(data.services)) {
                            data.services.forEach(service => {
                                let li = document.createElement("li");
                                li.textContent = `[${service.subgroup_number}] ${service.subgroup_name} ‚Üí ${service.service_code} - ${service.service_name} (${service.service_price} –≥—Ä–Ω)`;
                                li.dataset.id = service.id;
                                li.onclick = function () {
                                    selectEditService(this);
                                };
                                selectedList.appendChild(li); // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫
                            });
                        } else {
                            console.warn("‚ö†Ô∏è –ù–µ—Ç —É—Å–ª—É–≥ –¥–ª—è —ç—Ç–æ–≥–æ –≤–∏–∑–∏—Ç–∞!");
                        }

                        // ‚úÖ –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ ID –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —É—Å–ª—É–≥ (–ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —á–∏—Å–ª–∞)
                        let selectedServiceIds = (data.services || []).map(s => parseInt(s.id));
                        // ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Ñ–∏–ª–∏–∞–ª–∞ –∏ –∫–∞–±–∏–Ω–µ—Ç–∞ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
                        let currentBranchId = data.clinic_branch;
                        let currentRoomId = data.clinic_room;
            
                        // üìå –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∏–ª–∏–∞–ª—ã, –∫–∞–±–∏–Ω–µ—Ç—ã –∏ —É—Å–ª—É–≥–∏
                        Promise.all([
                            fetch("/medicalCRM/api/branches/").then(response => response.json()),
                            fetch(`/medicalCRM/api/rooms/?branch=${data.clinic_branch || ''}`).then(response => response.json()),
                            fetch("/api/services/").then(response => response.json()),
                            fetch("/api/doctors/").then(response => response.json()),
                            fetch("/api/patients/").then(response => response.json()),
                            fetch("/api/nurses/").then(response => response.json()),
                        ])
                        .then(([branches, rooms, services, doctors, patients, nurses]) => {
                            console.log("‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:", { branches, rooms, services, doctors, patients, nurses });
                            
                            const doctorSelect = document.getElementById("editDoctorSelect");
                            const nurseSelect = document.getElementById("editNurseSelect");
                            const patientSelect = document.getElementById("editPatientSelect");

                            // –ó–∞–ø–æ–ª–Ω—è–µ–º –≤—Ä–∞—á–µ–π
                            doctorSelect.innerHTML = doctors.map(doctor =>
                                `<option value="${doctor.id}" ${doctor.id === data.doctor ? "selected" : ""}>
                                    ${doctor.fool_name}
                                </option>`
                            ).join("");

                            
                            // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤
                            patientSelect.innerHTML = patients.map(patient =>
                                `<option value="${patient.id}" ${patient.id === data.patient ? "selected" : ""}>
                                    ${patient.fool_name}
                                </option>`
                            ).join("");

                            // –ó–∞–ø–æ–ª–Ω—è–µ–º –º–µ–¥—Å–µ—Å—Ç–µ—Ä
                            nurseSelect.innerHTML = nurses.map(nurse =>
                                `<option value="${nurse.id}" ${nurse.id === data.nurse ? "selected" : ""}>
                                    ${nurse.fool_name}
                                </option>`
                            ).join("");

                            
                            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∏–ª–∏–∞–ª–æ–≤
                            let branchSelect = document.getElementById("editBranchSelect");
                            branchSelect.innerHTML = branches.map(branch =>
                                `<option value="${branch.id}" ${branch.branch_name === data.clinic_branch_name ? "selected" : ""}>
                                    ${branch.branch_name}
                                </option>`
                            ).join("");
                        
    

                            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞–±–∏–Ω–µ—Ç–æ–≤ (–∏—Å—Ö–æ–¥—è –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ–∏–ª–∏–∞–ª–∞)
                            let roomSelect = document.getElementById("editRoomSelect");
                            roomSelect.innerHTML = rooms.map(room =>
                                `<option value="${room.id}" ${room.room_number === data.clinic_room_number ? "selected" : ""}>
                                    –ö–∞–±–∏–Ω–µ—Ç ${room.room_number}
                                </option>`
                            ).join("");

                            // ‚úÖ –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞–±–∏–Ω–µ—Ç—ã –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —Ñ–∏–ª–∏–∞–ª–∞
                            updateRooms("editBranchSelect", "editRoomSelect", data.clinic_room);
            
                            // ‚úÖ –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ —É—Å–ª—É–≥ –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π –Ω–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
                            setSelectValue(document.getElementById("editDoctorSelect"), data.doctor);
                            setSelectValue(document.getElementById("editNurseSelect"), data.nurse);
                            setSelectValue(document.getElementById("editPatientSelect"), data.patient);
            

                        })
                        .catch(error => console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª–∏–∞–ª–æ–≤, –∫–∞–±–∏–Ω–µ—Ç–æ–≤ –∏–ª–∏ —É—Å–ª—É–≥:", error));
            
                        // ‚úÖ –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Ä–∞—á–µ–π, –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤ –∏ –º–µ–¥—Å–µ—Å—Ç–µ—Ä
                        

                        updateEditSelectedServices();  // —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏–ª—Å—è hidden input
                        recalculateEditTotalPrice();   // –ø–µ—Ä–µ—Å—á—ë—Ç —Å—É–º–º—ã
            
                        // ‚úÖ –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                        document.getElementById("editModal").dataset.visitId = visitId;
                        document.getElementById("editModal").classList.add("active");
                    })
                    .catch(error => console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤–∏–∑–∏—Ç–∞:", error));
            }

            window.openEditModal = openEditModal;
            
            
            function formatBranchOption(branch) {
                return `<option value="${branch.id}">${branch.branch_name}</option>`;
            }
            function formatRoomOption(room) {
                return `<option value="${room.id}">${room.room_number}</option>`;
            }

            
            function closeEditModal() {
                let modal = document.getElementById("editModal");
                if (modal) {
                    modal.classList.remove("active");
                    modal.dataset.visitId = "";

                    // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
                    document.getElementById("editPatientSelect").value = "";
                    document.getElementById("editDoctorSelect").value = "";
                    document.getElementById("editNurseSelect").value = "";
                    document.getElementById("editVisitDate").value = "";
                    document.getElementById("editVisitTime").value = "";
                    document.getElementById("editVisitEndTime").value = "";
                    document.getElementById("editDescription").value = "";
                    document.getElementById("editStatusSelect").value = "pending";
                    document.getElementById("editBranchSelect").value = "";
                    document.getElementById("editRoomSelect").value = "";

                    console.log("üì¢ –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è");
                } else {
                    console.error("‚ùå –û—à–∏–±–∫–∞: –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!");
                }
            }


            
            
            document.getElementById("saveEditBtn").addEventListener("click", function () {
                let visitId = document.getElementById("editModal").dataset.visitId;
                if (!visitId) {
                    console.error("‚ùå –û—à–∏–±–∫–∞: –Ω–µ—Ç ID –≤–∏–∑–∏—Ç–∞!");
                    return;
                }
            
                let updatedData = {
                    patient: document.getElementById("editPatientSelect").value,
                    doctor: document.getElementById("editDoctorSelect").value || null,
                    nurse: document.getElementById("editNurseSelect").value || null,
                    visit_date: document.getElementById("editVisitDate").value,
                    visit_time: document.getElementById("editVisitTime").value,
                    visit_end_time: document.getElementById("editVisitEndTime").value || null,
                    description: document.getElementById("editDescription").value,
                    payment_status: document.getElementById("editStatusSelect").value,
                    clinic_branch: document.getElementById("editBranchSelect").value,
                    clinic_room: document.getElementById("editRoomSelect").value,
                    is_online: document.getElementById("editIsOnline").checked, // ‚úÖ –ì–∞–ª–æ—á–∫–∞ –æ–Ω–ª–∞–π–Ω-–ø—Ä–∏—ë–º–∞
                    total_price: parseFloat(document.getElementById("editTotalPrice").value) || 0.00, // ‚úÖ –¥–æ–±–∞–≤–ª–µ–Ω–æ
                    discount_percent: parseFloat(document.getElementById("editDiscountPercent").value) || 0,
                    discounted_services: Array.from(document.querySelectorAll("#editSelectedServices .discountCheckbox"))
                        .filter(checkbox => checkbox.checked)
                        .map(checkbox => parseInt(checkbox.dataset.id)),
                };
                if (updatedData.visit_end_time === "00:00:00" && updatedData.visit_end_date === updatedData.visit_date) {
                    const endDateObj = new Date(updatedData.visit_end_date);
                    endDateObj.setDate(endDateObj.getDate() + 1);
                    updatedData.visit_end_date = endDateObj.toISOString().split("T")[0];
                }
            
                console.log("üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π:", updatedData); // –õ–æ–≥–∏—Ä—É–µ–º, —á—Ç–æ –ø–µ—Ä–µ–¥–∞–µ–º
            
                fetch(`/api/visits/${visitId}/`, {
                    method: "PATCH",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCSRFToken()
                    },
                    body: JSON.stringify(updatedData)
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            console.error("‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:", err);
                            throw new Error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è!");
                        });
                    }
                    return response.json();
                })
                .then(() => {
                    console.log("‚úÖ –í–∏–∑–∏—Ç —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!");
                    closeEditModal();
                    loadVisits(); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å
                })
                .catch(error => console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏!", error));
            });
            document.getElementById("cancelEditBtn").addEventListener("click", function () {
                closeEditModal();
            });

            
            

                        
            function formatTimeToSeconds(time) {
                console.log("‚è± –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–∏ –≤ —Å–µ–∫—É–Ω–¥—ã:", time);
                if (time && time.length === 5) { 
                    return time + ":00";  // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–∫—É–Ω–¥—ã, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
                }
                return time;
            }
            
            function saveVisitChanges() {
                let visitId = document.getElementById("editModal").dataset.visitId;
            
                if (!visitId) {
                    console.error("‚ùå –û—à–∏–±–∫–∞: –Ω–µ—Ç ID –≤–∏–∑–∏—Ç–∞!");
                    return;
                }
            
                // üìå –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ª—å–∫–æ ID –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —É—Å–ª—É–≥
                let selectedServiceIdsStr = document.getElementById("editSelectedServiceIds").value || "";
                let selectedServices = selectedServiceIdsStr
                    .split(",")
                    .filter(id => id)
                    .map(id => parseInt(id));
            
                let updatedData = {
                    patient: document.getElementById("editPatientSelect").value,
                    doctor: document.getElementById("editDoctorSelect").value || null,
                    nurse: document.getElementById("editNurseSelect").value || null,
                    visit_date: document.getElementById("editVisitDate").value,
                    visit_time: ensureSeconds(document.getElementById("editVisitTime").value),
                    visit_end_time: ensureSeconds(document.getElementById("editVisitEndTime").value),
                    description: document.getElementById("editDescription").value,
                    payment_status: document.getElementById("editStatusSelect").value,
                    clinic_branch: parseInt(document.getElementById("editBranchSelect").value) || null, // ‚úÖ –ü–µ—Ä–µ–¥–∞–µ–º ID, –∞ –Ω–µ —Å—Ç—Ä–æ–∫—É
                    clinic_room: parseInt(document.getElementById("editRoomSelect").value) || null,   // ‚úÖ –ü–µ—Ä–µ–¥–∞–µ–º ID, –∞ –Ω–µ —Å—Ç—Ä–æ–∫—É
                    services_ids: selectedServices.length > 0 ? selectedServices : [], // ‚úÖ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–ª—é—á
                    is_online: document.getElementById("editIsOnline").checked, // ‚úÖ –ì–∞–ª–æ—á–∫–∞ –æ–Ω–ª–∞–π–Ω-–ø—Ä–∏—ë–º–∞
                    total_price: parseFloat(document.getElementById("editTotalPrice").value) || 0.00, // ‚úÖ –¥–æ–±–∞–≤–ª–µ–Ω–æ
                    discounted_services_ids: Array.from(document.querySelectorAll("#editSelectedServices .discountCheckbox"))
                    .filter(checkbox => checkbox.checked)
                    .map(checkbox => parseInt(checkbox.dataset.id)), // üí• –≤–æ—Ç —ç—Ç–æ–≥–æ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç!
                    discount_percent: parseFloat(document.getElementById("editDiscountPercent").value) || 0,
                    visit_end_date: document.getElementById("editVisitEndDate").value,  // –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è
                    visit_end_time: document.getElementById("editVisitEndTime").value,  // –í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è
                };
                if (updatedData.visit_end_time === "00:00:00" && updatedData.visit_end_date === updatedData.visit_date) {
                    const endDateObj = new Date(updatedData.visit_end_date);
                    endDateObj.setDate(endDateObj.getDate() + 1);
                    updatedData.visit_end_date = endDateObj.toISOString().split("T")[0];
                }
            
                console.log("üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π:", updatedData);
            
                fetch(`/api/visits/${visitId}/`, {
                    method: "PUT",
                    headers: { 
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCSRFToken() 
                    },
                    body: JSON.stringify(updatedData)
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            console.error("‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:", err);
                            alert("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∏–∑–∏—Ç–∞: " + JSON.stringify(err));
                            throw new Error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è!");
                        });
                    }
                    return response.json();
                })
                .then((updatedVisit) => {
                    console.log("‚úÖ –í–∏–∑–∏—Ç —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!", updatedVisit);
            
                    closeEditModal();
                    loadVisits(); // üî• –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–Ω–æ–≤–æ –≤–∏–∑–∏—Ç—ã
            
                    // üî• –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä —É—Å–ª—É–≥ –≤ UI
                
                })
                .catch(error => console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –≤–∏–∑–∏—Ç–∞!", error));
            }
            
            
            
     
            
            
            
        });
    </script>























<script>
    document.addEventListener("DOMContentLoaded", function () {
        console.log("üì¢ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤...");

        const filtersContainer = document.getElementById("filtersContainer");
        const filteredVisitsContainer = document.getElementById("filteredVisitsContainer");
        const filtersBlock = document.querySelector(".filtersBLOCK");

        // –°–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫ —Å –≤–∏–∑–∏—Ç–∞–º–∏ –∏ –±–ª–æ–∫ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ
        filteredVisitsContainer.style.display = "none";
        filtersBlock.style.display = "block";  // –ë–ª–æ–∫ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è

        const filters = [
            { id: 'branch', label: '–§–∏–ª–∏–∞–ª', url: '/api/branches/', name: 'branch_name', uniquePrefix: 'filter' },
            { id: 'room', label: '–ö–∞–±–∏–Ω–µ—Ç', url: '/api/rooms/', name: 'room_number', dependent: 'branch', uniquePrefix: 'filter' },
            { id: 'specialization', label: '–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è', url: '/api/specializations/', name: 'name', uniquePrefix: 'filter' },

            { id: 'patient', label: '–ü–∞—Ü–∏–µ–Ω—Ç', url: '/api/patients/', name: 'fool_name', uniquePrefix: 'filter' },
            { id: 'start_date', label: '–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞', uniquePrefix: 'filter', type: 'date' },
            { id: 'end_date', label: '–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è', uniquePrefix: 'filter', type: 'date' }
        ];

        let filtersData = {
            clinic_branch: null,
            clinic_room: null,
            specialization: null,
            doctor: null,
            patient: null,
            start_date: null,
            end_date: null
        };

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –≤–∏–∑–∏—Ç–æ–≤


        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤–∏–∑–∏—Ç–æ–≤
        function updateVisitsDisplay(visits) {
        const container = document.getElementById('filteredVisitsContainer');
        container.innerHTML = '';  // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞–∫–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
        const appliedFilters = {
        clinic_branch: filtersData.clinic_branch || null,
        clinic_room: filtersData.clinic_room || null,
        doctor: filtersData.doctor || null,
        patient: filtersData.patient || null,
        };

        visits.forEach(visit => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤–∏–∑–∏—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º
            let matchesFilter = true;
        
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∏–ª—å—Ç—Ä –¥–ª—è —Ñ–∏–ª–∏–∞–ª–∞
            if (appliedFilters.branch && appliedFilters.branch !== visit.clinic_branch) {
                matchesFilter = false;
            }
        
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∏–ª—å—Ç—Ä –¥–ª—è –∫–∞–±–∏–Ω–µ—Ç–∞
            if (appliedFilters.room && appliedFilters.room !== visit.clinic_room) {
                matchesFilter = false;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∏–ª—å—Ç—Ä –¥–ª—è –≤—Ä–∞—á–∞
            if (appliedFilters.doctor && appliedFilters.doctor !== visit.doctor) {
                matchesFilter = false;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∏–ª—å—Ç—Ä –¥–ª—è –ø–∞—Ü–∏–µ–Ω—Ç–∞
            if (appliedFilters.patient && appliedFilters.patient !== visit.patient) {
                matchesFilter = false;
            }

            // –ï—Å–ª–∏ –≤–∏–∑–∏—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤—Å–µ–º –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ–≥–æ
            if (matchesFilter) {
                const button = document.createElement("button");
                button.classList.add("visit-button");
                button.innerHTML = `
                    <div>${visit.patient_name}</div>
                    <div>${visit.visit_date}</div>
                    <div>${visit.visit_time}</div>
                `;
                button.onclick = () => openVisitModal(visit.id);  // –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ

                container.appendChild(button);
            }
        });
        }





        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∫–∞–±–∏–Ω–µ—Ç–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ñ–∏–ª–∏–∞–ª–∞
        function updateRoomFilter(branchId) {
            const roomSelect = document.getElementById("filter_roomSelect");

            if (!branchId) {
                roomSelect.innerHTML = '<option value="">–í—Å–µ</option>';
                return;
            }

            fetch(`/api/rooms/?branch=${branchId}`)
                .then(response => response.json())
                .then(data => {
                    roomSelect.innerHTML = '<option value="">–í—Å–µ</option>';
                    data.forEach(room => {
                        const option = document.createElement("option");
                        option.value = room.id;
                        option.textContent = `–ö–∞–±–∏–Ω–µ—Ç ${room.room_number}`;
                        roomSelect.appendChild(option);
                    });
                    console.log(`‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã –∫–∞–±–∏–Ω–µ—Ç—ã –¥–ª—è —Ñ–∏–ª–∏–∞–ª–∞ ID ${branchId}`);
                })
                .catch(error => console.error(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–±–∏–Ω–µ—Ç–æ–≤ –¥–ª—è —Ñ–∏–ª–∏–∞–ª–∞ ${branchId}:`, error));
        }



        // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è select (—Ñ–∏–ª—å—Ç—Ä–æ–≤)
        function loadSelectData(filterId, apiUrl, nameKey, dependentFilterId = null) {
            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    const selectElement = document.getElementById(`filter_${filterId}Select`);
                    selectElement.innerHTML = '<option value="">–í—Å–µ</option>';
                    data.forEach(item => {
                        const option = document.createElement("option");
                        option.value = item.id;
                        option.textContent = item[nameKey];
                        selectElement.appendChild(option);
                    });

                    if (dependentFilterId) {
                        updateDependentFilters(dependentFilterId);
                    }
                })
                .catch(error => console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ ${filterId}:`, error));
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏–º—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function updateDependentFilters(filterId) {
            const dependentFilters = {
                room: "branch",  // –ö–∞–±–∏–Ω–µ—Ç –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –§–∏–ª–∏–∞–ª–∞
                doctor: "specialization"  // –í—Ä–∞—á –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
            };

            if (dependentFilters[filterId]) {
                const dependentFilterId = dependentFilters[filterId];
                const selectedValue = document.getElementById(`filter_${dependentFilterId}Select`).value;

                if (selectedValue) {
                    filtersData[dependentFilterId] = selectedValue;
                    loadSelectData(filterId, `/api/${filterId}?${dependentFilterId}=${selectedValue}`, `${filterId}_name`);
                }
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤–∏–∑–∏—Ç–æ–≤ –ø–æ —Ñ–∏–ª—å—Ç—Ä–∞–º
        function filterVisitsByFilters(filters) {
            console.log("üöÄ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä:", filters);  // –õ–æ–≥ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
            fetch('/api/filtered-visits/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify(filters)  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –≤ —Ç–µ–ª–µ –∑–∞–ø—Ä–æ—Å–∞
            })
            .then(response => response.json())
            .then(data => {
                updateVisitsDisplay(data);  // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–∏–∑–∏—Ç—ã
            })
            .catch(error => console.error('–û—à–∏–±–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:', error));
        }
        function getVisitStatusLabel(status) {
            const statuses = {
                "pending": "–í –æ–±—Ä–∞–±–æ—Ç–∫–µ",
                "paid": "–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞",
                "completed": "–ü—Ä–æ–≤–µ–¥–µ–Ω–æ",
                "paid_finish": "–û–ø–ª–∞—á–µ–Ω–æ"
            };
            return statuses[status] || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å";
        }
        

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –≤–∏–∑–∏—Ç–µ
        function openVisitModal(visitId) {
            fetch(`/api/visits/${visitId}/`)
                .then(response => response.json())
                .then(visit => {
                    const modal = document.getElementById("visitDetailsModal");
                    const visitDetails = document.getElementById("visitDetails");

                    visitDetails.innerHTML = `
                        <p><strong>–ü–∞—Ü–∏–µ–Ω—Ç:</strong> ${visit.patient_name}</p>
                        <p><strong>–í—Ä–∞—á:</strong> ${visit.doctor_name || "–ù–µ —É–∫–∞–∑–∞–Ω"}</p>
                        <p><strong>–ú–µ–¥—Å–µ—Å—Ç—Ä–∞:</strong> ${visit.nurse_name || "–ù–µ —É–∫–∞–∑–∞–Ω–∞"}</p>
                        <p><strong>–î–∞—Ç–∞ –≤–∏–∑–∏—Ç–∞:</strong> ${visit.visit_date}</p>
                        <p><strong>–í—Ä–µ–º—è –≤–∏–∑–∏—Ç–∞:</strong> ${visit.visit_time} - ${visit.visit_end_time}</p>
                        <p><strong>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> ${visit.duration_minutes} –º–∏–Ω</p>
                        <p><strong>–£—Å–ª—É–≥–∏:</strong></p>
                        <ul>
                            ${visit.services.map(service => `
                                <li>[${service.subgroup_number}] ${service.subgroup_name} ‚Üí ${service.service_code} - ${service.service_name} (${service.service_price} –≥—Ä–Ω)</li>
                            `).join('')}
                        </ul>
                        <p><strong>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</strong> ${visit.total_price} –≥—Ä–Ω</p>
                        <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${getVisitStatusLabel(visit.payment_status)}</p>
                        <p><strong>–û–Ω–ª–∞–π–Ω –ø—Ä–∏–µ–º:</strong> ${visit.is_online ? "–î–∞" : "–ù–µ—Ç"}</p>
                        <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${visit.description || "–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è"}</p>
                        <p><strong>–°–∫–∏–¥–∫–∞ (%):</strong> ${visit.discount_percent || 0}</p>
                        <p><strong>–§–∏–ª–∏–∞–ª:</strong> ${visit.clinic_branch_name || "–ù–µ —É–∫–∞–∑–∞–Ω"}</p>
                        <p><strong>–ö–∞–±–∏–Ω–µ—Ç:</strong> ${visit.clinic_room_number || "–ù–µ —É–∫–∞–∑–∞–Ω"}</p>
                        <div id="visitFILTRActions" class="unique-visit-actions">
                            <button id="editVisitBtn" class="visit-action-btn edit-visit-btn">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                            <button id="closeVisitBtn" class="visit-action-btn close-visit-btn">‚ùå –ó–∞–∫—Ä—ã—Ç—å</button>
                        </div>
                    `;
                    // –ü—Ä–∏–≤—è–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π –∫ –∫–Ω–æ–ø–∫–∞–º –ø–æ—Å–ª–µ –≤—Å—Ç–∞–≤–∫–∏ –≤ DOM
                    document.getElementById("editVisitBtn").onclick = function () {
                        openEditModal(visitId);
                    };
                    document.getElementById("closeVisitBtn").onclick = function () {
                        closeVisitDetailsModal();
                    };
                    

                    modal.classList.add("active");
                })
                .catch(error => console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤–∏–∑–∏—Ç–∞:", error));
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è –æ–∫–Ω–∞
        document.querySelector("#visitDetailsModal button").addEventListener("click", closeVisitDetailsModal);


        function closeVisitDetailsModal() {
            const modal = document.getElementById("visitDetailsModal");
            if (modal) {
                modal.classList.remove("active");
            }
            console.log("‚úÖ –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤–∏–∑–∏—Ç–∞ –∑–∞–∫—Ä—ã—Ç–æ");
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∏–∑–∏—Ç—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener("DOMContentLoaded", function() {
            loadFilteredVisits();
        });
        

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞
        function createFilter(filter) {
            const filterElement = document.createElement("div");
            filterElement.classList.add("filter");

            if (filter.type === 'date') {
                filterElement.innerHTML = `
                    <label for="${filter.uniquePrefix}_${filter.id}">${filter.label}</label>
                    <input type="date" id="${filter.uniquePrefix}_${filter.id}">
                `;
            } else {
                filterElement.innerHTML = `
                    <label for="${filter.uniquePrefix}_${filter.id}Select">${filter.label}</label>
                    <select id="${filter.uniquePrefix}_${filter.id}Select">
                        <option value="">–í—Å–µ</option>
                    </select>
                `;
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞
                loadSelectData(filter.id, filter.url, filter.name);
            }
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª–∏–∞–ª–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–±–∏–Ω–µ—Ç–æ–≤
            if (filter.id === 'branch') {
                filterElement.querySelector("select").addEventListener("change", function () {
                    const branchId = this.value;
                    updateRoomFilter(branchId);  // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–±–∏–Ω–µ—Ç—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∏–ª–∏–∞–ª–∞
                });
            }
            const branchSelect = document.getElementById("filter_branchSelect");
            if (branchSelect && branchSelect.value) {
                updateRoomFilter(branchSelect.value);
            }


            filtersContainer.appendChild(filterElement);
        }

        function createDoctorFilter() {
    const specializationSelect = document.getElementById("filter_specializationSelect");

    // –ï—Å–ª–∏ –Ω–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏, –ø—Ä–æ–±—É–µ–º –µ—â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ 100 –º—Å
    if (!specializationSelect) {
        setTimeout(createDoctorFilter, 100);
        return;
    }

    // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ –≤—Ä–∞—á–∞
    const doctorFilterContainer = document.createElement("div");
    doctorFilterContainer.classList.add("filter");
    doctorFilterContainer.id = "doctorFilterContainer";

    // –ü–æ–ª–µ –≤–≤–æ–¥–∞ —Å –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ–º
    const searchInput = document.createElement("input");
    searchInput.type = "text";
    searchInput.id = "doctorSearchInput";
    searchInput.placeholder = "üîç –í–≤–µ–¥–∏—Ç–µ –∏–º—è –≤—Ä–∞—á–∞...";
    searchInput.style.width = "100%";
    searchInput.style.marginBottom = "5px";

    // –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –≤—Ä–∞—á–µ–π
    const doctorList = document.createElement("ul");
    doctorList.id = "doctorList";
    doctorList.style.listStyle = "none";
    doctorList.style.padding = "0";
    doctorList.style.margin = "0";
    doctorList.style.maxHeight = "150px";
    doctorList.style.overflowY = "auto";
    doctorList.style.border = "1px solid #ccc";
    doctorList.style.borderRadius = "5px";
    doctorList.style.display = "none"; // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

    // –î–æ–±–∞–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    doctorFilterContainer.appendChild(searchInput);
    doctorFilterContainer.appendChild(doctorList);
    specializationSelect.parentNode.after(doctorFilterContainer);

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Ä–∞—á–µ–π
    function loadDoctors(specializationId) {
        let url = "/api/doctors/";
        if (specializationId) {
            url = `/api/doctors-by-specialization/${specializationId}/`;
        }

        fetch(url)
            .then(response => response.json())
            .then(data => {
                doctorList.innerHTML = "";
                data.forEach(doctor => {
                    const li = document.createElement("li");
                    li.textContent = doctor.fool_name;
                    li.dataset.id = doctor.id;
                    li.style.padding = "5px";
                    li.style.cursor = "pointer";
                    li.onclick = () => selectDoctor(doctor.id, doctor.fool_name);
                    doctorList.appendChild(li);
                });
                console.log("‚úÖ –í—Ä–∞—á–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:", data);
            })
            .catch(error => console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Ä–∞—á–µ–π:", error));
    }

    // –§—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ –≤—Ä–∞—á–∞
    function selectDoctor(id, name) {
        searchInput.value = name;
        doctorList.style.display = "none";
        console.log(`‚úÖ –í—ã–±—Ä–∞–Ω –≤—Ä–∞—á: ${name} (ID: ${id})`);
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤—Ä–∞—á–∞ –≤ —Å–∫—Ä—ã—Ç–æ–º –ø–æ–ª–µ
        searchInput.dataset.selectedId = id;
    }

    // –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –≤—Ä–∞—á–µ–π
    function filterDoctors() {
        const searchText = searchInput.value.toLowerCase();
        const items = doctorList.getElementsByTagName("li");
        let hasMatches = false;

        Array.from(items).forEach(item => {
            if (item.textContent.toLowerCase().includes(searchText)) {
                item.style.display = "";
                hasMatches = true;
            } else {
                item.style.display = "none";
            }
        });

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
        doctorList.style.display = hasMatches ? "block" : "none";
    }

    // –ü—Ä–∏ –≤–≤–æ–¥–µ —Ç–µ–∫—Å—Ç–∞ —Ñ–∏–ª—å—Ç—Ä—É–µ–º –≤—Ä–∞—á–µ–π
    searchInput.addEventListener("input", filterDoctors);

    // –ü—Ä–∏ —Ñ–æ–∫—É—Å–µ –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
    searchInput.addEventListener("focus", () => {
        doctorList.style.display = "block";
    });

    // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞ (—Å –∑–∞–¥–µ—Ä–∂–∫–æ–π, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –∫–ª–∏–∫–Ω—É—Ç—å)
    searchInput.addEventListener("blur", () => {
        setTimeout(() => {
            doctorList.style.display = "none";
        }, 200);
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å –∑–∞–≥—Ä—É–∑–∫–æ–π –≤—Å–µ—Ö –≤—Ä–∞—á–µ–π
    loadDoctors();

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    specializationSelect.addEventListener("change", function () {
        const specializationId = this.value;
        loadDoctors(specializationId);
    });

    console.log("‚úÖ –§–∏–ª—å—Ç—Ä –≤—Ä–∞—á–∞ —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º –ø–æ–∏—Å–∫–æ–º —Å–æ–∑–¥–∞–Ω.");
}












        createDoctorFilter();
        // –°–æ–∑–¥–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –≤—Å–µ—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
        filters.forEach(filter => {
            createFilter(filter);
        });



        


        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø–æ –∫–Ω–æ–ø–∫–µ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã"
// –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø–æ –∫–Ω–æ–ø–∫–µ "–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã"
document.getElementById("applyFiltersBtn").addEventListener('click', function () {
    const appliedFilters = {};

    const doctorSearchInput = document.getElementById("doctorSearchInput");
    if (doctorSearchInput && doctorSearchInput.dataset.selectedId) {
        appliedFilters['doctor'] = doctorSearchInput.dataset.selectedId;
    }

    filters.forEach(filter => {
        const element = document.getElementById(`${filter.uniquePrefix}_${filter.id}${filter.type === 'date' ? '' : 'Select'}`);
        if (element && element.value) {
            // üëá –ü—Ä–∞–≤–∏–ª—å–Ω–æ —Ñ–æ—Ä–º–∏—Ä—É–µ–º –∫–ª—é—á–∏ –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞
            let filterKey;
            switch (filter.id) {
                case 'branch':
                    filterKey = 'clinic_branch';
                    break;
                case 'room':
                    filterKey = 'clinic_room';
                    break;
                case 'specialization':
                    filterKey = 'specialization';
                    break;
                case 'doctor':
                    filterKey = 'doctor';
                    break;
                case 'patient':
                    filterKey = 'patient';
                    break;
                case 'start_date':
                    filterKey = 'start_date';
                    break;
                case 'end_date':
                    filterKey = 'end_date';
                    break;
                default:
                    filterKey = filter.id;
            }
            appliedFilters[filterKey] = element.value;
        }
    });

    console.log("üöÄ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä:", appliedFilters);  // –õ–æ–≥ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
    filterVisitsByFilters(appliedFilters);
    filteredVisitsContainer.style.display = "flex";
    filtersBlock.style.display = "none";
});


        // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
        function getCSRFToken() {
            return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        }
    });
</script>



        
        
        
        
</body>
</html>