<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞–ª–µ–Ω–¥–∞—Ä—å –∑–∞–ø–∏—Å–µ–π</title>
    <meta name="csrf-token" content="{{ csrf_token }}">
    <link rel="stylesheet" href="https://uicdn.toast.com/calendar/latest/toastui-calendar.min.css" />

    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f8f9fa;
            margin: 20px;
        }
        h1 { font-size: 24px; }
        #calendar { width: 90%; height: 800px; margin: auto; border: 1px solid #ccc; border-radius: 10px; background: white; }
        .controls { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
        button { padding: 10px 15px; font-size: 16px; cursor: pointer; border: none; background: #007bff; color: white; border-radius: 5px; }
        button:hover { background: #0056b3; }
        .modal { display: none; position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 5px; box-shadow: 0px 0px 10px rgba(0,0,0,0.5); width: 400px; }
        .modal.active { display: block; }
        select, input { width: 100%; margin-top: 5px; padding: 8px; }
        .error { color: red; font-size: 14px; }
        
        .error-input {
            border: 2px solid red !important;
            background-color: #ffe6e6;
        }
        
    </style>
</head>
<body>
    <h1>–ö–∞–ª–µ–Ω–¥–∞—Ä—å –∑–∞–ø–∏—Å–µ–π</h1>

    <div class="controls">
        <button data-nav="prev">‚¨Ö –ù–∞–∑–∞–¥</button>
        <button data-nav="next">–í–ø–µ—Ä–µ–¥ ‚û°</button>
        <button data-view="day">–î–µ–Ω—å</button>
        <button data-view="week">–ù–µ–¥–µ–ª—è</button>
        <button data-view="month">–ú–µ—Å—è—Ü</button>
        <button data-action="reload">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>

    <div id="calendar"></div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏ -->
    <div id="modal" class="modal">
        <h2>–°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å</h2>
        <div id="error-message" class="error"></div>
        <label>–ü–∞—Ü–∏–µ–Ω—Ç:
            <select id="patientSelect"></select>
        </label>
        <label>–í—Ä–∞—á:
            <select id="doctorSelect"></select>
        </label>
        <label>–ú–µ–¥—Å–µ—Å—Ç—Ä–∞:
            <select id="nurseSelect"></select>
        </label>
        <label>–î–∞—Ç–∞ –≤–∏–∑–∏—Ç–∞:
            <input type="date" id="visitDate">
        </label>
        <label>–í—Ä–µ–º—è –≤–∏–∑–∏—Ç–∞:
            <input type="time" id="visitTime">
        </label>

        <label>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–∏–∑–∏—Ç–∞:
            <select id="durationSelect">
                <option value="5">5 –º–∏–Ω—É—Ç</option>
                <option value="10">10 –º–∏–Ω—É—Ç</option>
                <option value="15">15 –º–∏–Ω—É—Ç</option>
                <option value="20">20 –º–∏–Ω—É—Ç</option>
                <option value="30">30 –º–∏–Ω—É—Ç</option>
                <option value="45">45 –º–∏–Ω—É—Ç</option>
                <option value="50">50 –º–∏–Ω—É—Ç</option>
                <option value="55">55 –º–∏–Ω—É—Ç</option>
                <option value="60">1 —á–∞—Å</option>
                <option value="custom">–ë–æ–ª–µ–µ...</option>
            </select>
        </label>
        <label>–û–∫–æ–Ω—á–∞–Ω–∏–µ –≤–∏–∑–∏—Ç–∞:
            <input type="time" id="visitEndTime" disabled>
        </label>
        
        <label>–£—Å–ª—É–≥–∏:
            <select id="servicesSelect" multiple></select>
        </label>
        <label>–§–∏–ª–∏–∞–ª:
            <select id="branchSelect" onchange="updateRooms()"></select>
        </label>
        
        <label>–ö–∞–±–∏–Ω–µ—Ç:
            <select id="roomSelect"></select>
        </label>
        <label>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:
            <input type="number" id="totalPrice" step="0.01">
        </label>
        <label>–û–ø–∏—Å–∞–Ω–∏–µ:
            <textarea id="description" rows="3"></textarea>
        </label>
        <label>–°—Ç–∞—Ç—É—Å:
            <select id="statusSelect">
                <option value="pending">–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</option>
                <option value="paid">–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞</option>
                <option value="completed">–ü—Ä–æ–≤–µ–¥–µ–Ω–æ</option>
                <option value="paid_finish">–û–ø–ª–∞—á–µ–Ω–æ</option>
            </select>
        </label>
        <label>
            <input type="checkbox" id="isOnline"> –û–Ω–ª–∞–π–Ω –ø—Ä–∏–µ–º
        </label>
        
        <button id="createVisitBtn">–°–æ–∑–¥–∞—Ç—å</button>
        <button onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
        
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º TUI Calendar -->
    <script src="https://uicdn.toast.com/calendar/latest/toastui-calendar.min.js"></script>
    <script>
        function closeModal() {
            document.getElementById("modal").classList.remove("active");
            document.getElementById("error-message").innerText = ""; // –û—á–∏—Å—Ç–∫–∞ –æ—à–∏–±–æ–∫
        }

        document.addEventListener("DOMContentLoaded", function () {
            console.log("üì¢ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è...");

            const calendar = new tui.Calendar("#calendar", {
                defaultView: "week", // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–µ–¥–µ–ª—è
                useCreationPopup: false,
                useDetailPopup: true,
                isReadOnly: false,
                draggable: true,
                resizable: true,
                week: { 
                    startDayOfWeek: 1, // –ù–µ–¥–µ–ª—è –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞
                    hourStart: 0,       // –í—Ä–µ–º—è —Å 00:00
                    hourEnd: 24,        // –î–æ 24:00
                    timeGridHourFormat: 'HH:mm' // üî• –í—Ä–µ–º—è –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ 24 —á–∞—Å–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 13:00 –≤–º–µ—Å—Ç–æ 1PM)
                },
                day: {
                    hourStart: 0,
                    hourEnd: 24,
                    timeGridHourFormat: "HH:mm" // üî• –î–ª—è –¥–Ω–µ–≤–Ω–æ–≥–æ –≤–∏–¥–∞ —Ç–æ–∂–µ 24-—á–∞—Å–æ–≤–æ–π —Ñ–æ—Ä–º–∞—Ç
                },
                month: { 
                    daynames: ["–ü–Ω", "–í—Ç", "–°—Ä", "–ß—Ç", "–ü—Ç", "–°–±","–í—Å"] 
                }
            });

            // ‚úÖ –§—É–Ω–∫—Ü–∏—è —Å–º–µ–Ω—ã –≤–∏–¥–∞ (–î–µ–Ω—å / –ù–µ–¥–µ–ª—è / –ú–µ—Å—è—Ü)
            function changeView(view) {
                calendar.changeView(view); // –ú–µ–Ω—è–µ—Ç –≤–∏–¥ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
            }

            // ‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ —Å–º–µ–Ω—ã –≤–∏–¥–∞
            document.querySelector("button[data-view='day']").addEventListener("click", function() {
                changeView("day");
            });
            document.querySelector("button[data-view='week']").addEventListener("click", function() {
                changeView("week");
            });
            document.querySelector("button[data-view='month']").addEventListener("click", function() {
                changeView("month");
            });

            function getCSRFToken() {
                return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            }

            function showError(message) {
                document.getElementById("error-message").innerText = message;
            }

            function loadSelectOptions(url, selectId, formatFunction) {
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        let select = document.getElementById(selectId);
                        select.innerHTML = data.map(formatFunction).join("");
                    })
                    .catch(error => console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", error));
            }

            function formatServiceOption(service) {
                return `<option value="${service.id}">${service.service_code} - ${service.service_name} - ${service.service_price} –≥—Ä–Ω</option>`;
            }

            function formatUserOption(user) {
                return `<option value="${user.id}">${user.full_name || user.fool_name}</option>`;
            }
            function loadBranches() {
                fetch("/medicalCRM/api/branches/", { credentials: "include" })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª–∏–∞–ª–æ–≤: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        let branchSelect = document.getElementById("branchSelect");
                        branchSelect.innerHTML = data.map(branch => 
                            `<option value="${branch.id}">${branch.branch_name}</option>`
                        ).join("");
            
                        if (data.length > 0) {
                            branchSelect.value = data[0].id;
                            updateRooms();
                        }
                    })
                    .catch(error => console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª–∏–∞–ª–æ–≤:", error));
            }
            
            function updateRooms() {
                let branchId = document.getElementById("branchSelect").value;
                if (!branchId) return;
            
                fetch("/medicalCRM/api/rooms/?branch=" + branchId)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (!Array.isArray(data)) {
                            throw new Error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö: –æ–∂–∏–¥–∞–µ—Ç—Å—è –º–∞—Å—Å–∏–≤");
                        }
            
                        let roomSelect = document.getElementById("roomSelect");
                        roomSelect.innerHTML = data.map(room => 
                            `<option value="${room.id}">${room.room_number}</option>`
                        ).join("");
                    })
                    .catch(error => console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–±–∏–Ω–µ—Ç–æ–≤:", error));
            }
            

            function loadVisits() {
                fetch("/api/visits/")
                    .then(response => response.json())
                    .then(data => {
                        console.log("üì• –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –≤–∏–∑–∏—Ç—ã:", data);  // –ü—Ä–æ–≤–µ—Ä—è–µ–º API
                        let schedules = data.map(v => ({
                            id: v.id.toString(),
                            title: `${v.patient_name} - ${v.doctor_name || "?"}`,
                            category: "time",
                            start: v.visit_date + "T" + v.visit_time,
                            end: v.visit_date + "T" + (v.visit_end_time || v.visit_time), // ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ (–∑–∞–º–µ–Ω–∏–ª–∏ `=` –Ω–∞ `:`)
                            bgColor: "#36A2EB"
                        }));
                        calendar.clear();
                        calendar.createEvents(schedules);
                    })
                    .catch(error => console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ API:", error));
            }
            // ‚úÖ –ö–Ω–æ–ø–∫–∏ –¥–ª—è —Å–º–µ–Ω—ã –ø–µ—Ä–∏–æ–¥–∞ (–ù–∞–∑–∞–¥ / –í–ø–µ—Ä–µ–¥)
            document.querySelector("button[data-nav='prev']").addEventListener("click", function() {
                calendar.prev();
            });
            document.querySelector("button[data-nav='next']").addEventListener("click", function() {
                calendar.next();
            });

            // ‚úÖ –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π
            document.querySelector("button[data-action='reload']").addEventListener("click", function() {
                loadVisits();
            });

            function openModal() {
                document.getElementById("modal").classList.add("active");
                loadSelectOptions("/api/doctors/", "doctorSelect", formatUserOption);
                loadSelectOptions("/api/patients/", "patientSelect", formatUserOption);
                loadSelectOptions("/api/nurses/", "nurseSelect", formatUserOption);
                loadSelectOptions("/api/services/", "servicesSelect", formatServiceOption);
                loadBranches();
            }

            document.getElementById("durationSelect").addEventListener("change", function() {
                let endTimeInput = document.getElementById("visitEndTime");
            
                if (this.value === "custom") {
                    endTimeInput.removeAttribute("disabled"); // ‚úÖ –†–∞–∑—Ä–µ—à–∞–µ–º –≤–≤–æ–¥ –≤—Ä—É—á–Ω—É—é
                } else {
                    endTimeInput.setAttribute("disabled", "true"); // ‚ùå –ë–ª–æ–∫–∏—Ä—É–µ–º –≤–≤–æ–¥
                    let visitTimeInput = document.getElementById("visitTime").value;
                    if (!visitTimeInput) {
                        alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –ø—Ä–∏—ë–º–∞!");
                        this.value = "custom"; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫ "–ë–æ–ª–µ–µ..."
                        return;
                    }
            
                    let [hours, minutes] = visitTimeInput.split(":").map(Number);
                    let durationMinutes = parseInt(this.value);
                    let endMinutes = minutes + durationMinutes;
            
                    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—Ä–µ–º—è
                    if (endMinutes >= 60) {
                        hours += Math.floor(endMinutes / 60);
                        endMinutes = endMinutes % 60;
                    }
            
                    endTimeInput.value = `${String(hours).padStart(2, "0")}:${String(endMinutes).padStart(2, "0")}`;
                }
            });
            
            
            // ‚úÖ –ü–æ–∑–≤–æ–ª—è–µ–º –≤—Ä—É—á–Ω—É—é –∑–∞–¥–∞–≤–∞—Ç—å –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
            document.getElementById("visitEndTime").addEventListener("change", function () {
                let visitTimeInput = document.getElementById("visitTime").value;
                let visitEndTimeInput = this.value;
            
                if (!visitTimeInput || !visitEndTimeInput) return;
            
                let [startHours, startMinutes] = visitTimeInput.split(":").map(Number);
                let [endHours, endMinutes] = visitEndTimeInput.split(":").map(Number);
            
                let totalMinutes = (endHours * 60 + endMinutes) - (startHours * 60 + startMinutes);

                // ‚ùå –ù–æ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º alert —Å—Ä–∞–∑—É! –ü—Ä–æ–≤–µ—Ä–∏–º —ç—Ç–æ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Ñ–æ—Ä–º—ã
                if (totalMinutes <= 0) {
                    this.dataset.invalid = "true"; // –ü–æ–º–µ—á–∞–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ
                } else {
                    delete this.dataset.invalid; // –ï—Å–ª–∏ –≤—Å—ë –æ–∫, —É–¥–∞–ª—è–µ–º –∞—Ç—Ä–∏–±—É—Ç
                }
            
                document.getElementById("durationSelect").value = "custom"; // –ï—Å–ª–∏ –≤—Ä—É—á–Ω—É—é –≤–≤–æ–¥–∏–º, —Å—Ç–∞–≤–∏–º "–ë–æ–ª–µ–µ..."
            });
            
            // ‚úÖ –ü–æ–∑–≤–æ–ª—è–µ–º —Ä–∞—Å—Ç—è–≥–∏–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ –∏ –æ–±–Ω–æ–≤–ª—è—Ç—å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
            calendar.on("beforeUpdateEvent", function ({ event, changes }) {
                console.log("üõ† –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è:", event, changes);
            
                let visitId = parseInt(event.id);
                if (isNaN(visitId) || visitId < 1) {
                    console.error("‚ùå –û—à–∏–±–∫–∞: –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π visitId", event);
                    return;
                }
            
                let updatedData = {};
            
                // ‚úÖ –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ (–∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–Ω—è –∏ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞—á–∞–ª–∞)
                if (changes.start) {
                    let newStart = new Date(changes.start);
                    updatedData.visit_date = newStart.toISOString().split("T")[0]; // –ù–æ–≤–∞—è –¥–∞—Ç–∞
                    updatedData.visit_time = formatTime(newStart); // –ù–æ–≤–æ–µ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞
                }
            
                // ‚úÖ –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è (–∑–Ω–∞—á–∏—Ç —Å–æ–±—ã—Ç–∏–µ —Ä–∞—Å—Ç—è–Ω—É–ª–∏)
                if (changes.end) {
                    let newEnd = new Date(changes.end);
                    let newStart = new Date(event.start);
            
                    let durationMinutes = Math.round((newEnd - newStart) / (1000 * 60));
            
                    
                    // üî• –ï—Å–ª–∏ —Ä–∞–∑–Ω–∏—Ü–∞ –≤ –º–∏–Ω—É—Ç–∞—Ö –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è, –∏—Å–ø—Ä–∞–≤–ª—è–µ–º –µ—ë
                    if (durationMinutes < 1) {
                        console.error("‚ùå –û—à–∏–±–∫–∞: duration_minutes < 1! –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ 5 –º–∏–Ω—É—Ç...");
                        durationMinutes = 5; // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å 5 –º–∏–Ω—É—Ç
                    }  
            
                    updatedData.visit_end_time = formatTime(newEnd);
                    updatedData.duration_minutes = durationMinutes;
                }


            
                // ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                updateVisitOnServer(visitId, updatedData);
            
                // ‚úÖ –í–∏–∑—É–∞–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ (–±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
                calendar.updateEvent(event.id, event.calendarId, {
                    start: changes.start || event.start,
                    end: changes.end || event.end
                });
            });
            
            
            // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –≤ HH:mm
            function formatTime(dateInput) {
                let dateObj = new Date(dateInput);
                let hours = String(dateObj.getHours()).padStart(2, "0");
                let minutes = String(dateObj.getMinutes()).padStart(2, "0");
                return `${hours}:${minutes}`;
            }
            
            
            function createVisit() {
                let visitTimeInput = document.getElementById("visitTime");
                let visitEndTimeInput = document.getElementById("visitEndTime");
                let selectedDuration = document.getElementById("durationSelect").value;
                let selectedServices = Array.from(document.getElementById("servicesSelect").selectedOptions).map(o => o.value);
            
                let requiredFields = [
                    { id: "patientSelect", message: "–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞" },
                    { id: "doctorSelect", message: "–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–∞—á–∞" },
                    { id: "visitDate", message: "–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –≤–∏–∑–∏—Ç–∞" },
                    { id: "visitTime", message: "–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –≤–∏–∑–∏—Ç–∞" }
                ];
            
                document.querySelectorAll(".error-input").forEach(field => {
                    field.classList.remove("error-input");
                });
            
                let missingFields = [];
            
                requiredFields.forEach(field => {
                    let inputElement = document.getElementById(field.id);
                    if (!inputElement.value) {
                        inputElement.classList.add("error-input");
                        missingFields.push(field.message);
                    }
                });
            
                if (missingFields.length > 0) {
                    alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è:\n- " + missingFields.join("\n- "));
                    return;
                }
            
                let [startHours, startMinutes] = visitTimeInput.value.split(":").map(Number);
                let visit_end_time = visitEndTimeInput.value || "";
                let duration_minutes = null;
            
                if (selectedDuration !== "custom") {
                    let duration = parseInt(selectedDuration);
                    let endMinutes = startMinutes + duration;
            
                    if (endMinutes >= 60) {
                        startHours += Math.floor(endMinutes / 60);
                        endMinutes = endMinutes % 60;
                    }
            
                    visit_end_time = `${String(startHours).padStart(2, "0")}:${String(endMinutes).padStart(2, "0")}`;
                    duration_minutes = duration;
                }
            
                if (selectedDuration === "custom" && visitEndTimeInput.value) {
                    let [endHours, endMinutes] = visitEndTimeInput.value.split(":").map(Number);
                    let startTimeInMinutes = startHours * 60 + startMinutes;
                    let endTimeInMinutes = endHours * 60 + endMinutes;
            
                    if (endTimeInMinutes <= startTimeInMinutes) {
                        alert("–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–∑–∂–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞—á–∞–ª–∞!");
                        visitEndTimeInput.classList.add("error-input");
                        return;
                    }
            
                    duration_minutes = endTimeInMinutes - startTimeInMinutes;
                }
            
                // üõ† **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–¥–∞—á–∏ `services`**
                let servicesToSend = selectedServices.length > 0 ? selectedServices : [];
            
                let visitData = {
                    patient: document.getElementById("patientSelect").value,
                    doctor: document.getElementById("doctorSelect").value || null,
                    nurse: document.getElementById("nurseSelect").value || null,
                    visit_date: document.getElementById("visitDate").value,
                    visit_time: visitTimeInput.value,
                    visit_end_time: visit_end_time,
                    duration_minutes: duration_minutes ?? null,
                    services: servicesToSend,  // ‚úÖ –¢–µ–ø–µ—Ä—å –µ—Å–ª–∏ –ø—É—Å—Ç–æ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º `[]`
                    total_price: parseFloat(document.getElementById("totalPrice").value) || 0.00,
                    payment_status: document.getElementById("statusSelect").value,
                    is_online: document.getElementById("isOnline").checked,
                    description: document.getElementById("description").value,
                    clinic_branch: document.getElementById("branchSelect").value,
                    clinic_room: document.getElementById("roomSelect").value
                };
            
                console.log("üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö:", visitData);
            
                fetch("/api/visits/", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "X-CSRFToken": getCSRFToken() },
                    body: JSON.stringify(visitData)
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errData => {
                            console.error("‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:", errData);
                            alert("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–∑–∏—Ç–∞: " + JSON.stringify(errData));
                            throw new Error("Bad Request");
                        });
                    }
                    return response.json();
                })
                .then(() => {
                    closeModal();
                    loadVisits();
                })
                .catch(error => console.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–∑–∏—Ç–∞!", error));
            }

            // ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ —Å–æ–±—ã—Ç–∏–π
            calendar.on("beforeUpdateEvent", function ({ event, changes }) {
                console.log("üõ† –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è:", event);
            
                let visitId = parseInt(event.id);
                if (isNaN(visitId) || visitId < 1) {
                    console.error("‚ùå –û—à–∏–±–∫–∞: –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π visitId", event);
                    return;
                }
            
                let updatedData = {};
                if (changes.start) {
                    let newStart = new Date(changes.start);
                    updatedData.visit_date = newStart.toISOString().split("T")[0];
                    updatedData.visit_time = formatTime(newStart);
                }
            
                if (changes.end) {
                    let newEnd = new Date(changes.end);
                    updatedData.visit_end_time = formatTime(newEnd);
                    updatedData.duration_minutes = Math.round((newEnd - new Date(event.start)) / (1000 * 60));
                }
            
                updateVisitOnServer(visitId, updatedData);
            });

            // ‚úÖ –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ API
            function updateVisitOnServer(visitId, updatedData) {
                    // üõ† –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—É—é –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
                if (updatedData.duration_minutes < 0) {
                    console.error("‚ùå –û—à–∏–±–∫–∞: duration_minutes < 0! –î–∞–Ω–Ω—ã–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã:", updatedData);
                    return;
                }
                console.log("üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:", updatedData);  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤ –∫–æ–Ω—Å–æ–ª–∏
                fetch(`/api/visits/${visitId}/`, {
                    method: "PATCH",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCSRFToken()
                    },
                    body: JSON.stringify(updatedData)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∏–∑–∏—Ç–∞!");
                        return response.json().then(errData => {
                            console.error("‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:", errData);
                            alert("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∏–∑–∏—Ç–∞: " + JSON.stringify(errData));
                            throw new Error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∏–∑–∏—Ç–∞!");
                        });
                    }
                    return response.json();
                })
                .then(() => {
                    loadVisits(); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                })
                .catch(error => console.error("‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:", error));
            }

            // ‚úÖ –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –≤ HH:mm
            function formatTime(dateObj) {
                let hours = String(dateObj.getHours()).padStart(2, "0");
                let minutes = String(dateObj.getMinutes()).padStart(2, "0");
                return `${hours}:${minutes}`;
            }

            
            
            
            document.getElementById("createVisitBtn").addEventListener("click", createVisit);

            calendar.on("selectDateTime", function () {
                openModal();
            });

            loadVisits();
        });
    </script>
</body>
</html>
