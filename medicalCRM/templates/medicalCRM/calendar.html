{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞–ª–µ–Ω–¥–∞—Ä—å –∑–∞–ø–∏—Å–µ–π</title>
    <meta name="csrf-token" content="{{ csrf_token }}">
    <!-- <link rel="stylesheet" href="https://uicdn.toast.com/calendar/latest/toastui-calendar.min.css" /> -->

    <link rel="stylesheet" href="{% static 'css/toastui-calendar.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/custom-calendar.css' %}">


    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f8f9fa;
            margin: 20px;
        }
        h1 { font-size: 24px; }
        #calendar { width: 90%; height: 800px; margin: auto; border: 1px solid #ccc; border-radius: 10px; background: white; }
        .controls { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
        button { padding: 10px 15px; font-size: 16px; cursor: pointer; border: none; background: #bb0000; color: white; border-radius: 5px; }
        button:hover { background:rgba(187, 0, 0, 0.46); }
        .modal { display: none; position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 5px; box-shadow: 0px 0px 10px rgba(0,0,0,0.5); width: 400px; }
        .modal.active { display: block; }
        select, input { width: 100%; margin-top: 5px; padding: 8px; }
    </style>
</head>
<body>
    <h1>–ö–∞–ª–µ–Ω–¥–∞—Ä—å –∑–∞–ø–∏—Å–µ–π</h1>

    <div class="controls">
        <button data-nav="prev">‚¨Ö –ù–∞–∑–∞–¥</button>
        <button data-nav="next">–í–ø–µ—Ä–µ–¥ ‚û°</button>
        <button data-view="day">–î–µ–Ω—å</button>
        <button data-view="week">–ù–µ–¥–µ–ª—è</button>
        <button data-view="month">–ú–µ—Å—è—Ü</button>
        <button data-action="reload">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>

    <div id="calendar"></div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏ -->
    <div id="modal" class="modal">
        <h2>–°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å</h2>
        <div id="error-message" class="error"></div>
        <label>–ü–∞—Ü–∏–µ–Ω—Ç:
            <select id="patientSelect"></select>
        </label>
        <label>–í—Ä–∞—á:
            <select id="doctorSelect"></select>
        </label>
        <label>–ú–µ–¥—Å–µ—Å—Ç—Ä–∞:
            <select id="nurseSelect"></select>
        </label>
        <label>–î–∞—Ç–∞ –≤–∏–∑–∏—Ç–∞:
            <input type="date" id="visitDate">
        </label>
        <label>–í—Ä–µ–º—è –≤–∏–∑–∏—Ç–∞:
            <input type="time" id="visitTime">
        </label>

        <label>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–∏–∑–∏—Ç–∞:
            <select id="durationSelect">
                <option value="5">5 –º–∏–Ω—É—Ç</option>
                <option value="10">10 –º–∏–Ω—É—Ç</option>
                <option value="15">15 –º–∏–Ω—É—Ç</option>
                <option value="20">20 –º–∏–Ω—É—Ç</option>
                <option value="30">30 –º–∏–Ω—É—Ç</option>
                <option value="45">45 –º–∏–Ω—É—Ç</option>
                <option value="50">50 –º–∏–Ω—É—Ç</option>
                <option value="55">55 –º–∏–Ω—É—Ç</option>
                <option value="60">1 —á–∞—Å</option>
                <option value="custom">–ë–æ–ª–µ–µ...</option>
            </select>
        </label>
        <label>–û–∫–æ–Ω—á–∞–Ω–∏–µ –≤–∏–∑–∏—Ç–∞:
            <input type="time" id="visitEndTime" disabled>
        </label>

        <div>
            <label>–ü–æ–∏—Å–∫ —É—Å–ª—É–≥–∏:</label>
            <input type="text" id="serviceSearch" placeholder="üîé –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ, –∫–æ–¥..." oninput="filterServices()">
        </div>
        
        <div class="service-selection-container">
            <div class="service-list">
                <h3>–î–æ—Å—Ç—É–ø–Ω—ã–µ —É—Å–ª—É–≥–∏</h3>
                <ul id="availableServices"></ul>
            </div>
        
            <div class="selected-service-list">
                <h3>–í—ã–±—Ä–∞–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏</h3>
                <ul id="selectedServices"></ul>
            </div>
        </div>
        <input type="hidden" id="selectedServiceIds" name="selected_services">

        <label>–°–∫–∏–¥–∫–∞ (% –Ω–∞ –≤—Å–µ —É—Å–ª—É–≥–∏ –∏–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ):
            <input type="number" id="discountPercent" min="0" max="100" step="0.1" value="0">
        </label>
        <label>–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–∫–∏–¥–∫—É —Ç–æ–ª—å–∫–æ –∫ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —É—Å–ª—É–≥–∞–º:
            <select multiple id="discountedServicesSelect"></select>
        </label>
        
        
        <label>–§–∏–ª–∏–∞–ª:
            <select id="branchSelect" onchange="updateRooms('branchSelect', 'roomSelect')"></select>
        </label>
        
        <label>–ö–∞–±–∏–Ω–µ—Ç:
            <select id="roomSelect"></select>
        </label>

        <label>–û–ø–∏—Å–∞–Ω–∏–µ:
            <textarea id="description" rows="3"></textarea>
        </label>
        <label>–°—Ç–∞—Ç—É—Å:
            <select id="statusSelect">
                <option value="pending">–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</option>
                <option value="paid">–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞</option>
                <option value="completed">–ü—Ä–æ–≤–µ–¥–µ–Ω–æ</option>
                <option value="paid_finish">–û–ø–ª–∞—á–µ–Ω–æ</option>
            </select>
        </label>
        <label>–û–Ω–ª–∞–π–Ω –ø—Ä–∏–µ–º:
            <input type="checkbox" id="isOnline">
        </label>


        <label>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:
            <input type="number" id="finalPrice" step="0.01" readonly>
        </label>
        
        <button id="createVisitBtn">–°–æ–∑–¥–∞—Ç—å</button>
        <button onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
        
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∏–∑–∏—Ç–∞ -->
<div id="editModal" class="modal">
    <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∏–∑–∏—Ç–∞</h2>
    <div id="edit-error-message" class="error"></div>

    <label>–ü–∞—Ü–∏–µ–Ω—Ç:
        <select id="editPatientSelect"></select>
    </label>
    <label>–í—Ä–∞—á:
        <select id="editDoctorSelect"></select>
    </label>
    <label>–ú–µ–¥—Å–µ—Å—Ç—Ä–∞:
        <select id="editNurseSelect"></select>
    </label>
    <label>–î–∞—Ç–∞ –≤–∏–∑–∏—Ç–∞:
        <input type="date" id="editVisitDate">
    </label>
    <label>–í—Ä–µ–º—è –≤–∏–∑–∏—Ç–∞:
        <input type="time" id="editVisitTime">
    </label>
    <label>–û–∫–æ–Ω—á–∞–Ω–∏–µ –≤–∏–∑–∏—Ç–∞:
        <input type="time" id="editVisitEndTime">
    </label>

    <div>
        <label>–ü–æ–∏—Å–∫ —É—Å–ª—É–≥–∏:</label>
        <input type="text" id="editServiceSearch" placeholder="üîé –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ, –∫–æ–¥..." oninput="filterEditServices()">
    </div>
    
    <div class="service-selection-container">
        <div class="service-list">
            <h3>–î–æ—Å—Ç—É–ø–Ω—ã–µ —É—Å–ª—É–≥–∏</h3>
            <ul id="editAvailableServices"></ul>
        </div>
    
        <div class="selected-service-list">
            <h3>–í—ã–±—Ä–∞–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏</h3>
            <ul id="editSelectedServices"></ul>
        </div>
    </div>
    <input type="hidden" id="editSelectedServiceIds" name="edit_selected_services">


    <label>–°–∫–∏–¥–∫–∞ (% –Ω–∞ –≤—Å–µ —É—Å–ª—É–≥–∏ –∏–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ):
        <input type="number" id="editDiscountPercent" min="0" max="100" step="0.1" value="0">
    </label>
    <label>–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–∫–∏–¥–∫—É —Ç–æ–ª—å–∫–æ –∫ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —É—Å–ª—É–≥–∞–º:
        <select multiple id="editDiscountedServicesSelect"></select>
    </label>
    


    <label>–û–ø–∏—Å–∞–Ω–∏–µ:
        <textarea id="editDescription" rows="3"></textarea>
    </label>
    <label>–°—Ç–∞—Ç—É—Å:
        <select id="editStatusSelect">
            <option value="pending">–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</option>
            <option value="paid">–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞</option>
            <option value="completed">–ü—Ä–æ–≤–µ–¥–µ–Ω–æ</option>
            <option value="paid_finish">–û–ø–ª–∞—á–µ–Ω–æ</option>
        </select>
    </label>
    <label>–§–∏–ª–∏–∞–ª:
        <select id="editBranchSelect"></select>
    </label>
    <label>–ö–∞–±–∏–Ω–µ—Ç:
        <select id="editRoomSelect"></select>
    </label>

    <label>
        <input type="checkbox" id="editIsOnline"> –û–Ω–ª–∞–π–Ω –ø—Ä–∏—ë–º
    </label>
    <label>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:
        <input type="number" id="editTotalPrice" step="0.01">
    </label>
    

    <button id="saveEditBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button id="cancelEditBtn">–û—Ç–º–µ–Ω–∞</button>
</div>








    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º TUI Calendar -->
    <script src="https://uicdn.toast.com/calendar/latest/toastui-calendar.min.js"></script>
    <script>
        function closeModal() {
            document.getElementById("modal").classList.remove("active");
            document.getElementById("error-message").innerText = ""; // –û—á–∏—Å—Ç–∫–∞ –æ—à–∏–±–æ–∫
        }

        function updateVisitEndTime() {
            let startTimeInput = document.getElementById("visitTime").value;
            let durationSelect = document.getElementById("durationSelect").value;
            let endTimeInput = document.getElementById("visitEndTime");
        
            if (!startTimeInput) return; // –ï—Å–ª–∏ –≤—Ä–µ–º—è –Ω–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
        
            let [hours, minutes] = startTimeInput.split(":").map(Number);
            let durationMinutes = parseInt(durationSelect);
        
            if (isNaN(durationMinutes)) return; // –ï—Å–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –≤—ã—Ö–æ–¥–∏–º
        
            let endMinutes = minutes + durationMinutes;
            
            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –≤–∏–∑–∏—Ç–∞
            hours += Math.floor(endMinutes / 60);
            endMinutes %= 60;
        
            endTimeInput.value = `${String(hours).padStart(2, "0")}:${String(endMinutes).padStart(2, "0")}`;
        }

        function ensureSeconds(timeString) {
            if (!timeString) return null;
            if (timeString.length === 5) return timeString + ":00"; // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–∫—É–Ω–¥—ã, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
            return timeString; // –£–∂–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ HH:MM:SS
        }






        document.addEventListener("DOMContentLoaded", function () {
            setupServiceSelection("availableServices", "selectedServices", "selectedServiceIds");
            setupServiceSelection("editAvailableServices", "editSelectedServices", "editSelectedServiceIds");
        });

        document.getElementById("editDiscountPercent").addEventListener("input", recalculateEditTotalPrice);
        document.getElementById("editDiscountedServicesSelect").addEventListener("change", recalculateEditTotalPrice);

        function updateSelectedServices() {
            let selectedList = document.getElementById("selectedServices");
            let selectedIds = [];
        
            selectedList.querySelectorAll("li").forEach(li => {
                selectedIds.push(li.dataset.id);
            });
        
            document.getElementById("selectedServiceIds").value = selectedIds.join(",");
            console.log("üìå –í—ã–±—Ä–∞–Ω–Ω—ã–µ ID —É—Å–ª—É–≥:", selectedIds);
        }

        function recalculateTotalPrice() {
            const selectedServiceIds = document.getElementById("selectedServiceIds").value
                .split(",")
                .filter(id => id)
                .map(id => parseInt(id));
        
            const discountPercent = parseFloat(document.getElementById("discountPercent").value) || 0;
            const discountedServices = Array.from(document.getElementById("discountedServicesSelect").selectedOptions).map(opt => parseInt(opt.value));
        
            let total = 0;
        
            document.querySelectorAll("#selectedServices li").forEach(li => {
                const serviceId = parseInt(li.dataset.id);
                const priceMatch = li.textContent.match(/\(([\d.]+)\s?–≥—Ä–Ω\)/);
        
                if (priceMatch) {
                    let price = parseFloat(priceMatch[1]);
        
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–∫–∏–¥–∫—É, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –µ—ë –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —É—Å–ª—É–≥–µ
                    if (discountPercent > 0 && (discountedServices.includes(serviceId) || discountedServices.length === 0)) {
                        price = price - (price * discountPercent / 100);
                    }
        
                    total += price;
                }
            });
        
            // –û–∫—Ä—É–≥–ª—è–µ–º –¥–æ 2 –∑–Ω–∞–∫–æ–≤
            total = Math.round(total * 100) / 100;
            document.getElementById("finalPrice").value = total;
        }

        function recalculateEditTotalPrice() {
            const selectedServiceIds = document.getElementById("editSelectedServiceIds").value
                .split(",")
                .filter(id => id)
                .map(id => parseInt(id));
        
            const discountPercent = parseFloat(document.getElementById("editDiscountPercent").value) || 0;
            const discountedServices = Array.from(document.getElementById("editDiscountedServicesSelect").selectedOptions).map(opt => parseInt(opt.value));
        
            let total = 0;
        
            document.querySelectorAll("#editSelectedServices li").forEach(li => {
                const serviceId = parseInt(li.dataset.id);
                const priceMatch = li.textContent.match(/\(([\d.]+)\s?–≥—Ä–Ω\)/);
        
                if (priceMatch) {
                    let price = parseFloat(priceMatch[1]);
        
                    if (discountPercent > 0 && (discountedServices.includes(serviceId) || discountedServices.length === 0)) {
                        price = price - (price * discountPercent / 100);
                    }
        
                    total += price;
                }
            });
        
            total = Math.round(total * 100) / 100;
            document.getElementById("editTotalPrice").value = total;
        }
        
        
        // üîπ –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —É—Å–ª—É–≥–∏ –º–µ–∂–¥—É —Å–ø–∏—Å–∫–∞–º–∏
        function setupServiceSelection(availableId, selectedId, hiddenInputId) {
            const availableList = document.getElementById(availableId);
            const selectedList = document.getElementById(selectedId);
            const selectedServiceIdsInput = document.getElementById(hiddenInputId);
        

        
            function moveService(event, fromList, toList) {
                if (event.target.tagName === "LI") {
                    let item = event.target;
            
                    if (fromList.contains(item)) {
                        fromList.removeChild(item);
                        toList.appendChild(item);
            
                        // ‚úÖ –í—ã–∑–æ–≤ –Ω—É–∂–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∏–Ω–ø—É—Ç–∞
                        if (hiddenInputId === "selectedServiceIds") {
                            updateSelectedServices();
                        } else if (hiddenInputId === "editSelectedServiceIds") {
                            updateEditSelectedServices();
                        }
                    } else {
                        console.warn("‚ö†Ô∏è –≠–ª–µ–º–µ–Ω—Ç —É–∂–µ —É–¥–∞–ª–µ–Ω –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø–∏—Å–∫–µ", item);
                    }
                }
            }
        
            availableList.addEventListener("click", function (event) {
                moveService(event, availableList, selectedList);
            });
        
            selectedList.addEventListener("click", function (event) {
                moveService(event, selectedList, availableList);
            });
        }
        
        // üîπ –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É—Å–ª—É–≥ –≤ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è
        function loadServices() {
            console.log("üî• –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —É—Å–ª—É–≥...");
        
            fetch("/api/services/")
                .then(response => response.json())
                .then(data => {
                    console.log("üì• –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏:", data);
        
                    let availableList = document.getElementById("availableServices");
                    availableList.innerHTML = ""; // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
        
                    data.forEach(service => {
                        let li = document.createElement("li");
                        li.textContent = `[${service.subgroup_number}] ${service.subgroup_name} ‚Üí ${service.service_code} - ${service.service_name} (${service.service_price} –≥—Ä–Ω)`;
                        li.dataset.id = service.id;
                        li.onclick = function () {
                            selectService(this);
                        };
                        availableList.appendChild(li);
                    });

                    let discountSelect = document.getElementById("discountedServicesSelect");
                    discountSelect.innerHTML = "";

                    data.forEach(service => {
                        let option = document.createElement("option");
                        option.value = service.id;
                        option.textContent = `[${service.subgroup_number}] ${service.subgroup_name} ‚Üí ${service.service_code} - ${service.service_name} (${service.service_price} –≥—Ä–Ω)`;
                        discountSelect.appendChild(option);
                    });
        
                    console.log("‚úÖ –£—Å–ª—É–≥–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!");
                })
                .catch(error => console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Å–ª—É–≥:", error));
        }
        
        // üîπ –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —É—Å–ª—É–≥ –≤ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function loadEditServices(visitId) {
            console.log(`üî• –ó–∞–≥—Ä—É–∂–∞–µ–º —É—Å–ª—É–≥–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∏–∑–∏—Ç–∞ ID: ${visitId}`);
        
            fetch("/api/services/")
                .then(response => response.json())
                .then(allServices => {
                    console.log("üì• –í—Å–µ —É—Å–ª—É–≥–∏:", allServices);
        
                    fetch(`/api/visits/${visitId}/`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–∑–∏—Ç–∞: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(visitData => {
                            console.log("üìå –î–∞–Ω–Ω—ã–µ –≤–∏–∑–∏—Ç–∞:", visitData);
                            updateEditSelectedServices(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ ID
                            
                            let availableList = document.getElementById("editAvailableServices");
                            let selectedList = document.getElementById("editSelectedServices");
                            availableList.innerHTML = "";
                            selectedList.innerHTML = "";
        
                            if (!visitData.services || !Array.isArray(visitData.services)) {
                                console.error("‚ùå –û—à–∏–±–∫–∞: services –Ω–µ –º–∞—Å—Å–∏–≤!", visitData.services);
                                return;
                            }
        
                            let selectedServiceIds = visitData.services.map(s => s.id); // –ü–æ–ª—É—á–∞–µ–º ID –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —É—Å–ª—É–≥
                            let selectedServiceStrings = visitData.services || [];

                            allServices.forEach(service => {
                                let displayText = `[${service.subgroup_number}] ${service.subgroup_name} ‚Üí ${service.service_code} - ${service.service_name} (${service.service_price} –≥—Ä–Ω)`;
                                
                                let li = document.createElement("li");
                                li.textContent = displayText;
                                li.dataset.id = service.id;
                                li.onclick = function () {
                                    selectEditService(this);
                                };
                            
                                if (selectedServiceIds.includes(service.id)) {
                                    selectedList.appendChild(li);
                                } else {
                                    availableList.appendChild(li);
                                }
                            });

                            let editDiscountSelect = document.getElementById("editDiscountedServicesSelect");
                            editDiscountSelect.innerHTML = "";

                            allServices.forEach(service => {
                                let option = document.createElement("option");
                                option.value = service.id;
                                option.textContent = `[${service.subgroup_number}] ${service.subgroup_name} ‚Üí ${service.service_code} - ${service.service_name} (${service.service_price} –≥—Ä–Ω)`;
                                editDiscountSelect.appendChild(option);
                            });
                            
                            console.log("‚úÖ –£—Å–ª—É–≥–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è!");
                        })
                        .catch(error => console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤–∏–∑–∏—Ç–∞:", error));
                })
                .catch(error => console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö —É—Å–ª—É–≥:", error));

                
        }
        
        
        
        // üîπ –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —É—Å–ª—É–≥ –≤ –æ–∫–Ω–µ —Å–æ–∑–¥–∞–Ω–∏—è
        function filterServices() {
            let searchText = document.getElementById("serviceSearch").value.toLowerCase();
            let availableList = document.getElementById("availableServices");
        
            if (!availableList) {
                console.error("‚ùå –û—à–∏–±–∫–∞: —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É—Å–ª—É–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω!");
                return;
            }
        
            let services = availableList.getElementsByTagName("li");
        
            Array.from(services).forEach(item => {
                let text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchText) ? "" : "none";
            });
        
            console.log(`üîé –ü–æ–∏—Å–∫ —É—Å–ª—É–≥: ${searchText}`);
        }
        
        // üîπ –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —É—Å–ª—É–≥ –≤ –æ–∫–Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function filterEditServices() {
            let searchText = document.getElementById("editServiceSearch").value.toLowerCase();
            let availableList = document.getElementById("editAvailableServices");
        
            if (!availableList) {
                console.error("‚ùå –û—à–∏–±–∫–∞: —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É—Å–ª—É–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω!");
                return;
            }
        
            let services = availableList.getElementsByTagName("li");
        
            Array.from(services).forEach(item => {
                let text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchText) ? "" : "none";
            });
        
            console.log(`üîé –ü–æ–∏—Å–∫ —É—Å–ª—É–≥ (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ): ${searchText}`);
        }


        function selectService(element) {
            let selectedList = document.getElementById("selectedServices");
            let availableList = document.getElementById("availableServices");
        
            if (element.parentNode === availableList) {
                // üîπ –ü–µ—Ä–µ–º–µ—â–∞–µ–º –≤ "–í—ã–±—Ä–∞–Ω–Ω—ã–µ"
                selectedList.appendChild(element);
            } else {
                // üîπ –ü–µ—Ä–µ–º–µ—â–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ –≤ "–î–æ—Å—Ç—É–ø–Ω—ã–µ"
                availableList.appendChild(element);
            }
        
            updateSelectedServices(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ ID
            recalculateTotalPrice();

        }

        function selectEditService(element) {
            let selectedList = document.getElementById("editSelectedServices");
            let availableList = document.getElementById("editAvailableServices");
        
            if (element.parentNode === availableList) {
                // üîπ –ü–µ—Ä–µ–º–µ—â–∞–µ–º –≤ "–í—ã–±—Ä–∞–Ω–Ω—ã–µ", –Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ
                if (availableList.contains(element)) {
                    availableList.removeChild(element);
                    selectedList.appendChild(element);
                    updateEditSelectedServices(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ ID
                } else {
                    console.warn("‚ö†Ô∏è –≠–ª–µ–º–µ–Ω—Ç —É–∂–µ —É–¥–∞–ª–µ–Ω –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É—Å–ª—É–≥–∞—Ö", element);
                }
            } else {
                // üîπ –ü–µ—Ä–µ–º–µ—â–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ –≤ "–î–æ—Å—Ç—É–ø–Ω—ã–µ"
                if (selectedList.contains(element)) {
                    selectedList.removeChild(element);
                    availableList.appendChild(element);
                    updateEditSelectedServices(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ ID
                } else {
                    console.warn("‚ö†Ô∏è –≠–ª–µ–º–µ–Ω—Ç —É–∂–µ —É–¥–∞–ª–µ–Ω –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —É—Å–ª—É–≥–∞—Ö", element);
                }
            }
        }

        function updateEditSelectedServices() {
            let selectedList = document.getElementById("editSelectedServices");
            let selectedIds = [];
        
            selectedList.querySelectorAll("li").forEach(li => {
                selectedIds.push(li.dataset.id);
            });
        
            document.getElementById("editSelectedServiceIds").value = selectedIds.join(",");
            console.log("üìå –í—ã–±—Ä–∞–Ω–Ω—ã–µ ID —É—Å–ª—É–≥ (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ):", selectedIds);
        }
        






        document.addEventListener("DOMContentLoaded", function () {
            console.log("üì¢ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è...");

            // ‚úÖ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–±–∏–Ω–µ—Ç–æ–≤ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∏–ª–∏–∞–ª–∞ –≤ —Ñ–æ—Ä–º–µ —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–∑–∏—Ç–∞
            document.getElementById("branchSelect").addEventListener("change", function () {            
                updateRooms("branchSelect", "roomSelect");
            });

            // ‚úÖ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–±–∏–Ω–µ—Ç–æ–≤ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∏–ª–∏–∞–ª–∞ –≤ —Ñ–æ—Ä–º–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∏–∑–∏—Ç–∞
            document.getElementById("editBranchSelect").addEventListener("change", function () {            
                updateRooms("editBranchSelect", "editRoomSelect");
            });

            const saveEditBtn = document.getElementById("saveEditBtn");
            const cancelEditBtn = document.querySelector("#editModal button:last-of-type"); // –ò—â–µ–º –∫–Ω–æ–ø–∫—É "–û—Ç–º–µ–Ω–∞"
            const createVisitBtn = document.getElementById("createVisitBtn");

        
            if (saveEditBtn) {
                saveEditBtn.addEventListener("click", saveVisitChanges);
            } else {
                console.error("‚ùå –û—à–∏–±–∫–∞: –ö–Ω–æ–ø–∫–∞ '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!");
            }
        
            if (cancelEditBtn) {
                cancelEditBtn.addEventListener("click", closeEditModal);
            } else {
                console.error("‚ùå –û—à–∏–±–∫–∞: –ö–Ω–æ–ø–∫–∞ '–û—Ç–º–µ–Ω–∞' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞! –ü—Ä–æ–≤–µ—Ä—å ID –∫–Ω–æ–ø–∫–∏ –≤ HTML.");
            }
        
            if (createVisitBtn) {
                createVisitBtn.addEventListener("click", createVisit);
            } else {
                console.error("‚ùå –û—à–∏–±–∫–∞: –ö–Ω–æ–ø–∫–∞ '–°–æ–∑–¥–∞—Ç—å' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!");
            }

            const calendar = new tui.Calendar("#calendar", {
                defaultView: "week",
                useCreationPopup: false,
                useDetailPopup: true,
                useFormPopup: false,
                isReadOnly: false,
                draggable: true,
                resizable: true,
                taskView: true,
                scheduleView: true,
                template: {
                    time: function(schedule) {
                        return schedule.title;
                    },
        
                    // **üî• –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º 24-—á–∞—Å–æ–≤–æ–π —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ —à–∫–∞–ª–µ**
                    timegridDisplayPrimaryTime({ time }) {
                        let hours = time.getHours();
                        let minutes = time.getMinutes();
                        let formattedTime = `${String(hours).padStart(2, "0")}:${String(minutes).padStart(2, "0")}`;
                        return formattedTime; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ 24-—á–∞—Å–æ–≤–æ–π —Ñ–æ—Ä–º–∞—Ç
                    },
        
                    // **–î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤—Ä–µ–º–µ–Ω–∏ (–ø–æ –∂–µ–ª–∞–Ω–∏—é)**
                    timegridNowIndicatorLabel({ time }) {
                        let hours = time.getHours();
                        let minutes = time.getMinutes();
                        return `–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è: ${String(hours).padStart(2, "0")}:${String(minutes).padStart(2, "0")}`;
                    }

                },
                week: { 
                    startDayOfWeek: 1, 
                    hourStart: 0,
                    hourEnd: 24
                },
                day: {
                    hourStart: 0,
                    hourEnd: 24
                },
                month: { 
                    daynames: ["–ü–Ω", "–í—Ç", "–°—Ä", "–ß—Ç", "–ü—Ç", "–°–±", "–í—Å"] 
                }
            });
            

            // **‚úÖ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã –∫–Ω–æ–ø–æ–∫ –∏ –≤—Å–ø–ª—ã–≤–∞—é—â–∏—Ö –æ–∫–æ–Ω**
            calendar.setOptions({
                template: {
                    // üîº **–ö–Ω–æ–ø–∫–∞ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è (–∏–∫–æ–Ω–∫–∞ —Å—Ç—Ä–µ–ª–∫–∏ –≤–≤–µ—Ä—Ö)**
                    collapseBtnTitle() {
                        return `<span>‚Üë</span>`; // HTML-—Ä–∞–∑–º–µ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏
                    },
                },
            });

            calendar.setOptions({
                template: {
                    // ‚úèÔ∏è **–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è**
                    popupEdit() {
                        return 'Edit'; // –¢–µ–∫—Å—Ç –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å"
                    },
                },
            });

            calendar.setOptions({
                template: {
                    // üóëÔ∏è **–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏—è**
                    popupDelete() {
                        return 'Delete'; // –¢–µ–∫—Å—Ç –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–£–¥–∞–ª–∏—Ç—å"
                    },
                },
            });

            calendar.setOptions({
                

                template: {
                    // üìÖ **–§–æ—Ä–º–∞—Ç –¥–∞—Ç—ã –≤ –¥–µ—Ç–∞–ª—è—Ö —Å–æ–±—ã—Ç–∏—è**
                    popupDetailDate({ start, end }) {
                        console.log("üü¢ –î–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è:", schedule);

                        return `${start.toString()} - ${end.toString()}`; // –§–æ—Ä–º–∞—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –∏ –æ–∫–æ–Ω—á–∞–Ω–∏—è
                    },
                },
            });

            calendar.setOptions({
                template: {
                    popupDetailTitle(schedule) {
                        return `<h3>${schedule.title}</h3>`;
                    },
                    popupDetailDate(schedule) {
                        console.log("üü¢ –î–∞–Ω–Ω—ã–µ –≤ popup:", schedule.raw); // ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º `raw`
                        // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ —É—Å–ª—É–≥
                        
                        
                        // üè• –§–∏–ª–∏–∞–ª
                        let branch = schedule.raw.branch && schedule.raw.branch !== "–ù–µ —É–∫–∞–∑–∞–Ω" 
                        ? schedule.raw.branch 
                        : "–ù–µ —É–∫–∞–∑–∞–Ω";
                
                        // üö™ –ö–∞–±–∏–Ω–µ—Ç
                        let room = schedule.raw.room && schedule.raw.room !== "–ù–µ —É–∫–∞–∑–∞–Ω" 
                            ? schedule.raw.room 
                            : "–ù–µ —É–∫–∞–∑–∞–Ω";

                        
                        
                    
                        console.log("üè• –§–∏–ª–∏–∞–ª:", branch);
                        console.log("üö™ –ö–∞–±–∏–Ω–µ—Ç:", room);

 


                        // üìå –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ —É—Å–ª—É–≥
                        // üìå –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ —É—Å–ª—É–≥
                        let serviceList = "–ù–µ —É–∫–∞–∑–∞–Ω—ã";
                        if (Array.isArray(schedule.raw.services)) {
                            serviceList = `<ul style="padding-left: 20px;">` +
                                schedule.raw.services.map(s =>
                                    `<li>[${s.subgroup_number}] ${s.subgroup_name} ‚Üí ${s.service_code} - ${s.service_name} (${s.service_price} –≥—Ä–Ω)</li>`
                                ).join("") +
                                `</ul>`;
                        } else if (typeof schedule.raw.services === "string") {
                            serviceList = schedule.raw.services;
                        }

                        return `
                            <ul style="list-style: none; padding: 0;">
                                <li><strong>–î–∞—Ç–∞ –≤–∏–∑–∏—Ç–∞:</strong> ${formatDate(schedule.start)}</li>
                                <li><strong>–í—Ä–µ–º—è –≤–∏–∑–∏—Ç–∞:</strong> ${formatTime(schedule.start)} - ${formatTime(schedule.end)}</li>
                                <li><strong>–ü–∞—Ü–∏–µ–Ω—Ç:</strong> ${schedule.raw.patient_name || "–ù–µ —É–∫–∞–∑–∞–Ω"}</li>
                                <li><strong>–í—Ä–∞—á:</strong> ${schedule.raw.doctor_name || "–ù–µ —É–∫–∞–∑–∞–Ω"}</li>
                                <li><strong>–ú–µ–¥—Å–µ—Å—Ç—Ä–∞:</strong> ${schedule.raw.nurse_name || "–ù–µ —É–∫–∞–∑–∞–Ω–∞"}</li>
 
                                <li><strong>–£—Å–ª—É–≥–∏:</strong> ${serviceList}</li>
                                <li><strong>–§–∏–ª–∏–∞–ª:</strong> ${branch}</li>
                                <li><strong>–ö–∞–±–∏–Ω–µ—Ç:</strong> ${room}</li>
                                <li><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${schedule.raw.description || "–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è"}</li>
                                <li><strong>–°—Ç–∞—Ç—É—Å:</strong> ${getVisitStatusLabel(schedule.raw.status)}</li>
                                <li><strong>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</strong> ${schedule.raw.total_price || "0"} –≥—Ä–Ω</li>
                                <li><strong>–û–Ω–ª–∞–π–Ω –ø—Ä–∏—ë–º:</strong> ${schedule.raw.is_online ? "–î–∞" : "–ù–µ—Ç"}</li>
                            </ul>
                        `;
                    }
                }
            });
            

            document.getElementById("visitTime").addEventListener("change", updateVisitEndTime);
            document.getElementById("durationSelect").addEventListener("change", updateVisitEndTime);

            function formatDate(date) {
                const d = new Date(date);
                return d.toLocaleDateString("ru-RU", { year: "numeric", month: "long", day: "numeric" });
            }
            
            function formatTime(date) {
                const d = new Date(date);
                return d.toLocaleTimeString("ru-RU", { hour: "2-digit", minute: "2-digit" });
            }
            
            function getVisitStatusLabel(status) {
                const statuses = {
                    "pending": "–í –æ–±—Ä–∞–±–æ—Ç–∫–µ",
                    "paid": "–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞",
                    "completed": "–ü—Ä–æ–≤–µ–¥–µ–Ω–æ",
                    "paid_finish": "–û–ø–ª–∞—á–µ–Ω–æ"
                };
                return statuses[status] || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å";
            }
                
        

            // ‚úÖ –§—É–Ω–∫—Ü–∏—è —Å–º–µ–Ω—ã –≤–∏–¥–∞ (–î–µ–Ω—å / –ù–µ–¥–µ–ª—è / –ú–µ—Å—è—Ü)
            function changeView(view) {
                calendar.changeView(view); // –ú–µ–Ω—è–µ—Ç –≤–∏–¥ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
            }

            // ‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ —Å–º–µ–Ω—ã –≤–∏–¥–∞
            document.querySelector("button[data-view='day']").addEventListener("click", function() {
                changeView("day");
            });
            document.querySelector("button[data-view='week']").addEventListener("click", function() {
                changeView("week");
            });
            document.querySelector("button[data-view='month']").addEventListener("click", function() {
                changeView("month");
            });

            function getCSRFToken() {
                return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            }

            function showError(message) {
                document.getElementById("error-message").innerText = message;
            }

            function loadSelectOptions(url, selectId, formatFunction) {
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        let select = document.getElementById(selectId);
                        if (!select) {
                            console.error(`‚ùå –û—à–∏–±–∫–∞: –≠–ª–µ–º–µ–Ω—Ç —Å ID '${selectId}' –Ω–µ –Ω–∞–π–¥–µ–Ω!`);
                            return;
                        }
                        select.innerHTML = data.map(formatFunction).join("");
                    })
                    .catch(error => console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", error));
            }

            function formatServiceOption(service) {
                return `<option value="${service.id}">
                    [${service.subgroup_number}] ${service.subgroup_name} ‚Üí ${service.service_code} - ${service.service_name} (${service.service_price} –≥—Ä–Ω)
                </option>`;
            }

            function formatUserOption(user) {
                return `<option value="${user.id}">${user.full_name || user.fool_name}</option>`;
            }

            function loadBranches() {
                fetch("/medicalCRM/api/branches/")
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª–∏–∞–ª–æ–≤: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("‚úÖ –§–∏–ª–∏–∞–ª—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã:", data);
                        let branchSelect = document.getElementById("branchSelect");
            
                        branchSelect.innerHTML = data.map(branch => 
                            `<option value="${branch.id}">${branch.branch_name}</option>`
                        ).join("");
            
                        if (data.length > 0) {
                            branchSelect.value = data[0].id; // ‚úÖ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–≤—ã–π —Ñ–∏–ª–∏–∞–ª
                            updateRooms("branchSelect", "roomSelect"); // üî• –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞–±–∏–Ω–µ—Ç—ã —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —Ñ–∏–ª–∏–∞–ª–∞
                        }
                    })
                    .catch(error => console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª–∏–∞–ª–æ–≤:", error));
            }
            
            
            document.getElementById("branchSelect").addEventListener("change", function () {
                updateRooms("editBranchSelect", "editRoomSelect");
            });
            
            function updateRooms(branchSelectId, roomSelectId) {
                let branchElement = document.getElementById(branchSelectId);
                let roomElement = document.getElementById(roomSelectId);
            
                if (!branchElement || !roomElement) {
                    console.error(`‚ùå –û—à–∏–±–∫–∞: –≠–ª–µ–º–µ–Ω—Ç—ã —Å ID '${branchSelectId}' –∏–ª–∏ '${roomSelectId}' –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!`);
                    return;
                }
            
                let branchId = branchElement.value;
            
                if (!branchId || isNaN(branchId)) {
                    console.warn("‚ö†Ô∏è –§–∏–ª–∏–∞–ª –Ω–µ –≤—ã–±—Ä–∞–Ω, –∫–∞–±–∏–Ω–µ—Ç—ã –Ω–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è.");
                    return;
                }           
            
                fetch(`/medicalCRM/api/rooms/?branch=${branchId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        roomElement.innerHTML = "";
            
                        if (data.length > 0) {
                            data.forEach(room => {
                                let option = document.createElement("option");
                                option.value = room.id;
                                option.textContent = room.room_number;
                                roomElement.appendChild(option);
                            });
            
                            roomElement.value = data[0].id; // ‚úÖ –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç
                        } else {
                            let option = document.createElement("option");
                            option.textContent = "–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–∞–±–∏–Ω–µ—Ç–æ–≤";
                            option.value = "";
                            roomElement.appendChild(option);
                        }
            
                        console.log(`‚úÖ –ö–∞–±–∏–Ω–µ—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –¥–ª—è —Ñ–∏–ª–∏–∞–ª–∞ ${branchId}:`, data);
                    })
                    .catch(error => console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–±–∏–Ω–µ—Ç–æ–≤:", error));
            }
            
            
            
            

            function loadVisits() {
                fetch("/api/visits/")
                    .then(response => response.json())
                    .then(data => {
                        console.log("üì• –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –≤–∏–∑–∏—Ç—ã:", data);  // –ü—Ä–æ–≤–µ—Ä—è–µ–º API
                        console.log("üî• API –æ—Ç–≤–µ—Ç:", data);
                        // üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞–∫–∏–µ —É—Å–ª—É–≥–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                        data.forEach(v => {
                            console.log(`üõ† –í–∏–∑–∏—Ç ID ${v.id}: —É—Å–ª—É–≥–∏ -`, v.services);
                        });
                        let schedules = data.map(v => ({
                            id: v.id.toString(),
                            title: `${v.patient_name} - ${v.doctor_name || "?"}`,
                            category: "time",
                            start: v.visit_date + "T" + v.visit_time,
                            end: v.visit_date + "T" + (v.visit_end_time || v.visit_time),
                            bgColor: "#36A2EB",
                            state: "Free",  // üü¢ –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç—É—Å "Busy"
                            raw: { // üî• –î–æ–±–∞–≤–ª—è–µ–º `raw`, —á—Ç–æ–±—ã –¥–∞–Ω–Ω—ã–µ –Ω–µ —Ç–µ—Ä—è–ª–∏—Å—å
                                patient_name: v.patient_name,
                                doctor_name: v.doctor_name,
                                nurse_name: v.nurse_name,
                                services: v.services, // ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ
                                branch: v.clinic_branch_name || "–ù–µ —É–∫–∞–∑–∞–Ω",  // ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
                                room: v.clinic_room_number || "–ù–µ —É–∫–∞–∑–∞–Ω",  // ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ      
                                description: v.description,
                                total_price: v.total_price,
                                is_online: v.is_online,
                                status: v.payment_status
                            }
                        }));
                        console.log("üìÖ –°–æ–±—ã—Ç–∏—è –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è:", schedules);  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–±—ã—Ç–∏—è –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º
                        calendar.clear();
                        calendar.createEvents(schedules);
                    })
                    .catch(error => console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ API:", error));
            }
            // ‚úÖ –ö–Ω–æ–ø–∫–∏ –¥–ª—è —Å–º–µ–Ω—ã –ø–µ—Ä–∏–æ–¥–∞ (–ù–∞–∑–∞–¥ / –í–ø–µ—Ä–µ–¥)
            document.querySelector("button[data-nav='prev']").addEventListener("click", function() {
                calendar.prev();
            });
            document.querySelector("button[data-nav='next']").addEventListener("click", function() {
                calendar.next();
            });

            // ‚úÖ –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π
            document.querySelector("button[data-action='reload']").addEventListener("click", function() {
                loadVisits();
            });

            function openModal() {
                document.getElementById("modal").classList.add("active");
                loadSelectOptions("/api/doctors/", "doctorSelect", formatUserOption);
                loadSelectOptions("/api/patients/", "patientSelect", formatUserOption);
                loadSelectOptions("/api/nurses/", "nurseSelect", formatUserOption);
                
                loadBranches();
                loadServices();  // üî• –ó–∞–≥—Ä—É–∂–∞–µ–º —É—Å–ª—É–≥–∏!
            }

            document.getElementById("durationSelect").addEventListener("change", function() {
                let endTimeInput = document.getElementById("visitEndTime");
            
                if (this.value === "custom") {
                    endTimeInput.removeAttribute("disabled"); // ‚úÖ –†–∞–∑—Ä–µ—à–∞–µ–º –≤–≤–æ–¥ –≤—Ä—É—á–Ω—É—é
                } else {
                    endTimeInput.setAttribute("disabled", "true"); // ‚ùå –ë–ª–æ–∫–∏—Ä—É–µ–º –≤–≤–æ–¥
                    let visitTimeInput = document.getElementById("visitTime").value;
                    if (!visitTimeInput) {
                        alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –ø—Ä–∏—ë–º–∞!");
                        this.value = "custom"; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫ "–ë–æ–ª–µ–µ..."
                        return;
                    }
            
                    let [hours, minutes] = visitTimeInput.split(":").map(Number);
                    let durationMinutes = parseInt(this.value);
                    let endMinutes = minutes + durationMinutes;
            
                    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –≤—Ä–µ–º—è
                    if (endMinutes >= 60) {
                        hours += Math.floor(endMinutes / 60);
                        endMinutes = endMinutes % 60;
                    }
            
                    endTimeInput.value = `${String(hours).padStart(2, "0")}:${String(endMinutes).padStart(2, "0")}`;
                }
            });

            
            
            // ‚úÖ –ü–æ–∑–≤–æ–ª—è–µ–º –≤—Ä—É—á–Ω—É—é –∑–∞–¥–∞–≤–∞—Ç—å –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
            document.getElementById("visitEndTime").addEventListener("change", function () {
                let visitTimeInput = document.getElementById("visitTime").value;
                let visitEndTimeInput = this.value;
            
                if (!visitTimeInput || !visitEndTimeInput) return;
            
                let [startHours, startMinutes] = visitTimeInput.split(":").map(Number);
                let [endHours, endMinutes] = visitEndTimeInput.split(":").map(Number);
            
                let totalMinutes = (endHours * 60 + endMinutes) - (startHours * 60 + startMinutes);

                // ‚ùå –ù–æ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º alert —Å—Ä–∞–∑—É! –ü—Ä–æ–≤–µ—Ä–∏–º —ç—Ç–æ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Ñ–æ—Ä–º—ã
                if (totalMinutes <= 0) {
                    this.dataset.invalid = "true"; // –ü–æ–º–µ—á–∞–µ–º, —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ
                } else {
                    delete this.dataset.invalid; // –ï—Å–ª–∏ –≤—Å—ë –æ–∫, —É–¥–∞–ª—è–µ–º –∞—Ç—Ä–∏–±—É—Ç
                }
            
                document.getElementById("durationSelect").value = "custom"; // –ï—Å–ª–∏ –≤—Ä—É—á–Ω—É—é –≤–≤–æ–¥–∏–º, —Å—Ç–∞–≤–∏–º "–ë–æ–ª–µ–µ..."
            });
            
            // ‚úÖ –ü–æ–∑–≤–æ–ª—è–µ–º —Ä–∞—Å—Ç—è–≥–∏–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ –∏ –æ–±–Ω–æ–≤–ª—è—Ç—å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
            calendar.on("beforeUpdateEvent", function ({ event, changes }) {
                console.log("üõ† –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è:", event, changes);
            
                let visitId = event.id;
                if (!visitId) {
                    console.error("‚ùå –û—à–∏–±–∫–∞: ID –≤–∏–∑–∏—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω!");
                    return;
                }
            
                let updatedData = {};
            
                if (changes.start) {
                    let newStart = new Date(changes.start);
                    updatedData.visit_date = newStart.toISOString().split("T")[0];
                    updatedData.visit_time = formatTime(newStart);
                }
            
                if (changes.end) {
                    let newEnd = new Date(changes.end);
                    updatedData.visit_end_time = formatTime(newEnd);
                    let durationMinutes = Math.round((newEnd - new Date(event.start)) / (1000 * 60));
                    updatedData.duration_minutes = durationMinutes > 0 ? durationMinutes : 10; // –ú–∏–Ω–∏–º—É–º 10 –º–∏–Ω—É—Ç
                }
            
                if (Object.keys(updatedData).length === 0) {
                    console.warn("‚ö†Ô∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π, –æ—Ç–∫—Ä—ã–≤–∞—é –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è...");
                    openEditModal(visitId);  // üî• –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤–º–µ—Å—Ç–æ –æ—à–∏–±–∫–∏
                    return;
                }
            
                console.log("üì§ –ì–æ—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏:", updatedData);
                updateVisitOnServer(visitId, updatedData);
            });
            
            
            
            
            // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –≤ HH:mm
            function formatTime(dateInput) {
                let dateObj = new Date(dateInput);
                let hours = String(dateObj.getHours()).padStart(2, "0");
                let minutes = String(dateObj.getMinutes()).padStart(2, "0");
                return `${hours}:${minutes}`;
            }
            
            
            function createVisit() {
                let visitTimeInput = document.getElementById("visitTime");
                let visitEndTimeInput = document.getElementById("visitEndTime");
                let selectedDuration = document.getElementById("durationSelect").value;
                let selectedServiceIdsStr = document.getElementById("selectedServiceIds").value || "";
                let selectedServices = selectedServiceIdsStr
                    .split(",")
                    .filter(id => id)
                    .map(id => parseInt(id));


                let requiredFields = [
                    { id: "patientSelect", message: "–í—ã–±–µ—Ä–∏—Ç–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞" },
                    { id: "doctorSelect", message: "–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–∞—á–∞" },
                    { id: "visitDate", message: "–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –≤–∏–∑–∏—Ç–∞" },
                    { id: "visitTime", message: "–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –≤–∏–∑–∏—Ç–∞" }
                ];
            
                document.querySelectorAll(".error-input").forEach(field => {
                    field.classList.remove("error-input");
                });
            
                let missingFields = [];
            
                requiredFields.forEach(field => {
                    let inputElement = document.getElementById(field.id);
                    if (!inputElement.value) {
                        inputElement.classList.add("error-input");
                        missingFields.push(field.message);
                    }
                });
            
                if (missingFields.length > 0) {
                    alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è:\n- " + missingFields.join("\n- "));
                    return;
                }
            
                let [startHours, startMinutes] = visitTimeInput.value.split(":").map(Number);
                let visit_end_time = visitEndTimeInput.value || "";
                let duration_minutes = null;
            
                if (selectedDuration !== "custom") {
                    let duration = parseInt(selectedDuration);
                    let endMinutes = startMinutes + duration;
            
                    if (endMinutes >= 60) {
                        startHours += Math.floor(endMinutes / 60);
                        endMinutes = endMinutes % 60;
                    }
            
                    visit_end_time = `${String(startHours).padStart(2, "0")}:${String(endMinutes).padStart(2, "0")}`;
                    duration_minutes = duration;
                }
            
                if (selectedDuration === "custom" && visitEndTimeInput.value) {
                    let [endHours, endMinutes] = visitEndTimeInput.value.split(":").map(Number);
                    let startTimeInMinutes = startHours * 60 + startMinutes;
                    let endTimeInMinutes = endHours * 60 + endMinutes;
            
                    if (endTimeInMinutes <= startTimeInMinutes) {
                        alert("–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–∑–∂–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞—á–∞–ª–∞!");
                        visitEndTimeInput.classList.add("error-input");
                        return;
                    }
            
                    duration_minutes = endTimeInMinutes - startTimeInMinutes;
                }
            

            
                let visitData = {
                    patient: document.getElementById("patientSelect").value,
                    doctor: document.getElementById("doctorSelect").value || null,
                    nurse: document.getElementById("nurseSelect").value || null,
                    visit_date: document.getElementById("visitDate").value,
                    visit_time: visitTimeInput.value,
                    visit_end_time: visit_end_time,
                    duration_minutes: duration_minutes ?? null,
                    services_ids: selectedServices.length > 0 ? selectedServices : [],  // ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ
                    total_price: parseFloat(document.getElementById("finalPrice").value) || 0.00,
                    payment_status: document.getElementById("statusSelect").value,
                    is_online: document.getElementById("isOnline").checked,
                    description: document.getElementById("description").value,
                    clinic_branch: document.getElementById("branchSelect").value,
                    clinic_room: document.getElementById("roomSelect").value,
                    discount_percent: parseFloat(document.getElementById("discountPercent").value) || 0,
                    discounted_services_ids: Array.from(document.getElementById("discountedServicesSelect").selectedOptions)
                    .map(opt => parseInt(opt.value)),
                    
                
                };

                console.log("üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ:", JSON.stringify(visitData, null, 2));
                
            
                fetch("/api/visits/", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "X-CSRFToken": getCSRFToken() },
                    body: JSON.stringify(visitData)
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errData => {
                            console.error("‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:", errData);
                            alert("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–∑–∏—Ç–∞: " + JSON.stringify(errData));
                            throw new Error("Bad Request");
                        });
                    }
                    return response.json();
                })
                .then(() => {
                    closeModal();
                    loadVisits();
                })
                .catch(error => console.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–∑–∏—Ç–∞!", error));
            }

            // ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ —Å–æ–±—ã—Ç–∏–π


            // ‚úÖ –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ API
            function updateVisitOnServer(visitId, updatedData) {
                if (!visitId) {
                    console.error("‚ùå –û—à–∏–±–∫–∞: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç visitId!");
                    return;
                }
            
                updatedData.visit_time = ensureSeconds(updatedData.visit_time);
                updatedData.visit_end_time = ensureSeconds(updatedData.visit_end_time);
            
                console.log("üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä:", updatedData);
            
                fetch(`/api/visits/${visitId}/`, {
                    method: "PATCH",
                    headers: { "Content-Type": "application/json", "X-CSRFToken": getCSRFToken() },
                    body: JSON.stringify(updatedData)
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            console.error("‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:", err);
                            throw new Error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è!");
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("‚úÖ –í–∏–∑–∏—Ç —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!", data);
                    loadVisits();
                })
                .catch(error => console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –≤–∏–∑–∏—Ç–∞!", error));
            }
            
            
            
            

            // ‚úÖ –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ –≤ HH:mm
            function formatTime(dateObj) {
                let hours = String(dateObj.getHours()).padStart(2, "0");
                let minutes = String(dateObj.getMinutes()).padStart(2, "0");
                return `${hours}:${minutes}`;
            }

            
            
            
            document.getElementById("createVisitBtn").addEventListener("click", createVisit);

            // ‚úÖ –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Å—É–º–º—ã
            document.getElementById("discountPercent").addEventListener("input", recalculateTotalPrice);
            document.getElementById("discountedServicesSelect").addEventListener("change", recalculateTotalPrice);

            calendar.on("selectDateTime", function () {
                openModal();
            });

            loadVisits();


            calendar.on("selectSchedule", function(event) {
                if (!event || !event.schedule || !event.schedule.id) {
                    console.error("‚ùå –û—à–∏–±–∫–∞: ID –≤–∏–∑–∏—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω!");
                    return;
                }
            
                let visitId = event.schedule.id;
                console.log("üìå –û—Ç–∫—Ä—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∏–∑–∏—Ç–µ ID:", visitId);
            
                fetch(`/api/visits/${visitId}/`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–∑–∏—Ç–∞: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("‚úÖ –î–∞–Ω–Ω—ã–µ –≤–∏–∑–∏—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:", data);
                        let visitDetails = `
                            <p><strong>–ü–∞—Ü–∏–µ–Ω—Ç:</strong> ${data.patient_name}</p>
                            <p><strong>–í—Ä–∞—á:</strong> ${data.doctor_name || "–ù–µ —É–∫–∞–∑–∞–Ω"}</p>
                            <p><strong>–î–∞—Ç–∞:</strong> ${data.visit_date}</p>
                            <p><strong>–í—Ä–µ–º—è:</strong> ${data.visit_time} - ${data.visit_end_time}</p>
                            <p><strong>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> ${data.duration_minutes} –º–∏–Ω</p>
                            <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${getVisitStatusLabel(data.payment_status)}</p>
                            <ul id="visitServices"></ul>
                        `;

                        document.getElementById("visitDetails").innerHTML = visitDetails;

                        let serviceList = document.getElementById("visitServices");
                        serviceList.innerHTML = "";  // –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π

                        if (data.services && Array.isArray(data.services)) {
                            data.services.forEach(service => {
                                let li = document.createElement("li");
                                li.textContent = `[${service.subgroup_number}] ${service.subgroup_name} ‚Üí ${service.service_code} - ${service.service_name} (${service.service_price} –≥—Ä–Ω)`;
                                serviceList.appendChild(li);
                            });
                        } else {
                            serviceList.innerHTML = "<li>–ù–µ—Ç —É—Å–ª—É–≥</li>";
                        }
            
                        document.getElementById("visitDetails").innerHTML = visitDetails;
            
                        // –ù–∞–∑–Ω–∞—á–∞–µ–º ID –≤–∏–∑–∏—Ç–∞ –∫–Ω–æ–ø–∫–∞–º
                        document.getElementById("editVisitBtn").onclick = function () {
                            openEditModal(visitId);
                        };
            
                        document.getElementById("deleteVisitBtn").onclick = function () {
                            deleteVisit(visitId);
                        };
            
                        document.getElementById("visitInfoModal").classList.add("active");
                    })
                    .catch(error => console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤–∏–∑–∏—Ç–∞:", error));
            });
            
            function closeVisitInfoModal() {
                document.getElementById("visitInfoModal").classList.remove("active");
            }
            

            function deleteVisit(visitId) {
                if (!confirm("‚ùå –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –≤–∏–∑–∏—Ç?")) return;
            
                fetch(`/api/visits/${visitId}/`, {
                    method: "DELETE",
                    headers: { "X-CSRFToken": getCSRFToken() }
                })
                .then(response => {
                    if (response.status === 204) {
                        console.log(`‚úÖ –í–∏–∑–∏—Ç ${visitId} —É–¥–∞–ª–µ–Ω.`);
                        closeVisitInfoModal();
                        loadVisits(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≤–∏–∑–∏—Ç–æ–≤
                    } else {
                        throw new Error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤–∏–∑–∏—Ç–∞!");
                    }
                })
                .catch(error => console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏!", error));
            }
            
            

            

            calendar.on("selectSchedule", function(event) {
                console.log("üõ† –û—Ç–∫—Ä—ã—Ç–∏–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∏–∑–∏—Ç–∞...", event);
            
                if (!event || !event.schedule || !event.schedule.id) {
                    console.error("‚ùå –û—à–∏–±–∫–∞: ID –≤–∏–∑–∏—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω!");
                    return;
                }
            
                let visitId = event.schedule.id;
                console.log("üìå –ü–µ—Ä–µ–¥–∞–Ω–Ω—ã–π ID:", visitId);
            
                openEditModal(visitId);
            });
            

            calendar.on("beforeShowEventPopup", function(event) {
                console.log("üîç –í—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ —Å–æ–±—ã—Ç–∏—è –æ—Ç–∫—Ä—ã—Ç–æ", event);
            
                setTimeout(() => {
                    let editButton = document.querySelector(".toastui-calendar-popup-edit");
                    if (editButton) {
                        console.log("‚úÖ –ö–Ω–æ–ø–∫–∞ '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å' –Ω–∞–π–¥–µ–Ω–∞!");
            
                        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –µ—Å–ª–∏ –æ–Ω –±—ã–ª
                        editButton.onclick = null;
            
                        editButton.onclick = function() {
                            if (!event || !event.event || !event.event.id) {
                                console.error("‚ùå –û—à–∏–±–∫–∞: –Ω–µ—Ç ID —Å–æ–±—ã—Ç–∏—è!");
                                return;
                            }
            
                            let visitId = event.event.id;
                            console.log("‚úèÔ∏è –ù–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –≤–∏–∑–∏—Ç–∞ ID:", visitId);
                            openEditModal(visitId);
                        };
                    } else {
                        console.error("‚ùå –ö–Ω–æ–ø–∫–∞ '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å' –ù–ï –Ω–∞–π–¥–µ–Ω–∞!");
                    }
                }, 300); // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏
            });
            
            
            function openEditModal(visitId) {
                console.log(`üì¢ –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –≤–∏–∑–∏—Ç–∞ ID: ${visitId}`);
                loadEditServices(visitId);
                

                fetch(`/api/visits/${visitId}/`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–∑–∏—Ç–∞: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("‚úÖ –î–∞–Ω–Ω—ã–µ –≤–∏–∑–∏—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:", data);
            
                        let patientSelect = document.getElementById("editPatientSelect");
                        let doctorSelect = document.getElementById("editDoctorSelect");
                        let nurseSelect = document.getElementById("editNurseSelect");
                        let branchSelect = document.getElementById("editBranchSelect");
                        let roomSelect = document.getElementById("editRoomSelect");
                        let servicesSelect = document.getElementById("editServicesSelect");
                        let discountedIds = (data.discounted_services || []).map(id => parseInt(id));
                        let discountSelect = document.getElementById("editDiscountedServicesSelect");


                        Array.from(discountSelect.options).forEach(option => {
                            option.selected = discountedIds.includes(parseInt(option.value));
                        });
            
                        if (!patientSelect || !doctorSelect || !nurseSelect || !branchSelect || !roomSelect ) {
                            console.error("‚ùå –û—à–∏–±–∫–∞: –æ–¥–∏–Ω –∏–∑ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Ñ–æ—Ä–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω!");
                            return;
                        }
            
                        // ‚úÖ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –ø–æ–ª—è
                        document.getElementById("editPatientSelect").value = data.patient || "";
                        document.getElementById("editDoctorSelect").value = data.doctor || "";
                        document.getElementById("editNurseSelect").value = data.nurse || "";
                        document.getElementById("editVisitDate").value = data.visit_date || "";
                        document.getElementById("editVisitTime").value = data.visit_time || "";
                        document.getElementById("editVisitEndTime").value = data.visit_end_time || "";
                        document.getElementById("editDescription").value = data.description || "";
                        document.getElementById("editStatusSelect").value = data.payment_status || "";
                        document.getElementById("editTotalPrice").value = data.total_price || 0;
                        document.getElementById("editIsOnline").checked = data.is_online || false;
                        document.getElementById("editDiscountPercent").value = data.discount_percent || 0;
                        

                        // ‚úÖ üìå **–û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —É—Å–ª—É–≥**
                        let selectedList = document.getElementById("editSelectedServices");
                        selectedList.innerHTML = "";  // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º

                        if (data.services && Array.isArray(data.services)) {
                            data.services.forEach(service => {
                                let li = document.createElement("li");
                                li.textContent = `[${service.subgroup_number}] ${service.subgroup_name} ‚Üí ${service.service_code} - ${service.service_name} (${service.service_price} –≥—Ä–Ω)`;
                                li.dataset.id = service.id;
                                li.onclick = function () {
                                    selectEditService(this);
                                };
                                selectedList.appendChild(li); // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫
                            });
                        } else {
                            console.warn("‚ö†Ô∏è –ù–µ—Ç —É—Å–ª—É–≥ –¥–ª—è —ç—Ç–æ–≥–æ –≤–∏–∑–∏—Ç–∞!");
                        }

                        // ‚úÖ –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ ID –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —É—Å–ª—É–≥ (–ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —á–∏—Å–ª–∞)
                        let selectedServiceIds = (data.services || []).map(s => parseInt(s.id));
                        // ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Ñ–∏–ª–∏–∞–ª–∞ –∏ –∫–∞–±–∏–Ω–µ—Ç–∞ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
                        let currentBranchId = data.clinic_branch;
                        let currentRoomId = data.clinic_room;
            
                        // üìå –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∏–ª–∏–∞–ª—ã, –∫–∞–±–∏–Ω–µ—Ç—ã –∏ —É—Å–ª—É–≥–∏
                        Promise.all([
                            fetch("/medicalCRM/api/branches/").then(response => response.json()),
                            fetch(`/medicalCRM/api/rooms/?branch=${data.clinic_branch || ''}`).then(response => response.json()),
                            fetch("/api/services/").then(response => response.json())
                        ])
                        .then(([branches, rooms, services]) => {
                            console.log("‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:", branches, rooms, services);
                            
                            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∏–ª–∏–∞–ª–æ–≤
                            let branchSelect = document.getElementById("editBranchSelect");
                            branchSelect.innerHTML = branches.map(branch =>
                                `<option value="${branch.id}" ${branch.branch_name === data.clinic_branch_name ? "selected" : ""}>
                                    ${branch.branch_name}
                                </option>`
                            ).join("");
                        
    

                            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞–±–∏–Ω–µ—Ç–æ–≤ (–∏—Å—Ö–æ–¥—è –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ–∏–ª–∏–∞–ª–∞)
                            let roomSelect = document.getElementById("editRoomSelect");
                            roomSelect.innerHTML = rooms.map(room =>
                                `<option value="${room.id}" ${room.room_number === data.clinic_room_number ? "selected" : ""}>
                                    –ö–∞–±–∏–Ω–µ—Ç ${room.room_number}
                                </option>`
                            ).join("");

                            // ‚úÖ –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞–±–∏–Ω–µ—Ç—ã –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —Ñ–∏–ª–∏–∞–ª–∞
                            updateRooms("editBranchSelect", "editRoomSelect", data.clinic_room);
            
                            // ‚úÖ –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ —É—Å–ª—É–≥ –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π –Ω–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
                        
            

                        })
                        .catch(error => console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª–∏–∞–ª–æ–≤, –∫–∞–±–∏–Ω–µ—Ç–æ–≤ –∏–ª–∏ —É—Å–ª—É–≥:", error));
            
                        // ‚úÖ –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Ä–∞—á–µ–π, –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤ –∏ –º–µ–¥—Å–µ—Å—Ç–µ—Ä
                        loadSelectOptions("/api/doctors/", "editDoctorSelect", formatUserOption);
                        loadSelectOptions("/api/patients/", "editPatientSelect", formatUserOption);
                        loadSelectOptions("/api/nurses/", "editNurseSelect", formatUserOption);

                        updateEditSelectedServices();  // —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏–ª—Å—è hidden input
                        recalculateEditTotalPrice();   // –ø–µ—Ä–µ—Å—á—ë—Ç —Å—É–º–º—ã
            
                        // ‚úÖ –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                        document.getElementById("editModal").dataset.visitId = visitId;
                        document.getElementById("editModal").classList.add("active");
                    })
                    .catch(error => console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤–∏–∑–∏—Ç–∞:", error));
            }
            
            
            
            function formatBranchOption(branch) {
                return `<option value="${branch.id}">${branch.branch_name}</option>`;
            }
            function formatRoomOption(room) {
                return `<option value="${room.id}">${room.room_number}</option>`;
            }

            
            function closeEditModal() {
                let modal = document.getElementById("editModal");
                if (modal) {
                    modal.classList.remove("active");
                    modal.dataset.visitId = "";

                    // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
                    document.getElementById("editPatientSelect").value = "";
                    document.getElementById("editDoctorSelect").value = "";
                    document.getElementById("editNurseSelect").value = "";
                    document.getElementById("editVisitDate").value = "";
                    document.getElementById("editVisitTime").value = "";
                    document.getElementById("editVisitEndTime").value = "";
                    document.getElementById("editDescription").value = "";
                    document.getElementById("editStatusSelect").value = "pending";
                    document.getElementById("editBranchSelect").value = "";
                    document.getElementById("editRoomSelect").value = "";

                    console.log("üì¢ –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è");
                } else {
                    console.error("‚ùå –û—à–∏–±–∫–∞: –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!");
                }
            }


            
            
            document.getElementById("saveEditBtn").addEventListener("click", function () {
                let visitId = document.getElementById("editModal").dataset.visitId;
                if (!visitId) {
                    console.error("‚ùå –û—à–∏–±–∫–∞: –Ω–µ—Ç ID –≤–∏–∑–∏—Ç–∞!");
                    return;
                }
            
                let updatedData = {
                    patient: document.getElementById("editPatientSelect").value,
                    doctor: document.getElementById("editDoctorSelect").value || null,
                    nurse: document.getElementById("editNurseSelect").value || null,
                    visit_date: document.getElementById("editVisitDate").value,
                    visit_time: document.getElementById("editVisitTime").value,
                    visit_end_time: document.getElementById("editVisitEndTime").value || null,
                    description: document.getElementById("editDescription").value,
                    payment_status: document.getElementById("editStatusSelect").value,
                    clinic_branch: document.getElementById("editBranchSelect").value,
                    clinic_room: document.getElementById("editRoomSelect").value,
                    is_online: document.getElementById("editIsOnline").checked, // ‚úÖ –ì–∞–ª–æ—á–∫–∞ –æ–Ω–ª–∞–π–Ω-–ø—Ä–∏—ë–º–∞
                    total_price: parseFloat(document.getElementById("editTotalPrice").value) || 0.00, // ‚úÖ –¥–æ–±–∞–≤–ª–µ–Ω–æ
                    discount_percent: parseFloat(document.getElementById("editDiscountPercent").value) || 0,
                    discounted_services: Array.from(document.getElementById("editDiscountedServicesSelect").selectedOptions).map(opt => parseInt(opt.value)),
                
                };
            
                console.log("üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π:", updatedData); // –õ–æ–≥–∏—Ä—É–µ–º, —á—Ç–æ –ø–µ—Ä–µ–¥–∞–µ–º
            
                fetch(`/api/visits/${visitId}/`, {
                    method: "PATCH",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCSRFToken()
                    },
                    body: JSON.stringify(updatedData)
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            console.error("‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:", err);
                            throw new Error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è!");
                        });
                    }
                    return response.json();
                })
                .then(() => {
                    console.log("‚úÖ –í–∏–∑–∏—Ç —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!");
                    closeEditModal();
                    loadVisits(); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å
                })
                .catch(error => console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏!", error));
            });
            document.getElementById("cancelEditBtn").addEventListener("click", function () {
                closeEditModal();
            });

            
            

                        
            function formatTimeToSeconds(time) {
                if (time && time.length === 5) { 
                    return time + ":00";  // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–∫—É–Ω–¥—ã, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
                }
                return time;
            }
            
            function saveVisitChanges() {
                let visitId = document.getElementById("editModal").dataset.visitId;
            
                if (!visitId) {
                    console.error("‚ùå –û—à–∏–±–∫–∞: –Ω–µ—Ç ID –≤–∏–∑–∏—Ç–∞!");
                    return;
                }
            
                // üìå –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ª—å–∫–æ ID –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —É—Å–ª—É–≥
                let selectedServiceIdsStr = document.getElementById("editSelectedServiceIds").value || "";
                let selectedServices = selectedServiceIdsStr
                    .split(",")
                    .filter(id => id)
                    .map(id => parseInt(id));
            
                let updatedData = {
                    patient: document.getElementById("editPatientSelect").value,
                    doctor: document.getElementById("editDoctorSelect").value || null,
                    nurse: document.getElementById("editNurseSelect").value || null,
                    visit_date: document.getElementById("editVisitDate").value,
                    visit_time: ensureSeconds(document.getElementById("editVisitTime").value),
                    visit_end_time: ensureSeconds(document.getElementById("editVisitEndTime").value),
                    description: document.getElementById("editDescription").value,
                    payment_status: document.getElementById("editStatusSelect").value,
                    clinic_branch: parseInt(document.getElementById("editBranchSelect").value) || null, // ‚úÖ –ü–µ—Ä–µ–¥–∞–µ–º ID, –∞ –Ω–µ —Å—Ç—Ä–æ–∫—É
                    clinic_room: parseInt(document.getElementById("editRoomSelect").value) || null,   // ‚úÖ –ü–µ—Ä–µ–¥–∞–µ–º ID, –∞ –Ω–µ —Å—Ç—Ä–æ–∫—É
                    services_ids: selectedServices.length > 0 ? selectedServices : [], // ‚úÖ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∫–ª—é—á
                    is_online: document.getElementById("editIsOnline").checked, // ‚úÖ –ì–∞–ª–æ—á–∫–∞ –æ–Ω–ª–∞–π–Ω-–ø—Ä–∏—ë–º–∞
                    total_price: parseFloat(document.getElementById("editTotalPrice").value) || 0.00, // ‚úÖ –¥–æ–±–∞–≤–ª–µ–Ω–æ
                };
            
                console.log("üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π:", updatedData);
            
                fetch(`/api/visits/${visitId}/`, {
                    method: "PUT",
                    headers: { 
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCSRFToken() 
                    },
                    body: JSON.stringify(updatedData)
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => {
                            console.error("‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:", err);
                            alert("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∏–∑–∏—Ç–∞: " + JSON.stringify(err));
                            throw new Error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è!");
                        });
                    }
                    return response.json();
                })
                .then((updatedVisit) => {
                    console.log("‚úÖ –í–∏–∑–∏—Ç —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!", updatedVisit);
            
                    closeEditModal();
                    loadVisits(); // üî• –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–Ω–æ–≤–æ –≤–∏–∑–∏—Ç—ã
            
                    // üî• –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä —É—Å–ª—É–≥ –≤ UI
                
                })
                .catch(error => console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –≤–∏–∑–∏—Ç–∞!", error));
            }
            
            
            
     
            
            
            
        });
    </script>
</body>
</html>